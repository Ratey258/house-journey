var e=Object.defineProperty,t=(t,i,r)=>(((t,i,r)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[i]=r})(t,"symbol"!=typeof i?i+"":i,r),r);import{c as i,d as r,a as o}from"./vendor-3ea32499.js";import{r as s}from"./ui-a9bb16a6.js";const a={},n=function(e,t,i){if(!t||0===t.length)return e();const r=document.getElementsByTagName("link");return Promise.all(t.map(e=>{if(e=function(e,t){return new URL(e,t).href}(e,i),e in a)return;a[e]=!0;const t=e.endsWith(".css"),o=t?'[rel="stylesheet"]':"";if(!!i)for(let i=r.length-1;i>=0;i--){const o=r[i];if(o.href===e&&(!t||"stylesheet"===o.rel))return}else if(document.querySelector(`link[href="${e}"]${o}`))return;const s=document.createElement("link");return s.rel=t?"stylesheet":"modulepreload",t||(s.as="script",s.crossOrigin=""),s.href=e,document.head.appendChild(s),t?new Promise((t,i)=>{s.addEventListener("load",t),s.addEventListener("error",()=>i(new Error(`Unable to preload CSS for ${e}`)))}):void 0})).then(()=>e()).catch(e=>{const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e})},c={VALIDATION:"validation",NETWORK:"network",STORAGE:"storage",GAME_LOGIC:"gameLogic",SYSTEM:"system",UNKNOWN:"unknown"},l={FATAL:"fatal",ERROR:"error",WARNING:"warning",INFO:"info"};function u(e,t={}){return function(e,t=c.UNKNOWN,i=l.ERROR,r={}){const o=new Error(e);return o.type=t,o.severity=i,o.metadata=r,o.timestamp=(new Date).toISOString(),o}(e,c.STORAGE,l.ERROR,t)}const d={common:{confirm:"确认",cancel:"取消",back:"返回",save:"保存",delete:"删除",loading:"加载中...",yes:"是",no:"否",ok:"确定",next:"下一步",previous:"上一步",close:"关闭",edit:"编辑",create:"创建",update:"更新",remove:"移除",search:"搜索",filter:"筛选",sort:"排序",refresh:"刷新",retry:"重试",more:"更多"},time:{week:"第{week}周",weeks:"{count}周",of:"/",remaining:"剩余: {weeks}周",day:"天",hour:"小时",minute:"分钟",second:"秒"},system:{defaultPlayerName:"玩家",autoSave:"自动存档",unknownError:"发生未知错误",criticalError:"发生严重错误",componentError:"组件错误",retry:"重试",errorLogs:"错误日志",exportLogs:"导出日志",clearLogs:"清空日志",severity:"严重程度",type:"类型",search:"搜索"},currency:"元",settings:{title:"游戏设置",game:"游戏设置",display:"显示设置",audio:"音频设置",language:"语言",difficulty:"游戏难度",difficulties:{easy:"简单",standard:"标准",hard:"困难"},autoSaveInterval:"自动保存间隔",autoSaveIntervals:{1:"每周",2:"每2周",5:"每5周",10:"每10周"},soundEnabled:"游戏音效",fullScreen:"全屏模式",textSpeed:"文本速度",textSpeeds:{slow:"慢速",normal:"正常",fast:"快速"},reset:"恢复默认设置",saveSuccess:"设置已保存",resetSuccess:"设置已重置",description:{difficulty:"调整游戏的整体难度，影响价格波动、事件触发概率等",autoSave:"设置游戏自动保存的频率",sound:"启用或禁用游戏音效",fullScreen:"以全屏模式运行游戏",textSpeed:"调整对话和提示文本的显示速度",language:"选择游戏界面语言"}},game:{title:"买房记",week:"周数",menu:"菜单",nextWeek:"进入下一周",tabs:{market:"市场",inventory:"背包",houses:"房屋"},marketStatus:{bull:"上涨(牛市)",bear:"下跌(熊市)",stable:"稳定",mixed:"混合"}},gameMenu:{title:"游戏菜单",save:"保存游戏",load:"读取游戏",mainMenu:"返回主菜单",settings:"设置",continue:"继续游戏"},saveDialog:{title:"保存游戏",namePlaceholder:"输入存档名称"},gameOver:{title:"游戏结束",victory:"恭喜！你成功购买了豪宅！",houseVictory:"恭喜！你已购买房产，完成游戏主要目标！",timeLimit:"时间已到！",weeksPlayed:"游戏周数",finalMoney:"最终资金",netWorth:"净资产",purchasedHouses:"已购房屋",backToMenu:"返回主菜单",continueGame:"继续游戏",continueDescription:"你可以选择继续游戏，直到第52周结束，或查看当前成绩",restartGame:"重新开始"},recovery:{title:"游戏恢复",defaultMessage:"检测到游戏意外中断。我们找到了您的游戏进度，是否恢复？",date:"日期",gameWeek:"游戏周",weekNumber:"第 {week} 周",playerName:"玩家名称",money:"资金",recover:"恢复游戏",cancel:"放弃恢复",success:"游戏状态已成功恢复",failed:"无法恢复游戏状态",noSnapshot:"没有可用的恢复点",automaticRecovery:"游戏将尝试自动恢复您的进度",currency:"元"},inventory:{title:"背包",capacityUsed:"容量: {used}/{total}",productName:"商品名称",quantity:"数量",purchasePrice:"购买价",currentPrice:"当前价",trend:"趋势",profit:"盈亏",action:"操作",sell:"出售",empty:"背包空空如也",full:"背包已满",almostFull:"背包即将装满"},market:{title:"{location}",selectLocation:"选择地点",productName:"商品名称",price:"价格",trend:"趋势",change:"涨跌",action:"操作",buy:"购买",noProducts:"当前地点没有可购买的商品",special:"特价商品",viewMode:{table:"表格视图",card:"卡片视图"},priceHistory:"价格历史",priceChart:{title:"价格走势图",weeks:"周数",price:"价格",high:"最高价",low:"最低价",average:"平均价",currentPrice:"当前价格",historicalPrices:"历史价格",priceRange:"价格区间",weekRange:"周数区间",noData:"暂无价格数据"},filter:{all:"全部商品",special:"特价商品",rising:"上涨商品",falling:"下跌商品",stable:"稳定商品"},sort:{default:"默认排序",priceAsc:"价格从低到高",priceDesc:"价格从高到低",changeAsc:"涨幅从低到高",changeDesc:"涨幅从高到低",nameAsc:"名称正序",nameDesc:"名称倒序"},location:{travel:"前往",currentLocation:"当前地点",travelCost:"旅行费用",travelTime:"旅行时间",travelConfirm:"确认前往{location}吗？",travelSuccess:"你已到达{location}",second_hand_market:"二手市场",premium_mall:"高端商城",electronics_hub:"电子科技城",black_market:"地下黑市",commodity_market:"大宗商品交易所",second_hand_market_desc:"各类二手物品和低价生活必需品的集散地，价格便宜但品质参差不齐",premium_mall_desc:"汇聚各类高端品牌和奢侈品的购物中心，价格昂贵但品质优良",electronics_hub_desc:"各类电子产品和数码设备的专业交易市场，价格适中且品种齐全",black_market_desc:"隐蔽的非法交易场所，各类珍稀收藏品和奇特商品云集，风险与机遇并存",commodity_market_desc:"批发市场和大宗商品交易的集中地，价格低廉但需要大量采购"},houseMarket:{title:"房产市场",affordable:"可购买",purchased:"已购买",alreadyOwned:"已拥有",price:"价格",level:"等级",size:"面积",location:"位置",buyButton:"购买",noHouses:"没有可购买的房屋",notEnoughMoney:"资金不足！您需要¥{price}，但只有¥{money}，还差¥{shortfall}",fundsChanged:"您的资金已发生变化！需要¥{price}，但只有¥{money}，还差¥{shortfall}",significantConfirm:"这笔交易将花费您{percent}%的资金，确定要购买吗？",purchaseSuccess:"恭喜！您已成功购买{house}",purchaseFailed:"购买失败，请稍后重试",confirmTitle:"确认购买房产",confirmMessage:'您确定要购买"{house}"吗？',yourMoney:"您的资金",remaining:"购买后剩余",significantWarning:"注意：这是一笔大额交易，将耗费您大部分资金！",victoryPurchase:"恭喜！您已成功购买房产",victoryMessage:"恭喜您购买了房产：{house}！\n\n您当前处于第{week}周，游戏总共有{maxWeek}周。",continuePrompt:"您想要结束游戏并查看结果，还是继续游戏争取更高分数？",continuePlaying:"您选择了继续游戏，争取更高分数！游戏将继续进行到第52周。",endGameNow:"结束游戏并查看成绩",continueGame:"继续游戏",details:{title:"房屋详情",price:"价格",size:"面积",location:"位置",type:"类型",features:"特色",description:"描述"},types:{apartment:"公寓",house:"独栋别墅",villa:"豪华别墅",mansion:"豪宅",penthouse:"顶层公寓"},features:{garden:"花园",pool:"游泳池",garage:"车库",security:"安保系统",view:"景观视野",central:"中心位置",quiet:"安静社区",modern:"现代装修",classic:"经典风格",luxury:"豪华装修"}}},houses:{small:{name:"单身公寓",description:"适合单身人士居住的小型公寓，位置便利但空间有限。"},medium:{name:"二手旧房",description:"年代较久的二手住宅，价格适中但可能需要装修。空间较大，非常适合改造成理想的家。"},large:{name:"高档小区",description:"现代化高档住宅小区，环境优美，配套设施齐全。社区环境安全，是家庭居住的绝佳选择。"},luxury:{name:"现代别墅",description:"独栋现代别墅，拥有私家花园和车库。宽敞的空间和精致的设计，彰显主人的品味与地位。"},mansion:{name:"私人庄园",description:"大型私人庄园，带有大片绿地和多功能区域。拥有这样的房产，代表你已达到人生巅峰！"}},buyModal:{title:"购买 {product}",price:"单价",availableMoney:"可用资金",availableSpace:"可用空间",quantity:"购买数量",totalCost:"总花费",maxQuantity:"最大",confirm:"确认购买",cancel:"取消"},sellModal:{title:"出售 {product}",purchasePrice:"买入价",currentPrice:"当前价",quantity:"持有数量",sellQuantity:"出售数量",potentialProfit:"预计盈亏",totalIncome:"总收入",maxQuantity:"全部",confirm:"确认出售",cancel:"取消"},houseModal:{title:"购买 {house}",confirmPurchase:"确认购买此房屋吗？",price:"房屋价格",availableMoney:"可用资金",remainingMoney:"购买后剩余",confirm:"确认购买",cancel:"取消",endGame:"购买此房屋将结束游戏"},trends:{rising_strong:"价格急剧上涨",rising:"价格上涨中",stable_high:"高位稳定",stable:"价格稳定",stable_low:"低位稳定",falling:"价格下跌中",falling_strong:"价格急剧下跌",volatile:"价格剧烈波动",trendAnalysis:{title:"趋势分析",shortTerm:"短期趋势",midTerm:"中期趋势",longTerm:"长期趋势",prediction:"预测",confidence:"置信度",high:"高",medium:"中",low:"低"}},playerInfo:{title:"玩家信息",name:"姓名",money:"资金",debt:"债务",capacity:"背包容量",week:"周数",repayDebt:"还款",bank:"银行",stats:{title:"玩家统计",totalProfit:"总利润",transactions:"交易次数",visitedLocations:"已访问地点",eventsTriggered:"触发事件数",highestSingleProfit:"单笔最高利润",mostProfitableProduct:"最赚钱商品",mostVisitedLocation:"最常去地点"}},inventory:{title:"背包",capacityUsed:"容量: {used}/{total}",productName:"商品名称",quantity:"数量",purchasePrice:"买入价",currentPrice:"当前价",trend:"趋势",profit:"盈亏",action:"操作",sell:"出售",empty:"背包是空的",sort:{default:"默认排序",profitDesc:"利润从高到低",profitAsc:"利润从低到高",quantityDesc:"数量从多到少",quantityAsc:"数量从少到多",nameAsc:"名称正序",nameDesc:"名称倒序"},filter:{all:"全部商品",profitable:"盈利商品",unprofitable:"亏损商品"},details:{title:"商品详情",purchaseInfo:"购买信息",purchaseDate:"购买日期",purchaseLocation:"购买地点",currentInfo:"当前信息",potentialProfit:"潜在利润",profitPercentage:"利润率"}},repayModal:{title:"偿还债务",currentDebt:"当前债务",availableMoney:"可用资金",repayAmount:"还款金额",remainingDebt:"剩余债务",remainingMoney:"剩余资金",fullRepay:"全部还清",confirm:"确认还款",cancel:"取消"},debtSystem:{title:"债务系统",currentDebt:"当前债务",interestRate:"利率",nextInterest:"下次利息",paymentDue:"应付金额",warning:{high:"警告：债务过高",critical:"危险：债务即将触发破产",bankrupt:"您已破产！"},interestApplied:"已收取{amount}元利息"},bank:{title:"银行服务",deposit:"存款",withdraw:"取款",loan:"贷款",repay:"还款",currentDeposit:"当前存款",currentLoan:"当前贷款",interestRate:"利率",depositInterest:"存款利率",loanInterest:"贷款利率",maxLoan:"最大贷款额度",availableLoan:"可贷款额度",amountToDeposit:"存款金额",amountToWithdraw:"取款金额",amountToLoan:"贷款金额",amountToRepay:"还款金额",confirmDeposit:"确认存款",confirmWithdraw:"确认取款",confirmLoan:"确认贷款",confirmRepay:"确认还款",interestInfo:"每周结算一次利息",notEnoughMoney:"资金不足",depositSuccess:"存款成功",withdrawSuccess:"取款成功",loanSuccess:"贷款成功",repaySuccess:"还款成功",weeklyInterest:"每周利息",remainingMoney:"剩余资金",remainingDeposit:"剩余存款",remainingLoan:"剩余贷款",remainingDebt:"剩余债务"},tutorial:{tips:{welcome:{title:"欢迎来到《买房记》",content:"在这个游戏中，你的目标是通过买卖商品赚取差价，最终积累足够的资金购买房产。<br><br>你有52周的时间来实现这个目标，祝你好运！"},market_intro:{title:"市场交易",content:"在市场标签页中，你可以购买各种商品。不同地点提供的商品和价格各不相同。<br><br>关注价格趋势，在价格低时购买，价格高时卖出，赚取差价。"},inventory_intro:{title:"库存管理",content:"在库存标签页中，你可以查看已购买的商品，并在合适的时机卖出。<br><br>注意背包容量有限，合理规划购买的商品数量。"},location_change:{title:"切换地点",content:"你可以在不同地点之间切换，每个地点都有不同的商品和价格。<br><br>利用不同地点之间的价格差异，可以赚取更多利润。"},price_trends:{title:"价格趋势",content:"商品价格会随时间波动，关注价格趋势是获利的关键。<br><br>上涨趋势表示价格可能继续上涨，下跌趋势表示价格可能继续下跌。"},special_products:{title:"特色商品",content:"每个地点都有特色商品，价格更优惠。特色商品在商品列表中会有特殊标记。<br><br>关注特色商品可以提高交易利润。"},houses:{title:"房产购买",content:"当你积累了足够的资金后，可以在房产标签页中购买房屋。<br><br>不同房屋有不同的价格，购买任意房屋都会结束游戏。"},mid_game:{title:"游戏进展",content:"你已经完成了游戏的四分之一！现在是时候制定更长远的计划了。<br><br>考虑积累更多资金，为购买房产做准备。"},late_game:{title:"游戏后期",content:"游戏已经过半，确保你的资金增长足够快，以便在游戏结束前购买理想的房产。<br><br>如果资金增长缓慢，可能需要调整交易策略或承担更多风险。"}},help:{title:"游戏帮助",basics:"游戏基础",trading:"交易技巧",events:"事件系统",settings:"游戏设置",gotIt:"知道了",dontShowAgain:"不再显示此提示",prev:"上一条",next:"下一条",shortcuts:{title:"键盘快捷键",space:"进入下一周",tab:"切换标签页",esc:"打开/关闭菜单",h:"打开帮助面板"}}},event:{title:"事件",debtIncrease:"债务增加",debtDecrease:"债务减少",gainProduct:"获得物品",loseProduct:"失去物品",moneyGain:"获得资金",moneyLoss:"失去资金",priceChange:"价格变动",capacityChange:"背包容量变化",specialEvent:"特殊事件",types:{positive:"正面事件",negative:"负面事件",neutral:"中性事件",mixed:"复合事件"},effects:{money:"资金 {change}",debt:"债务 {change}",capacity:"背包容量 {change}",product:"商品: {product} x {quantity}",price:"{product} 价格 {change}",location:"解锁地点: {location}"},choices:{accept:"接受",decline:"拒绝",option1:"选项1",option2:"选项2",option3:"选项3",continue:"继续"},notifications:{triggered:"触发事件: {name}",completed:"事件完成: {name}",reward:"获得奖励: {reward}",penalty:"受到惩罚: {penalty}",choiceMade:"已选择: {choice}"},common:{marketCrash:"市场崩盘",marketBoom:"市场繁荣",robbery:"遭遇抢劫",lottery:"中彩票",backpackUpgrade:"背包升级",backpackDamage:"背包损坏",investmentSuccess:"投资成功",investmentFailure:"投资失败",taxAudit:"税务审计",inheritance:"意外继承",donation:"慈善捐款",discount:"特别折扣",priceHike:"价格上涨",specialOffer:"特别优惠",blackMarket:"黑市交易"},descriptions:{marketCrash:"市场突然崩盘！所有商品价格大幅下跌。",marketBoom:"市场突然繁荣！所有商品价格大幅上涨。",robbery:"你被抢劫了！失去了一些资金和商品。",lottery:"恭喜你中了彩票！获得额外资金。",backpackUpgrade:"你找到了一个更大的背包，容量增加！",backpackDamage:"你的背包破损了，容量减少！",investmentSuccess:"你的投资获得了成功，获得额外收益。",investmentFailure:"你的投资失败了，损失了一些资金。",taxAudit:"税务部门对你进行了审计，你需要支付一些税款。",inheritance:"你意外继承了一笔财产，获得额外资金。",donation:"你决定为慈善事业捐款，失去一些资金但获得了好评。",discount:"商店推出了特别折扣，某些商品价格下降。",priceHike:"由于供应短缺，某些商品价格上涨。",specialOffer:"你收到了一个特别优惠，可以低价购买某些商品。",blackMarket:"你发现了一个黑市交易机会，可以高价出售某些商品。"}},notifications:{error:{inventoryFull:"背包空间不足",insufficientStock:"库存数量不足",houseNotFound:"找不到指定的房屋",alreadyOwned:"已经拥有此房屋",invalidRepayment:"还款金额无效",saveFailed:"保存游戏失败",loadFailed:"找不到存档或存档已损坏",insufficientFunds:"资金不足，无法购买",autoSaveFailed:"自动保存失败",autoSaveError:"自动保存过程出错"},success:{purchased:"成功购买",sold:"成功出售",housePurchased:"成功购买房屋",repaid:"成功还款",gameSaved:"游戏已保存",gameLoaded:"已加载游戏",autoSaved:"自动保存成功"},info:{endGame:"你选择了结束游戏",timeUp:"时间已到！游戏结束",bankrupt:"你已破产！游戏结束",weekProgress:"进入第 {week} 周",locationChange:"你已到达 {location}"},achievement:{earlyGoal:"提前达成目标",noDebtHouse:"零负债购房",victory:"恭喜！你成功购买了最贵的房产！",achieved:"你达成了成就: {name}"}},ui:{mainMenu:{title:"买房记",newGame:"新游戏",loadGame:"加载游戏",settings:"设置",exit:"退出",version:"版本 {version}",credits:"制作团队"},saveMenu:{title:"存档管理",newSave:"新建存档",loadSave:"加载存档",deleteSave:"删除存档",back:"返回",noSaves:"没有找到存档",saveDate:"保存日期: {date}",saveWeek:"游戏周: {week}",playerName:"玩家: {name}",playerMoney:"资金: {money}",confirmDelete:"确定要删除这个存档吗？",overwriteConfirm:"存档已存在，是否覆盖？",invalidSave:"无效的存档文件"},gameView:{nextWeek:"下一周",menu:"菜单",tabs:{market:"市场",inventory:"背包",houses:"房屋"},weekDisplay:"第 {current}/{total} 周",moneyDisplay:"{amount} 元",debtDisplay:"债务: {amount} 元",loading:"加载中...",saving:"保存中..."},dialogs:{confirm:{title:"确认",ok:"确定",cancel:"取消"},alert:{title:"提示",ok:"确定"},input:{title:"输入",ok:"确定",cancel:"取消"},error:{title:"错误",ok:"确定",details:"详细信息"}},toast:{success:"成功",error:"错误",info:"提示",warning:"警告"},loading:{initializing:"初始化游戏...",loadingAssets:"加载资源...",loadingGame:"加载游戏...",savingGame:"保存游戏...",processingTurn:"处理游戏回合...",generatingWorld:"生成游戏世界...",ready:"准备就绪"},devTools:{title:"开发工具",addMoney:"添加资金",removeMoney:"减少资金",addDebt:"添加债务",removeDebt:"减少债务",skipWeek:"跳过周数",unlockAllLocations:"解锁所有地点",resetPrices:"重置价格",triggerEvent:"触发事件",amount:"数量",apply:"应用",cancel:"取消",eventType:"事件类型",warning:"警告：使用开发工具可能会影响游戏平衡和体验"},charts:{title:"图表",priceHistory:"价格历史",playerNetWorth:"玩家净资产",weeklyProfit:"每周利润",zoom:"缩放",period:"周期",showAll:"显示全部",last10Weeks:"最近10周",last20Weeks:"最近20周",custom:"自定义",noData:"暂无数据",exportData:"导出数据",importData:"导入数据"},errorHandling:{title:"错误处理",message:"发生错误",details:"详细信息",stackTrace:"堆栈跟踪",retry:"重试",ignore:"忽略",report:"报告问题",close:"关闭",errorBoundary:{title:"组件错误",message:"组件渲染出错",reset:"重置组件"}}},errors:{defaultError:"发生了一个错误",severity:{fatal:"致命错误",error:"错误",warning:"警告",info:"提示"},type:{validation:{default:"数据验证错误: {message}",specific:{required_field:"必填字段不能为空",invalid_format:"数据格式不正确",out_of_range:"数值超出允许范围",invalid_type:"数据类型不正确",duplicate_entry:"数据已存在",too_short:"输入内容过短",too_long:"输入内容过长"}},network:{default:"网络错误: {message}",specific:{connection_failed:"连接服务器失败，请检查您的网络连接",timeout:"请求超时，请稍后重试",server_error:"服务器错误",api_error:"API错误",invalid_response:"无效的服务器响应",offline:"您当前处于离线状态"}},storage:{default:"存储错误: {message}",specific:{file_not_found:"找不到文件",permission_denied:"没有足够权限",quota_exceeded:"存储空间不足",data_corrupt:"数据已损坏",unknown:"未知存储错误",save_failed:"保存游戏失败",load_failed:"加载游戏失败",file_io_error:"文件读写错误",invalid_format:"无效的文件格式",version_mismatch:"版本不兼容"}},game_logic:{default:"游戏逻辑错误: {message}",specific:{invalid_operation:"无效的操作",insufficient_funds:"资金不足",inventory_full:"背包已满",invalid_state:"无效的游戏状态",invalid_transition:"无效的状态转换",out_of_bounds:"超出边界",dependency_missing:"缺少依赖项",invalid_parameter:"无效的参数",calculation_error:"计算错误",rule_violation:"违反游戏规则"}},system:{default:"系统错误: {message}",specific:{initialization_failed:"初始化游戏失败",resource_not_found:"找不到需要的资源",memory_error:"内存错误",performance_issue:"性能问题",render_error:"渲染错误",audio_error:"音频错误",plugin_error:"插件错误",compatibility_issue:"兼容性问题",unexpected_state:"意外的系统状态",critical_failure:"严重故障"}},unknown:{default:"{message}"}},recovery:{title:"错误恢复",message:"游戏遇到了一个问题，正在尝试恢复...",success:"恢复成功",failed:"恢复失败",options:{retry:"重试",reload:"重新加载",reset:"重置游戏",ignore:"忽略并继续",report:"报告问题"},autoSave:{corrupted:"自动存档已损坏",notFound:"找不到自动存档",incompatible:"自动存档与当前版本不兼容",loadFailed:"加载自动存档失败"},stateSnapshot:{restoring:"正在恢复游戏状态...",noValidSnapshot:"没有可用的游戏状态快照",partialRestore:"部分游戏状态已恢复",fullRestore:"游戏状态已完全恢复"}},errorLog:{title:"错误日志",empty:"没有记录的错误",timestamp:"时间",message:"消息",type:"类型",severity:"严重程度",details:"详细信息",actions:{clear:"清空日志",export:"导出日志",filter:"筛选日志",search:"搜索",showDetails:"显示详情",hideDetails:"隐藏详情"}}}};function m(){try{const e=localStorage.getItem("userLanguage");if(e)return e}catch(e){F(e,"i18n.getUserLanguage",c.STORAGE,l.INFO),console.warn("无法从本地存储读取语言设置:",e)}return(navigator.language||navigator.userLanguage).startsWith("zh"),"zh-CN"}const p=function(){const e=i({legacy:!1,locale:m(),fallbackLocale:"zh-CN",messages:{"zh-CN":d},datetimeFormats:{"zh-CN":{short:{year:"numeric",month:"2-digit",day:"2-digit"},long:{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}}},numberFormats:{"zh-CN":{currency:{style:"currency",currency:"CNY",notation:"standard"},decimal:{style:"decimal",minimumFractionDigits:0,maximumFractionDigits:2},percent:{style:"percent",useGrouping:!1}}}});return e.global.setLanguage=t=>{e.global.availableLocales.includes(t)||(console.warn(`语言 ${t} 不可用，使用默认语言`),t=e.global.fallbackLocale.value),e.global.locale.value=t,document.querySelector("html").setAttribute("lang",t);try{localStorage.setItem("userLanguage",t)}catch(i){F(i,"i18n.setLanguage",c.STORAGE,l.INFO),console.warn("无法保存语言设置到本地存储:",i)}},e.global.getSupportedLanguages=()=>[{code:"zh-CN",name:"简体中文",flag:"🇨🇳"}],e.global.formatCurrency=t=>e.global.n(t,"currency"),e.global.formatDate=(t,i="long")=>e.global.d(t,i),e.global.formatNumber=t=>e.global.n(t,"decimal"),e.global.formatPercent=t=>e.global.n(t,"percent"),e}();p.global.t,p.global.d,p.global.n,p.global.setLanguage;const h=p.global.getSupportedLanguages;p.global.formatCurrency,p.global.formatDate,p.global.formatNumber,p.global.formatPercent;var g="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function y(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var v={exports:{}},f=function(e){return Object.defineProperties(t,{defaultLabel:{value:"",writable:!0},labelPadding:{value:!0,writable:!0},maxLabelLength:{value:0,writable:!0},labelLength:{get(){switch(typeof t.labelPadding){case"boolean":return t.labelPadding?t.maxLabelLength:0;case"number":return t.labelPadding;default:return 0}}}});function t(i){t.maxLabelLength=Math.max(t.maxLabelLength,i.length);const r={};for(const t of e.levels)r[t]=(...r)=>e.logData(r,{level:t,scope:i});return r.log=r.info,r}};const b=f,k=class{constructor({processMessage:e}){this.processMessage=e,this.buffer=[],this.enabled=!1,this.begin=this.begin.bind(this),this.commit=this.commit.bind(this),this.reject=this.reject.bind(this)}addMessage(e){this.buffer.push(e)}begin(){this.enabled=[]}commit(){this.enabled=!1,this.buffer.forEach(e=>this.processMessage(e)),this.buffer=[]}reject(){this.enabled=!1,this.buffer=[]}},P=class e{constructor({allowUnknownLevel:i=!1,dependencies:r={},errorHandler:o,eventLogger:s,initializeFn:a,isDev:n=!1,levels:c=["error","warn","info","verbose","debug","silly"],logId:l,transportFactories:u={},variables:d}={}){t(this,"dependencies",{}),t(this,"errorHandler",null),t(this,"eventLogger",null),t(this,"functions",{}),t(this,"hooks",[]),t(this,"isDev",!1),t(this,"levels",null),t(this,"logId",null),t(this,"scope",null),t(this,"transports",{}),t(this,"variables",{}),this.addLevel=this.addLevel.bind(this),this.create=this.create.bind(this),this.initialize=this.initialize.bind(this),this.logData=this.logData.bind(this),this.processMessage=this.processMessage.bind(this),this.allowUnknownLevel=i,this.buffering=new k(this),this.dependencies=r,this.initializeFn=a,this.isDev=n,this.levels=c,this.logId=l,this.scope=b(this),this.transportFactories=u,this.variables=d||{};for(const e of this.levels)this.addLevel(e,!1);this.log=this.info,this.functions.log=this.log,this.errorHandler=o,null==o||o.setOptions({...r,logFn:this.error}),this.eventLogger=s,null==s||s.setOptions({...r,logger:this});for(const[e,t]of Object.entries(u))this.transports[e]=t(this,r);e.instances[l]=this}static getInstance({logId:e}){return this.instances[e]||this.instances.default}addLevel(e,t=this.levels.length){!1!==t&&this.levels.splice(t,0,e),this[e]=(...t)=>this.logData(t,{level:e}),this.functions[e]=this[e]}catchErrors(e){return this.processMessage({data:["log.catchErrors is deprecated. Use log.errorHandler instead"],level:"warn"},{transports:["console"]}),this.errorHandler.startCatching(e)}create(t){return"string"==typeof t&&(t={logId:t}),new e({dependencies:this.dependencies,errorHandler:this.errorHandler,initializeFn:this.initializeFn,isDev:this.isDev,transportFactories:this.transportFactories,variables:{...this.variables},...t})}compareLevels(e,t,i=this.levels){const r=i.indexOf(e),o=i.indexOf(t);return-1===o||-1===r||o<=r}initialize(e={}){this.initializeFn({logger:this,...this.dependencies,...e})}logData(e,t={}){this.buffering.enabled?this.buffering.addMessage({data:e,date:new Date,...t}):this.processMessage({data:e,...t})}processMessage(e,{transports:t=this.transports}={}){if("errorHandler"===e.cmd)return void this.errorHandler.handle(e.error,{errorName:e.errorName,processType:"renderer",showDialog:Boolean(e.showDialog)});let i=e.level;this.allowUnknownLevel||(i=this.levels.includes(e.level)?e.level:"info");const r={date:new Date,logId:this.logId,...e,level:i,variables:{...this.variables,...e.variables}};for(const[s,a]of this.transportEntries(t))if("function"==typeof a&&!1!==a.level&&this.compareLevels(a.level,e.level))try{const e=this.hooks.reduce((e,t)=>e?t(e,a,s):e,r);e&&a({...e,data:[...e.data]})}catch(o){this.processInternalErrorFn(o)}}processInternalErrorFn(e){}transportEntries(e=this.transports){return(Array.isArray(e)?e:Object.entries(e)).map(e=>{switch(typeof e){case"string":return this.transports[e]?[e,this.transports[e]]:null;case"function":return[e.name,e];default:return Array.isArray(e)?e:null}}).filter(Boolean)}};t(P,"instances",{});var _=P;const E=console.error;var S=class{constructor({logFn:e=null}={}){t(this,"logFn",null),t(this,"onError",null),t(this,"showDialog",!1),t(this,"preventDefault",!0),this.handleError=this.handleError.bind(this),this.handleRejection=this.handleRejection.bind(this),this.startCatching=this.startCatching.bind(this),this.logFn=e}handle(e,{logFn:t=this.logFn,errorName:i="",onError:r=this.onError,showDialog:o=this.showDialog}={}){try{!1!==(null==r?void 0:r({error:e,errorName:i,processType:"renderer"}))&&t({error:e,errorName:i,showDialog:o})}catch{E(e)}}setOptions({logFn:e,onError:t,preventDefault:i,showDialog:r}){"function"==typeof e&&(this.logFn=e),"function"==typeof t&&(this.onError=t),"boolean"==typeof i&&(this.preventDefault=i),"boolean"==typeof r&&(this.showDialog=r)}startCatching({onError:e,showDialog:t}={}){this.isActive||(this.isActive=!0,this.setOptions({onError:e,showDialog:t}),window.addEventListener("error",e=>{var t;this.preventDefault&&(null==(t=e.preventDefault)||t.call(e)),this.handleError(e.error||e)}),window.addEventListener("unhandledrejection",e=>{var t;this.preventDefault&&(null==(t=e.preventDefault)||t.call(e)),this.handleRejection(e.reason||e)}))}handleError(e){this.handle(e,{errorName:"Unhandled"})}handleRejection(e){const t=e instanceof Error?e:new Error(JSON.stringify(e));this.handle(t,{errorName:"Unhandled rejection"})}},M={transform:function({logger:e,message:t,transport:i,initialData:r=(null==t?void 0:t.data)||[],transforms:o=(null==i?void 0:i.transforms)}){return o.reduce((r,o)=>"function"==typeof o?o({data:r,logger:e,message:t,transport:i}):r,r)}};const{transform:w}=M;var L=function(e){return Object.assign(function t(i){t.writeFn({message:{...i,data:w({logger:e,message:i,transport:t})}})},{format:"{h}:{i}:{s}.{ms}{scope} › {text}",transforms:[x],writeFn({message:{level:e,data:t}}){const i=I[e]||I.info;setTimeout(()=>i(...t))}})};const I={error:console.error,warn:console.warn,info:console.info,verbose:console.info,debug:console.debug,silly:console.debug,log:console.log};function x({data:e=[],logger:t={},message:i={},transport:r={}}){if("function"==typeof r.format)return r.format({data:e,level:(null==i?void 0:i.level)||"info",logger:t,message:i,transport:r});if("string"!=typeof r.format)return e;e.unshift(r.format),"string"==typeof e[1]&&e[1].match(/%[1cdfiOos]/)&&(e=[`${e[0]}${e[1]}`,...e.slice(2)]);const o=i.date||new Date;return e[0]=e[0].replace(/\{(\w+)}/g,(e,r)=>{var s,a;switch(r){case"level":return i.level;case"logId":return i.logId;case"scope":{const e=i.scope||(null==(s=t.scope)?void 0:s.defaultLabel);return e?` (${e})`:""}case"text":return"";case"y":return o.getFullYear().toString(10);case"m":return(o.getMonth()+1).toString(10).padStart(2,"0");case"d":return o.getDate().toString(10).padStart(2,"0");case"h":return o.getHours().toString(10).padStart(2,"0");case"i":return o.getMinutes().toString(10).padStart(2,"0");case"s":return o.getSeconds().toString(10).padStart(2,"0");case"ms":return o.getMilliseconds().toString(10).padStart(3,"0");case"iso":return o.toISOString();default:return(null==(a=i.variables)?void 0:a[r])||e}}).trim(),e}const{transform:W}=M;var A=function(e){return Object.assign(function t(i){if(!window.__electronLog)return void e.processMessage({data:["electron-log: logger isn't initialized in the main process"],level:"error"},{transports:["console"]});try{const r=W({initialData:i,logger:e,message:i,transport:t});__electronLog.sendToMain(r)}catch(r){e.transports.console({data:["electronLog.transports.ipc",r,"data:",i.data],level:"error"})}},{depth:5,transforms:[R]})};const C=new Set([Promise,WeakMap,WeakSet]);function O(e){return Object(e)!==e}function R({data:e,depth:t,seen:i=new WeakSet,transport:r={}}={}){const o=t||r.depth||5;return i.has(e)?"[Circular]":o<1?O(e)?e:Array.isArray(e)?"[Array]":`[${typeof e}]`:["function","symbol"].includes(typeof e)?e.toString():O(e)?e:C.has(e.constructor)?`[${e.constructor.name}]`:Array.isArray(e)?e.map(e=>R({data:e,depth:o-1,seen:i})):e instanceof Date?e.toISOString():e instanceof Error?e.stack:e instanceof Map?new Map(Array.from(e).map(([e,t])=>[R({data:e,depth:o-1,seen:i}),R({data:t,depth:o-1,seen:i})])):e instanceof Set?new Set(Array.from(e).map(e=>R({data:e,depth:o-1,seen:i}))):(i.add(e),Object.fromEntries(Object.entries(e).map(([e,t])=>[e,R({data:t,depth:o-1,seen:i})])))}!function(e){const t=_,i=S,r=L,o=A;"object"==typeof process&&"browser"===process.type&&console.warn("electron-log/renderer is loaded in the main process. It could cause unexpected behaviour."),e.exports=function(){const e=new t({allowUnknownLevel:!0,errorHandler:new i,initializeFn:()=>{},logId:"default",transportFactories:{console:r,ipc:o},variables:{processType:"renderer"}});e.errorHandler.setOptions({logFn({error:t,errorName:i,showDialog:r}){e.transports.console({data:[i,t].filter(Boolean),level:"error"}),e.transports.ipc({cmd:"errorHandler",error:{cause:null==t?void 0:t.cause,code:null==t?void 0:t.code,name:null==t?void 0:t.name,message:null==t?void 0:t.message,stack:null==t?void 0:t.stack},errorName:i,logId:e.logId,showDialog:r})}}),"object"==typeof window&&window.addEventListener("message",e=>{const{cmd:i,logId:r,...o}=e.data||{},s=t.getInstance({logId:r});"message"===i&&s.processMessage(o,{transports:["console"]})});return new Proxy(e,{get:(t,i)=>void 0!==t[i]?t[i]:(...t)=>e.logData(t,{level:i})})}(),e.exports.Logger=t,e.exports.default=e.exports}(v);const N=y(v.exports),D=s([]),G=200,T="gameRunning",$="lastGameActivity";let j=null;async function H(){if(j)return j;const e=async(t=0)=>{try{const e=await n(()=>Promise.resolve().then(()=>X),void 0,import.meta.url);if(e&&"function"==typeof e.useUiStore){const t=e.useUiStore();if(t&&"object"==typeof t)return j=t,t;throw new Error("Invalid uiStore instance")}throw new Error("useUiStore function not found")}catch(i){return console.error(`Failed to import uiStore (attempt ${t+1}/3):`,i),t<2?(console.log("Retrying in 300ms..."),await new Promise(e=>setTimeout(e,300)),e(t+1)):null}};return e()}function F(e,t,i=c.UNKNOWN,r=l.ERROR){const o={message:e.message||"未知错误",context:t,type:i,severity:r,timestamp:(new Date).toISOString(),stack:e.stack,metadata:e.metadata||{}};return function(e){D.value.unshift(e),D.value.length>G&&(D.value=D.value.slice(0,G));try{const e=JSON.stringify(D.value);localStorage.setItem("errorLogs",e)}catch(t){console.error("Failed to save error logs to localStorage:",t)}}(o),r===l.FATAL||r===l.ERROR?async function(e){try{const t=await H();t&&"function"==typeof t.showErrorDialog?t.showErrorDialog({title:e.severity===l.FATAL?"严重错误":"错误",message:q(e),details:void 0,timestamp:e.timestamp,context:e.context}):(console.error("UI Store不可用，使用备用错误提示"),alert(q(e)))}catch(t){console.error("Error showing error dialog:",t),alert(q(e))}}(o):r===l.WARNING&&async function(e){try{const t=await H();t&&"function"==typeof t.showToast?t.showToast({type:"error",message:q(e),duration:5e3}):console.warn(q(e))}catch(t){console.warn("Error showing toast:",t)}}(o),window.electronAPI&&window.electronAPI.logError?window.electronAPI.logError(o):N.error(`[${i}][${t}]`,e),o}function U(){return new Promise(e=>{try{const t=localStorage.getItem("errorLogs");if(t){const e=JSON.parse(t);D.value=e,D.value.length>G&&(D.value=D.value.slice(0,G))}e([...D.value])}catch(t){console.error("Failed to load error logs from localStorage:",t),e([])}})}function q(e){try{const t=`errors.${e.type}.specific.${e.message.toLowerCase().replace(/\s+/g,"_").replace(/[^\w]/g,"")}`,i=`errors.${e.type}.default`,r="发生错误";return p.global&&p.global.te&&p.global.te(t)?p.global.t(t):p.global&&p.global.te&&p.global.te(i)?p.global.t(i,{message:e.message}):e.message||r}catch(t){return console.error("Error getting localized error message:",t),e.message||"发生错误"}}async function V(e,t,i=c.UNKNOWN,r=l.ERROR){try{return await e()}catch(o){throw F(o,t,i,r),o}}function z(e){e&&e.config?(e.config.errorHandler=(e,t,i)=>{let r="Unknown";try{t&&t.$options&&t.$options.name?r=t.$options.name:t&&t.$root&&(r="Root Component")}catch(o){r="Error getting component name"}F(e,`Vue组件: ${r}`,c.COMPONENT,l.ERROR)},window.addEventListener("unhandledrejection",e=>{F(e.reason||new Error("未处理的Promise异常"),"Promise",c.ASYNC,l.ERROR)}),window.addEventListener("error",e=>{e.error&&F(e.error,"全局异常",c.RUNTIME,l.ERROR)}),U(),window.addEventListener("beforeunload",()=>{J()})):console.warn("无法设置全局错误处理：app实例无效")}function B(){try{localStorage.setItem(T,"true"),function(){try{localStorage.setItem($,Date.now().toString())}catch(e){console.warn("Failed to update game activity timestamp:",e)}}()}catch(e){console.warn("Failed to set game running flag:",e)}}function J(){try{localStorage.removeItem(T)}catch(e){console.warn("Failed to clear game running flag:",e)}}function K(){try{if(!("true"===localStorage.getItem(T)))return!1;const e=localStorage.getItem($);if(e){const t=parseInt(e,10);if(Date.now()-t<3e5)return!0}return!1}catch(e){return console.warn("Failed to check game running flag:",e),!1}}function Y(e){if(!e||"undefined"===e||"null"===e)return"/resources/assets/images/house_1.jpeg";if(!isNaN(parseInt(e))){const t=parseInt(e);return`/resources/assets/images/house_${t?Math.max(1,Math.min(5,t%5||1)):1}.jpeg`}return{apartment:"/resources/assets/images/house_1.jpeg",second_hand:"/resources/assets/images/house_2.jpeg",highend:"/resources/assets/images/house_3.jpeg",villa:"/resources/assets/images/house_4.jpeg",mansion:"/resources/assets/images/house_5.jpeg"}[e]||"/resources/assets/images/house_1.jpeg"}const Q=r("ui",()=>{const e=s(!1),t=s(null),i=s([]),r=s({}),o=s(!1),a=s(null),n=s(!1),c=s(null);function l({type:e="info",message:t="",duration:o=3e3,action:s=null,actionText:a="确定",actionCallback:n=null}){const c=i.value.find(e=>e.message===t);c&&u(c.id);const l=Date.now()+Math.random().toString(36).substring(2,10),d={id:l,type:e,message:t,action:s,actionText:a,actionCallback:n};if(i.value.unshift(d),i.value.length>5){const e=i.value.pop();r.value[e.id]&&(clearTimeout(r.value[e.id]),delete r.value[e.id])}return r.value[l]=setTimeout(()=>{u(l)},3e3),l}function u(e){const t=i.value.findIndex(t=>t.id===e);-1!==t&&(i.value.splice(t,1),r.value[e]&&(clearTimeout(r.value[e]),delete r.value[e]))}function d(){o.value=!1,setTimeout(()=>{a.value=null},300)}return{errorDialogVisible:e,errorDialogData:t,showErrorDialog:function(i){t.value=i,e.value=!0},closeErrorDialog:function(){e.value=!1,setTimeout(()=>{t.value=null},300)},toasts:i,addToast:l,removeToast:u,showToast:function({type:e="info",message:t="",duration:i=3e3}){return l({type:e,message:t,duration:i})},closeToast:function(){i.value.forEach(e=>{u(e.id)})},recoveryDialogVisible:o,recoveryDialogData:a,showRecoveryDialog:function({snapshot:e,message:t,title:i,allowCancel:r=!0,onRecover:s,onCancel:n}){a.value={snapshot:e,message:t||"检测到游戏意外中断。是否恢复上次保存的游戏状态？",title:i||"游戏恢复",allowCancel:r,onRecover:s||(()=>d()),onCancel:n||(()=>d())},o.value=!0},closeRecoveryDialog:d,dialogVisible:n,dialogData:c,showDialog:function(e){c.value=e,n.value=!0},closeDialog:function(){n.value=!1,setTimeout(()=>{c.value=null},300)}}}),X=Object.freeze(Object.defineProperty({__proto__:null,useUiStore:Q},Symbol.toStringTag,{value:"Module"})),Z=r("settings",{state:()=>({difficulty:"normal",tutorialEnabled:!0,autoSave:!0,autoSaveInterval:5,soundEnabled:!0,soundVolume:.7,musicEnabled:!0,musicVolume:.5,language:"zh-CN",theme:"light",uiScale:1,animationsEnabled:!0,graphicsQuality:"medium",currentScene:"menu"}),actions:{updateSetting(e,t){e in this.$state&&(this[e]=t,this.saveSettings())},updateSettings(e){Object.entries(e).forEach(([e,t])=>{e in this.$state&&(this[e]=t)}),this.saveSettings()},resetSettings(){this.$reset(),this.saveSettings()},saveSettings(){try{const e=JSON.stringify(this.$state);localStorage.setItem("house-journey-settings",e)}catch(e){F(e,"SettingsStore",c.STORAGE,l.WARNING),console.error("保存设置失败:",e)}},loadSettings(){try{const e=localStorage.getItem("house-journey-settings");if(e){const t=JSON.parse(e);this.updateSettings(t)}}catch(e){F(e,"SettingsStore",c.STORAGE,l.WARNING),console.error("加载设置失败:",e)}},setCurrentScene(e){this.currentScene=e,window.gameAudio&&this.musicEnabled&&window.gameAudio.playBGM(e)}}}),ee=Object.freeze(Object.defineProperty({__proto__:null,useSettingsStore:Z},Symbol.toStringTag,{value:"Module"})),te=r("player",{state:()=>({name:"",money:2e3,debt:5e3,loanPrincipal:5e3,capacity:100,inventoryUsed:0,inventory:[],purchasedHouses:[],initialized:!1,bankDeposit:0,maxLoanAmount:2e4,statistics:{weekCount:1,transactionCount:0,totalProfit:0,maxMoney:2e3,visitedLocations:[],housePurchases:[],firstHousePurchaseWeek:null,mostExpensiveHouse:null,highestLevelHouse:null}}),actions:{initializePlayer(e){return console.log("PlayerStore - 初始化玩家:",e),new Promise(t=>{setTimeout(()=>{this.name=e||p.global.t("system.defaultPlayerName"),this.money=2e3,this.debt=5e3,this.loanPrincipal=5e3,this.capacity=100,this.inventoryUsed=0,this.inventory=[],this.purchasedHouses=[],this.initialized=!0,this.bankDeposit=0,this.maxLoanAmount=2e4,this.statistics={weekCount:1,transactionCount:0,totalProfit:0,maxMoney:2e3,visitedLocations:[],housePurchases:[],firstHousePurchaseWeek:null,mostExpensiveHouse:null,highestLevelHouse:null},console.log("PlayerStore - 玩家初始化完成"),t()},400)})},updateWeeklyPlayerState(e){if(this.statistics.weekCount=e,this.debt>0){const e=Math.floor(.005*this.debt);this.debt+=e}if(this.bankDeposit>0){const e=Math.floor(.003*this.bankDeposit);this.bankDeposit+=e}this.money>this.statistics.maxMoney&&(this.statistics.maxMoney=this.money)},addMoney(e){return!(e<=0)&&(this.money+=e,this.money>this.statistics.maxMoney&&(this.statistics.maxMoney=this.money),!0)},spendMoney(e){return!(e<=0||e>this.money)&&(this.money-=e,!0)},repayDebt(e){return!(e<=0||e>this.money)&&(e>this.debt&&(e=this.debt),this.money-=e,this.debt-=e,e<=this.loanPrincipal?this.loanPrincipal-=e:this.loanPrincipal=0,!0)},addVisitedLocation(e){return!this.statistics.visitedLocations.includes(e)&&(this.statistics.visitedLocations.push(e),!0)},purchaseHouse(e){if(!e||"object"!=typeof e)return console.error("无效的房屋对象传递给purchaseHouse"),!1;const t=["id","name","level","price"];for(const o of t)if(!(o in e))return console.error(`购买房屋失败：房屋对象缺少必需属性 ${o}`),!1;if(e.price>this.money)return console.warn(`购买失败：资金不足 (拥有: ${this.money}, 需要: ${e.price}, 差额: ${e.price-this.money})`),!1;if(this.purchasedHouses.some(t=>t.houseId===e.id))return console.warn(`购买失败：已拥有ID为 ${e.id} 的房屋`),!1;this.money-=e.price;const i=pt().currentWeek,r={houseId:e.id,name:e.name,level:e.level,purchasePrice:e.price,purchaseWeek:i,description:e.description||`${e.level}级房产`,purchaseDate:(new Date).toISOString()};return this.purchasedHouses.push(r),this.statistics.housePurchases||(this.statistics.housePurchases=[]),this.statistics.housePurchases.push({houseId:e.id,name:e.name,level:e.level,price:e.price,week:i}),null===this.statistics.firstHousePurchaseWeek&&(this.statistics.firstHousePurchaseWeek=i),(!this.statistics.mostExpensiveHouse||e.price>this.statistics.mostExpensiveHouse.price)&&(this.statistics.mostExpensiveHouse={id:e.id,name:e.name,price:e.price,level:e.level,week:i}),(!this.statistics.highestLevelHouse||e.level>this.statistics.highestLevelHouse.level)&&(this.statistics.highestLevelHouse={id:e.id,name:e.name,price:e.price,level:e.level,week:i}),console.log(`成功购买房产: ${e.name} - ¥${e.price} (第${i}周)`),!0},depositToBank(e){return!(e<=0||e>this.money)&&(this.money-=e,this.bankDeposit+=e,!0)},withdrawFromBank(e){return!(e<=0||e>this.bankDeposit)&&(this.bankDeposit-=e,this.money+=e,!0)},takeLoan(e){const t=this.availableLoanAmount;return!(e<=0||e>t)&&(this.debt+=e,this.loanPrincipal+=e,this.money+=e,!0)}},getters:{netWorth:e=>{const t=e.inventory.reduce((e,t)=>e+t.quantity*t.purchasePrice,0),i=e.purchasedHouses.reduce((e,t)=>e+t.purchasePrice,0);return e.money+e.bankDeposit+t+i-e.debt},totalMoney:e=>{const t=e.inventory.reduce((e,t)=>e+t.quantity*t.purchasePrice,0);return e.money+t},hasHighestHouse:e=>e.purchasedHouses.some(e=>e.level>=5),mostExpensiveHouse:e=>0===e.purchasedHouses.length?null:e.purchasedHouses.reduce((e,t)=>t.purchasePrice>e.purchasePrice?t:e,e.purchasedHouses[0]),availableCapacity:e=>e.capacity-e.inventoryUsed,availableLoanAmount:e=>{void 0===e.loanPrincipal&&(e.loanPrincipal=e.debt);const t=e.maxLoanAmount;return Math.max(0,Math.floor(t-e.loanPrincipal))},depositInterestRate:()=>.003,loanInterestRate:()=>.005}}),ie=()=>{const e=te();return{addToInventory:(t,i,r)=>{if(!t||i<=0||r<0)return{success:!1,message:"无效的产品数据"};const o=i;if(e.inventoryUsed+o>e.capacity)return{success:!1,message:"背包容量不足"};const s=e.inventory.findIndex(e=>e.productId===t.id),a=r*i;if(-1!==s){const t=e.inventory[s],o=t.totalValue||t.purchasePrice*t.quantity,a=t.quantity+i,n=o+r*i,c=Math.round(n/a);e.inventory[s].quantity=a,e.inventory[s].purchasePrice=c,e.inventory[s].totalValue=n}else e.inventory.push({productId:t.id,name:t.name,quantity:i,purchasePrice:r,totalValue:a,size:1});return e.inventoryUsed+=o,{success:!0}},removeFromInventory:(t,i)=>{if(t<0||t>=e.inventory.length)return{success:!1,message:"无效的物品索引"};const r=e.inventory[t];if(i<=0||i>r.quantity)return{success:!1,message:"无效的移除数量"};const o=i,s={...r,quantity:i};return r.quantity-=i,r.quantity<=0&&e.inventory.splice(t,1),e.inventoryUsed-=o,{success:!0,product:s}},findByProductId:t=>e.inventory.filter(e=>e.productId===t),getTotalQuantity:t=>e.inventory.filter(e=>e.productId===t).reduce((e,t)=>e+t.quantity,0),getTotalValue:()=>e.inventory.reduce((e,t)=>e+t.quantity*t.purchasePrice,0),clearInventory:()=>{e.inventory=[],e.inventoryUsed=0}}},re="DAILY",oe="FOOD",se="ELECTRONICS",ae="LUXURY",ne="COLLECTIBLE";class ce{constructor({id:e,name:t,description:i="",basePrice:r,minPrice:o,maxPrice:s,volatility:a=5,category:n=re,size:c=1,icon:l="box",availableAt:u=[]}){this.id=e,this.name=t,this.description=i,this.basePrice=r,this.minPrice=o,this.maxPrice=s,this.volatility=Math.min(Math.max(a,1),10),this.category=n,this.size=c,this.icon=l,this.availableAt=u}getPriceRange(){return{min:this.minPrice,max:this.maxPrice,range:this.maxPrice-this.minPrice}}isValidPrice(e){return e>=this.minPrice&&e<=this.maxPrice}adjustPriceToRange(e){return Math.max(this.minPrice,Math.min(e,this.maxPrice))}}const le=[{id:101,name:"卫生纸",description:"日常必备用品",basePrice:15,minPrice:10,maxPrice:30,volatility:2,category:re,size:3,icon:"paper",availableAt:["second_hand_market","commodity_market"]},{id:102,name:"洗发水",description:"日常洗护用品",basePrice:35,minPrice:20,maxPrice:50,volatility:2,category:re,size:1,icon:"bottle",availableAt:["second_hand_market","commodity_market"]},{id:103,name:"牙膏",description:"日常洗护用品",basePrice:8,minPrice:5,maxPrice:15,volatility:2,category:re,size:1,icon:"hygiene",availableAt:["second_hand_market","commodity_market"]},{id:104,name:"肥皂",description:"日常洗护用品",basePrice:6,minPrice:3,maxPrice:12,volatility:2,category:re,size:1,icon:"soap",availableAt:["second_hand_market","commodity_market"]},{id:105,name:"毛巾",description:"日常洗护用品",basePrice:25,minPrice:15,maxPrice:40,volatility:2,category:re,size:2,icon:"towel",availableAt:["second_hand_market","commodity_market"]},{id:106,name:"二手衣物",description:"二手服装，价格便宜但品质一般",basePrice:40,minPrice:20,maxPrice:80,volatility:3,category:re,size:4,icon:"clothes",availableAt:["second_hand_market"]},{id:107,name:"二手家具",description:"二手家具，价格实惠",basePrice:200,minPrice:100,maxPrice:500,volatility:4,category:re,size:10,icon:"furniture",availableAt:["second_hand_market"]},{id:201,name:"鸡蛋",description:"新鲜食品，价格波动较大",basePrice:15,minPrice:8,maxPrice:25,volatility:4,category:oe,size:2,icon:"egg",availableAt:["commodity_market"]},{id:202,name:"大米",description:"主食，价格相对稳定",basePrice:50,minPrice:30,maxPrice:80,volatility:4,category:oe,size:5,icon:"rice",availableAt:["commodity_market"]},{id:203,name:"食用油",description:"烹饪必备，价格波动适中",basePrice:70,minPrice:40,maxPrice:120,volatility:4,category:oe,size:3,icon:"oil",availableAt:["commodity_market"]},{id:204,name:"新鲜蔬菜",description:"时令蔬菜，价格波动较大",basePrice:30,minPrice:15,maxPrice:50,volatility:4,category:oe,size:4,icon:"vegetable",availableAt:["commodity_market"]},{id:205,name:"水果",description:"时令水果，价格波动较大",basePrice:35,minPrice:20,maxPrice:60,volatility:4,category:oe,size:4,icon:"fruit",availableAt:["commodity_market"]},{id:301,name:"手机",description:"智能手机，价格波动适中",basePrice:1800,minPrice:1e3,maxPrice:3e3,volatility:6,category:se,size:1,icon:"phone",availableAt:["electronics_hub","premium_mall"]},{id:302,name:"电视",description:"家用电视，价格波动适中",basePrice:3500,minPrice:2e3,maxPrice:6e3,volatility:6,category:se,size:15,icon:"tv",availableAt:["electronics_hub"]},{id:303,name:"笔记本电脑",description:"便携式电脑，价格波动适中",basePrice:4500,minPrice:3e3,maxPrice:8e3,volatility:6,category:se,size:5,icon:"laptop",availableAt:["electronics_hub"]},{id:304,name:"平板电脑",description:"触屏平板设备，价格波动适中",basePrice:2e3,minPrice:1200,maxPrice:3500,volatility:6,category:se,size:3,icon:"tablet",availableAt:["electronics_hub"]},{id:305,name:"智能手表",description:"可穿戴设备，价格波动较大",basePrice:1500,minPrice:800,maxPrice:2500,volatility:7,category:se,size:1,icon:"watch",availableAt:["electronics_hub","premium_mall"]},{id:401,name:"名牌手表",description:"奢侈品，价格昂贵但保值",basePrice:12e3,minPrice:8e3,maxPrice:2e4,volatility:8,category:ae,size:1,icon:"luxury-watch",availableAt:["premium_mall"]},{id:402,name:"钻石项链",description:"奢侈品，价格昂贵且波动较大",basePrice:15e3,minPrice:1e4,maxPrice:25e3,volatility:8,category:ae,size:1,icon:"diamond",availableAt:["premium_mall"]},{id:403,name:"设计师包包",description:"高档手袋，有一定保值能力",basePrice:8e3,minPrice:5e3,maxPrice:15e3,volatility:7,category:ae,size:2,icon:"bag",availableAt:["premium_mall"]},{id:404,name:"高级香水",description:"知名品牌香水，价格适中",basePrice:1200,minPrice:800,maxPrice:2e3,volatility:5,category:ae,size:1,icon:"perfume",availableAt:["premium_mall"]},{id:501,name:"古董花瓶",description:"收藏品，价格波动非常大",basePrice:9e3,minPrice:4e3,maxPrice:2e4,volatility:9,category:ne,size:4,icon:"vase",availableAt:["black_market"]},{id:502,name:"邮票",description:"收藏邮票，价格波动极大",basePrice:3e3,minPrice:1e3,maxPrice:1e4,volatility:10,category:ne,size:1,icon:"stamp",availableAt:["black_market"]},{id:503,name:"古画",description:"艺术收藏品，价格波动极大",basePrice:2e4,minPrice:1e4,maxPrice:5e4,volatility:10,category:ne,size:8,icon:"painting",availableAt:["black_market"]},{id:504,name:"老式相机",description:"古董相机，收藏价值高",basePrice:4500,minPrice:2e3,maxPrice:1e4,volatility:8,category:ne,size:3,icon:"camera",availableAt:["black_market","electronics_hub"]},{id:505,name:"纪念币",description:"限量发行的纪念币，收藏价值高",basePrice:2500,minPrice:1e3,maxPrice:8e3,volatility:9,category:ne,size:1,icon:"coin",availableAt:["black_market"]}];function ue(){return le.map(e=>new ce(e))}class de{constructor({id:e,name:t,description:i="",availableProducts:r=[],specialProducts:o=[],modifiers:s={priceFactor:1},icon:a="map-marker",image:n="",eventProbability:c=.3}){this.id=e,this.name=t,this.description=i,this.availableProducts=r,this.specialProducts=o,this.modifiers=s,this.icon=a,this.image=n,this.eventProbability=c}getPriceFactor(){return this.modifiers.priceFactor||1}isSpecialProduct(e){return this.specialProducts.includes(e)}hasProduct(e){return this.availableProducts.includes(e)||this.specialProducts.includes(e)}applyPriceModifiers(e,t){let i=e*this.getPriceFactor();return this.isSpecialProduct(t)&&(i*=.85),Math.round(i)}}const me=[{id:"commodity_market",name:"大宗商品交易所",description:"批发市场和大宗商品交易的集中地，价格低廉但需要大量采购。这里适合大量进货获取更好的价格优势。",modifiers:{priceFactor:.75},specialProducts:[202,203],availableProducts:["bulk_rice","bulk_goods","industrial_materials"],eventProbability:.2,icon:"commodity.png",image:"commodity_market.jpg"},{id:"second_hand_market",name:"二手市场",description:"各类二手物品和低价生活必需品的集散地，价格便宜但品质参差不齐。这里是淘宝和囤积日常用品的好地方。",modifiers:{priceFactor:.8},specialProducts:[101,104,106,107],availableProducts:["clothes","toiletries","used_items","furniture"],eventProbability:.3,icon:"second-hand.png",image:"second_hand_market.jpg"},{id:"premium_mall",name:"高端商城",description:"汇聚各类高端品牌和奢侈品的购物中心，价格昂贵但品质优良。这里是购买珠宝、手表等高端商品的地方。",modifiers:{priceFactor:1.3},specialProducts:[401,404],availableProducts:["jewelry","watch","designer_clothes"],eventProbability:.25,icon:"premium.png",image:"premium_mall.jpg"},{id:"electronics_hub",name:"电子科技城",description:"各类电子产品和数码设备的专业交易市场，价格适中且品种齐全。这里是购买手机、电脑等电子产品的理想之地。",modifiers:{priceFactor:.95},specialProducts:[301,305],availableProducts:["phone","laptop","tablet","camera"],eventProbability:.3,icon:"electronics.png",image:"electronics_hub.jpg"},{id:"black_market",name:"地下黑市",description:"隐蔽的非法交易场所，各类珍稀收藏品和奇特商品云集。风险与机遇并存，是寻找稀有物品的绝佳地点。",modifiers:{priceFactor:1.1},specialProducts:[502,503],availableProducts:["stamp","antique","artwork","rare_coin"],eventProbability:.35,icon:"black-market.png",image:"black_market.jpg"}];function pe(){return me.map(e=>new de(e))}class he{constructor({id:e,name:t,price:i,level:r=1,description:o="",specialFeature:s="",purchaseCondition:a="",image:n=""}){this.id=e,this.name=t,this.price=i,this.level=r,this.description=o,this.specialFeature=s,this.purchaseCondition=a||`需要${i}元现金`,this.image=n||function(e){try{return e&&"undefined"!==e&&"null"!==e?Y(e):"/resources/assets/images/house_1.jpeg"}catch(t){console.warn("获取房屋图片路径时出错:",t);const i={apartment:"/resources/assets/images/house_1.jpeg",second_hand:"/resources/assets/images/house_2.jpeg",highend:"/resources/assets/images/house_3.jpeg",villa:"/resources/assets/images/house_4.jpeg",mansion:"/resources/assets/images/house_5.jpeg"};if(!isNaN(parseInt(e))){const t=parseInt(e);return`/resources/assets/images/house_${t?Math.max(1,Math.min(5,t%5||1)):1}.jpeg`}return i[e]||"/resources/assets/images/house_1.jpeg"}}(e)}canBePurchasedWith(e){return e>=this.price}getValueRating(){return this.price<4e5?7:this.price<8e5?6:this.price<15e5?5:this.price<25e5?4:3}}const ge=[{id:"apartment",name:"单身公寓",price:35e4,level:1,description:"适合单身人士居住的小型公寓，位置便利但空间有限。这是迈向房产阶梯的第一步！",specialFeature:"交通便利，月供较低，首次置业的理想选择",image:"/resources/assets/images/house_1.jpeg"},{id:"second_hand",name:"二手旧房",price:58e4,level:2,description:"年代较久的二手住宅，价格适中但可能需要装修。空间较大，非常适合改造成理想的家。",specialFeature:"空间较大，周边配套完善，性价比较高",image:"/resources/assets/images/house_2.jpeg"},{id:"highend",name:"高档小区",price:8e5,level:3,description:"现代化高档住宅小区，环境优美，配套设施齐全。社区环境安全，是家庭居住的绝佳选择。",specialFeature:"环境优美，物业管理完善，社区活动丰富",image:"/resources/assets/images/house_3.jpeg"},{id:"villa",name:"现代别墅",price:15e5,level:4,description:"独栋现代别墅，拥有私家花园和车库。宽敞的空间和精致的设计，彰显主人的品味与地位。",specialFeature:"独立空间，居住品质高，是成功人士的标志",image:"/resources/assets/images/house_4.jpeg"},{id:"mansion",name:"私人庄园",price:3e6,level:5,description:"大型私人庄园，带有大片绿地和多功能区域。拥有这样的房产，代表你已达到人生巅峰！",specialFeature:"终极豪宅，私密性极佳，社会地位的象征",image:"/resources/assets/images/house_5.jpeg"}];function ye(){return ge.map(e=>new he(e))}const ve={RISING_STRONG:"rising_strong",RISING:"rising",STABLE_HIGH:"stable_high",STABLE:"stable",STABLE_LOW:"stable_low",FALLING:"falling",FALLING_STRONG:"falling_strong",VOLATILE:"volatile"},fe=new Map;function be(e){if(0===(e%=2*Math.PI)||e===Math.PI)return 0;if(e===Math.PI/2)return 1;if(e===3*Math.PI/2)return-1;const t=e*e,i=t*e,r=i*t;return e-i/6+r/120-r*t/5040}function ke(e,t,i,r,o){const s=`${e.id}_${t}_${(null==i?void 0:i.price)||0}_${r}_${JSON.stringify(o)}`;if(fe.has(s))return fe.get(s);const a=_e(e,t,i,r,o);return fe.set(s,a),a}function Pe(){fe.clear(),console.log("价格计算缓存已清除")}function _e(e,t,i=null,r=1,o={}){var s,a,n,c,l,u;const d=(null==i?void 0:i.price)||e.basePrice,m=(null==i?void 0:i.trend)||ve.STABLE,p=e.id,h=e.minPrice,g=e.maxPrice,y=e.volatility,v=e.category,f=1023&t,b=.6+.15*y,k={[ve.RISING]:.05,[ve.RISING_STRONG]:.08,[ve.FALLING]:-.12,[ve.FALLING_STRONG]:-.15,[ve.STABLE]:-.01,[ve.STABLE_HIGH]:-.04,[ve.STABLE_LOW]:.02,[ve.VOLATILE]:-.02},P=(1e3*p+t)%997/997,_=Math.random();let E;E=P<.3?_<.75?k[m]||0:.08*(Math.random()-.35):_<.75?k[m]||0:.08*(Math.random()-.65);const S=(()=>{console.log("计算类别周期因子:",{category:v,weekMod:f});let e=0;switch(v){case"DAILY":e=.1*be(.077*f)-.03;break;case"FOOD":e=.2*be(.167*f)-.05;break;case"ELECTRONICS":e=.15*be(.1*f)-.08;break;case"LUXURY":e=.25*be(.067*f)-.03;break;case"COLLECTIBLE":e=.3*be(.125*f)-.04+(.15*Math.cos(.2*f)-.02);break;default:e=0}return e+=.01*(p%10-5),console.log("类别周期因子结果:",e),e})(),M=.12*be(.1*(f+p%10*.1)+.01*(15&p))-.03,w=r||1,L=(null==(s=o.specialProducts)?void 0:s.includes(p))?.8:1,I=.9+.16*(.5*Math.sin(p*t*.01)+.5),x=o.globalPriceModifier||1,W=(null==(a=o.categoryModifiers)?void 0:a[v])||1,A=(null==(n=o.productModifiers)?void 0:n[p])||1,C=o.currentLocationId;let O=1,R=1;C&&(O=(null==(c=o.locationModifiers)?void 0:c[C])||1,(null==(u=null==(l=o.locationProductModifiers)?void 0:l[C])?void 0:u[p])&&(R=o.locationProductModifiers[C][p]),1===O&&1===R||console.log(`应用地区价格修正 - 地区: ${C}, 商品: ${p}, 地区修正: ${O.toFixed(2)}, 地区商品修正: ${R.toFixed(2)}`));const N=b*(1+E)*(1+S)*(1+M)*w*L*I*x*W*A*O*R;let D=N;if(Math.abs(N-1)<.005){D=1+(p*t%2==0?1:-1)*(.005+.01*Math.random()),console.log(`商品 ${p} 价格变化太小，强制调整为 ${(100*(D-1)).toFixed(2)}%`)}let G=d*D;G=function(e,t,i,r){const o=i.volatility/10,s=r.volatilityMultiplier||1,a=.2*(1+o)*s,n=t*(1+a),c=t*(1-a),l=.005*t;if(Math.abs(e-t)<l){e=t*(1+(i.id%2==0?1:-1)*(.005+.01*Math.random()))}let u=Math.max(c,Math.min(e,n));const d=i.minPrice+.5*(i.maxPrice-i.minPrice),m=Math.abs(u-d)/(i.maxPrice-i.minPrice);if(m>.4){const e=u>d?-1:1;u+=.05*(m-.4)*(i.maxPrice-i.minPrice)*e}return u}(G,d,e,o),G=Math.max(h,Math.min(G,g));const T=(G-e.basePrice)/e.basePrice,$=function(e,t,i,r){const o=.05,s=-.15,a=-.05;if(e>.15)return ve.RISING_STRONG;if(e>o)return ve.RISING;if(e<s)return ve.FALLING_STRONG;if(e<a)return ve.FALLING;const n=r-i;if(n<=0)return ve.STABLE;const c=(t-i)/n;return c>.8?ve.STABLE_HIGH:c<.2?ve.STABLE_LOW:ve.STABLE}(T,G,h,g);return{price:Math.round(G),trend:$,changePercent:parseFloat((100*T).toFixed(1)),originalPricePercent:T}}function Ee(e){return{[ve.RISING_STRONG]:"大幅上涨",[ve.RISING]:"上涨",[ve.STABLE_HIGH]:"高位稳定",[ve.STABLE]:"稳定",[ve.STABLE_LOW]:"低位稳定",[ve.FALLING]:"下跌",[ve.FALLING_STRONG]:"大幅下跌",[ve.VOLATILE]:"剧烈波动"}[e]||"未知"}function Se(e){return{[ve.RISING_STRONG]:"↑↑",[ve.RISING]:"↑",[ve.STABLE_HIGH]:"↗",[ve.STABLE]:"→",[ve.STABLE_LOW]:"↘",[ve.FALLING]:"↓",[ve.FALLING_STRONG]:"↓↓",[ve.VOLATILE]:"↕"}[e]||"→"}function Me(e){return{[ve.RISING_STRONG]:"#e53935",[ve.RISING]:"#f44336",[ve.STABLE_HIGH]:"#ff9800",[ve.STABLE]:"#9e9e9e",[ve.STABLE_LOW]:"#8bc34a",[ve.FALLING]:"#4caf50",[ve.FALLING_STRONG]:"#2e7d32",[ve.VOLATILE]:"#9c27b0"}[e]||"#9e9e9e"}const we=()=>{const e=Le();return{updateProductPrices:t=>{console.log("开始更新产品价格，当前周数:",t);const i=e.products;console.log("产品总数:",i.length);const r={...e.productPrices},o=e.marketModifiers;console.log("市场修正因子:",o),Pe();const s=function(e,t,i={},r={}){console.time("BatchPriceUpdate"),r.currentLocation&&(r.currentLocationId=r.currentLocation.id);const o={},s=e.length;console.log(`批量更新价格 - 商品总数: ${s}, 当前周数: ${t}, 市场修正因子:`,{global:r.globalPriceModifier||1,categories:Object.keys(r.categoryModifiers||{}).length,products:Object.keys(r.productModifiers||{}).length,locations:Object.keys(r.locationModifiers||{}).length,locationProducts:Object.keys(r.locationProductModifiers||{}).reduce((e,t)=>e+Object.keys(r.locationProductModifiers[t]||{}).length,0),currentLocationId:r.currentLocationId});for(let n=0;n<s;n++){const s=e[n],c=s.id,l=i[c]||null;try{o[c]=ke(s,t,l,1,r)}catch(a){console.error(`更新商品 ${c} 价格时出错:`,a),o[c]={price:s.basePrice,trend:"stable",changePercent:0}}}return console.timeEnd("BatchPriceUpdate"),o}(i,t,r,o);console.log("批量更新后的新价格数量:",Object.keys(s).length),Object.keys(s).forEach(o=>{var a,n;const c=r[o]||{price:0,history:[]},l=s[o],u=c.price||(null==(a=i.find(e=>e.id===Number(o)))?void 0:a.basePrice)||0;if(!(Math.abs(l.price-u)>=1)||Math.abs(l.changePercent)<1){const e=(31*(parseInt(o)||0)+(t||0))%100,i=e<30?1:-1,r=12*Math.abs(Math.sin(.1*e)),s=Math.max(3,r),a=1+i*s/100;l.price=Math.round(u*a),console.log(`强制价格波动 - 商品ID: ${o}, 原价: ${u}, 新价: ${l.price}, 方向: ${i>0?"上涨":"下跌"}, 变化幅度: ${s.toFixed(1)}%`)}if(0===l.changePercent&&u>0){const e=(null==(n=i.find(e=>e.id===Number(o)))?void 0:n.basePrice)||u;l.changePercent=(l.price-e)/e*100,l.changePercent=parseFloat(l.changePercent.toFixed(1))}e.productPrices[o]={price:l.price,prevPrice:u,trend:l.trend,changePercent:l.changePercent,originalPricePercent:l.originalPricePercent,history:[...c.history||[],l.price].slice(-20)};const d=i.find(e=>e.id===Number(o));if(d){console.log(`商品 ${d.name}(ID:${o}) 价格更新 - 基础价格: ${d.basePrice}, 当前价格: ${l.price}, 历史: [${e.productPrices[o].history.join(", ")}]`);const{trend:t,changePercent:i}=e.calculateLongTermTrend(o,d.basePrice);e.productPrices[o].trend=t,e.productPrices[o].changePercent=i,console.log(`商品 ${d.name}(ID:${o}) 趋势更新 - 趋势: ${t}, 变化百分比: ${i}%`)}}),e.updateLocationProducts(),console.log("价格更新完成")},getProductTrendInfo:t=>{const i=e.getProductPriceTrend(t);return{text:Ee(i),icon:Se(i),color:Me(i)}},getPriceChangeText:t=>{const i=e.productPrices[t];if(!i||void 0===i.changePercent)return"0%";const r=i.changePercent;return`${r>0?"+":""}${r.toFixed(1)}%`},measurePricePerformance:(e,t)=>null,clearPriceCache:Pe}},Le=r("market",{state:()=>({locations:[],currentLocation:null,productPrices:{},products:[],availableProducts:[],houses:[],marketModifiers:{globalPriceModifier:1,categoryModifiers:{},productModifiers:{},locationModifiers:{},locationProductModifiers:{},weeksSinceLastGlobalChange:0,categoryUnchangedWeeks:{},productUnchangedWeeks:{},locationUnchangedWeeks:{},locationProductUnchangedWeeks:{}},initialized:!1}),actions:{initializeMarket(){return new Promise((e,t)=>{try{setTimeout(()=>{this.locations=pe(),this.products=ue(),this.houses=ye(),this.initializeProductPrices(),this.marketModifiers={globalPriceModifier:1,categoryModifiers:{},productModifiers:{},locationModifiers:{},locationProductModifiers:{},weeksSinceLastGlobalChange:0,categoryUnchangedWeeks:{},productUnchangedWeeks:{},locationUnchangedWeeks:{},locationProductUnchangedWeeks:{}},this.locations.length>0&&(this.changeLocation(this.locations[0].id),this.updateLocationProducts()),this.initialized=!0,console.log("MarketStore - 市场初始化完成"),console.log("可用商品数量:",this.availableProducts.length),e()},500)}catch(i){F(i,"marketState (market)",c.UNKNOWN,l.ERROR),console.error("MarketStore - 初始化市场失败:",i),t(i)}})},initializeProductPrices(){this.productPrices={},this.products.forEach(e=>{const t=Math.floor(Math.random()*(e.maxPrice-e.minPrice)+e.minPrice);this.productPrices[e.id]={price:t,trend:ve.STABLE,history:[t],changePercent:0}})},updateMarketState(e){console.log("MarketStore - 更新市场状态, 当前周数:",e),this.updateMarketModifiers();try{const{updateProductPrices:t}=we();if("function"!=typeof t)return void console.error("MarketStore - updateProductPrices 不是一个函数");this.currentLocation&&(this.marketModifiers.currentLocation=this.currentLocation),t(e),console.log("MarketStore - 商品价格已更新")}catch(t){console.error("MarketStore - 更新商品价格时出错:",t)}this.updateLocationProducts()},updateMarketModifiers(){const e=this.marketModifiers;if(console.log("MarketStore - 更新市场调整因子"),e.weeksSinceLastGlobalChange++,e.weeksSinceLastGlobalChange>=Math.max(4,Math.floor(5*Math.random())+4)&&(e.weeksSinceLastGlobalChange=0,Math.random()<.7)){const t=e.globalPriceModifier,i=.2*(Math.random()-.5);e.globalPriceModifier=Math.max(.8,Math.min(1.2,t+i)),console.log(`MarketStore - 全局价格修正因子已更新: ${t.toFixed(2)} -> ${e.globalPriceModifier.toFixed(2)}`)}if(["food","electronics","luxury","daily","collectible"].forEach(t=>{if(e.categoryUnchangedWeeks[t]=(e.categoryUnchangedWeeks[t]||0)+1,e.categoryUnchangedWeeks[t]>=4||Math.random()<.3){e.categoryUnchangedWeeks[t]=0;const i=e.categoryModifiers[t]||1,r=.3*(Math.random()-.5);e.categoryModifiers[t]=Math.max(.7,Math.min(1.3,i+r)),console.log(`MarketStore - ${t}类别价格修正因子已更新: ${i.toFixed(2)} -> ${e.categoryModifiers[t].toFixed(2)}`)}}),Math.random()<.15){const t=Math.floor(3*Math.random())+1,i=Object.keys(this.productPrices);for(let r=0;r<t&&i.length>0;r++){const t=i[Math.floor(Math.random()*i.length)];e.productUnchangedWeeks[t]=0;const r=e.productModifiers[t]||1,o=.6*(Math.random()-.5);e.productModifiers[t]=Math.max(.5,Math.min(1.5,r+o));const s=this.products.find(e=>e.id===Number(t));console.log(`MarketStore - 商品价格修正因子已更新: ${(null==s?void 0:s.name)||t} ${r.toFixed(2)} -> ${e.productModifiers[t].toFixed(2)}`)}}if(Math.random()<.2){const t=Math.floor(2*Math.random())+1,i=this.locations.map(e=>e.id);for(let r=0;r<t&&i.length>0;r++){const t=i[Math.floor(Math.random()*i.length)];e.locationUnchangedWeeks[t]=0;const r=e.locationModifiers[t]||1,o=.4*(Math.random()-.5);e.locationModifiers[t]=Math.max(.6,Math.min(1.4,r+o));const s=this.locations.find(e=>e.id===t);console.log(`MarketStore - 地区价格修正因子已更新: ${(null==s?void 0:s.name)||t} ${r.toFixed(2)} -> ${e.locationModifiers[t].toFixed(2)}`)}}if(Math.random()<.1){const t=this.locations.map(e=>e.id),i=t[Math.floor(Math.random()*t.length)],r=Math.floor(3*Math.random())+1,o=Object.keys(this.productPrices);e.locationProductModifiers[i]||(e.locationProductModifiers[i]={}),e.locationProductUnchangedWeeks[i]||(e.locationProductUnchangedWeeks[i]={});for(let s=0;s<r&&o.length>0;s++){const t=o[Math.floor(Math.random()*o.length)];e.locationProductUnchangedWeeks[i][t]=0;const r=e.locationProductModifiers[i][t]||1,s=.8*(Math.random()-.5);e.locationProductModifiers[i][t]=Math.max(.4,Math.min(1.6,r+s));const a=this.products.find(e=>e.id===Number(t)),n=this.locations.find(e=>e.id===i);console.log(`MarketStore - 地区内商品价格修正因子已更新: ${(null==n?void 0:n.name)||i} 的 ${(null==a?void 0:a.name)||t} ${r.toFixed(2)} -> ${e.locationProductModifiers[i][t].toFixed(2)}`)}}(e.globalPriceModifier<.8||e.globalPriceModifier>1.2)&&(e.globalPriceModifier=1)},changeLocation(e){const t=this.locations.find(t=>t.id===e);return!!t&&(this.currentLocation=t,this.updateLocationProducts(),!0)},updateLocationProducts(){if(console.log("MarketStore - 更新当前地点可用商品"),!this.currentLocation)return console.warn("MarketStore - 更新可用商品失败: 当前地点未设置"),void(this.availableProducts=[]);try{const e=this.getLocationAvailableProducts(this.currentLocation);console.log("MarketStore - 当前地点可用商品ID:",e),this.availableProducts=this.products.filter(t=>e.includes(t.id)).map(e=>{const t=this.getCurrentProductPrice(e.id),i=this.isSpecialProduct(e.id),{trend:r,changePercent:o}=this.calculateLongTermTrend(e.id,e.basePrice);return this.productPrices[e.id]&&(this.productPrices[e.id].trend=r,this.productPrices[e.id].changePercent=o),console.log(`商品 ${e.name} - 价格: ${t}, 趋势: ${r}, 变化百分比: ${o}%`),{...e,currentPrice:t,trend:r,changePercent:o,isSpecial:i}}),console.log(`MarketStore - 更新完成，可用商品数量: ${this.availableProducts.length}`)}catch(e){F(e,"marketState (market)",c.UNKNOWN,l.ERROR),console.error("MarketStore - 更新当前地点可用商品时出错:",e),this.availableProducts=[]}},calculateLongTermTrend(e,t){const i=this.productPrices[e];if(!i||!i.history||0===i.history.length)return console.log(`商品 ${e} 没有价格历史数据，使用默认趋势`),{trend:ve.STABLE,changePercent:0};const r=i.history,o=r[r.length-1],s=(o-t)/t*100;let a;if(console.log(`商品 ${e} 趋势计算 - 基础价格: ${t}, 当前价格: ${o}, 历史记录: [${r.join(", ")}], 变化百分比: ${s.toFixed(1)}%`),s>15)a=ve.RISING_STRONG;else if(s>5)a=ve.RISING;else if(s<-15)a=ve.FALLING_STRONG;else if(s<-5)a=ve.FALLING;else{const t=this.products.find(t=>t.id===Number(e));if(t){const i=t.minPrice,r=t.maxPrice,s=r-i;if(s<=0)console.log(`商品 ${e} 价格范围为0，使用默认趋势`),a=ve.STABLE;else{const t=(o-i)/s;console.log(`商品 ${e} 相对位置计算 - 最低价: ${i}, 最高价: ${r}, 相对位置: ${(100*t).toFixed(1)}%`),a=t>.8?ve.STABLE_HIGH:t<.2?ve.STABLE_LOW:ve.STABLE}}else console.log(`商品 ${e} 未找到产品信息，使用默认趋势`),a=ve.STABLE}if(r.length>=3){const t=r.slice(-3),i=this.calculateVolatility(t);console.log(`商品 ${e} 波动性计算 - 最近价格: [${t.join(", ")}], 波动性: ${i.toFixed(3)}`),i>.1&&(a=ve.VOLATILE)}return console.log(`商品 ${e} 最终趋势: ${a}, 变化百分比: ${s.toFixed(1)}%`),{trend:a,changePercent:parseFloat(s.toFixed(1))}},calculateVolatility(e){if(!e||e.length<2)return 0;let t=0;for(let i=1;i<e.length;i++){const r=e[i-1],o=e[i];if(r>0){t+=Math.abs((o-r)/r)}}return t/(e.length-1)},getLocationAvailableProducts(e){if(!e)return[];try{const t=this.products.filter(t=>t.availableAt&&t.availableAt.includes(e.id)).map(e=>e.id);return e.specialProducts&&e.specialProducts.length>0&&e.specialProducts.forEach(e=>{t.includes(e)||t.push(e)}),t}catch(t){return console.error("获取地点可用商品列表出错:",t),[]}},isSpecialProduct(e){return!(!this.currentLocation||!this.currentLocation.specialProducts)&&this.currentLocation.specialProducts.includes(e)},getCurrentProductPrice(e){if(!e)return console.warn(`MarketStore - getCurrentProductPrice: 无效的商品ID: ${e}`),0;const t=String(e);if(!this.productPrices||!this.productPrices[t]){console.warn(`MarketStore - getCurrentProductPrice: 找不到商品价格 (ID: ${t})`);const e=this.products.find(e=>String(e.id)===t);return e?(console.log(`MarketStore - 使用商品基础价格: ${e.basePrice}`),e.basePrice||0):0}return this.productPrices[t].price||0},getProductPriceHistory(e){var t;return(null==(t=this.productPrices[e])?void 0:t.history)||[]},getProductPriceTrend(e){var t;return(null==(t=this.productPrices[e])?void 0:t.trend)||ve.STABLE},addMarketModifier(e,t){switch(e){case"global":this.marketModifiers.globalPriceModifier=t.value;break;case"category":this.marketModifiers.categoryModifiers[t.category]=t.value;break;case"product":this.marketModifiers.productModifiers[t.productId]=t.value;break;case"location":this.marketModifiers.locationModifiers[t.locationId]=t.value;break;case"locationProduct":this.marketModifiers.locationProductModifiers[t.locationId]||(this.marketModifiers.locationProductModifiers[t.locationId]={}),this.marketModifiers.locationProductModifiers[t.locationId][t.productId]=t.value}},loadProducts(e){if(console.log("MarketStore - 加载产品数据:",e),Array.isArray(e)){if(0===this.products.length&&(this.products=ue()),e.length>0&&"string"==typeof e[0]){const t=ue();this.products=t.filter(t=>e.includes(t.id)),console.log("MarketStore - 已加载指定产品:",this.products.length)}this.updateLocationProducts()}else console.warn("MarketStore - 加载产品数据时传入的不是数组:",e)},loadHouses(e){if(console.log("MarketStore - 加载房屋数据:",e),Array.isArray(e)){if(0===this.houses.length&&(this.houses=ye()),e.length>0&&"string"==typeof e[0]){const t=ye();this.houses=t.filter(t=>e.includes(t.id)),console.log("MarketStore - 已加载指定房屋:",this.houses.length)}}else console.warn("MarketStore - 加载房屋数据时传入的不是数组:",e)}},getters:{availableHouses:e=>e.houses,currentLocationInfo:e=>e.currentLocation?{id:e.currentLocation.id,name:e.currentLocation.name,description:e.currentLocation.description,modifiers:e.currentLocation.modifiers,hasSpecialProducts:e.currentLocation.specialProducts&&e.currentLocation.specialProducts.length>0}:null,marketStatus(e){const t=e.marketModifiers.globalPriceModifier;let i="neutral";t>1.1?i="bull":t<.9&&(i="bear");const r=e.products.filter(t=>e.productPrices[t.id]),o=r.filter(t=>(e.productPrices[t.id].price-t.minPrice)/(t.maxPrice-t.minPrice)>.7),s=r.filter(t=>(e.productPrices[t.id].price-t.minPrice)/(t.maxPrice-t.minPrice)<.3);return{status:i,globalModifier:t,highPriceProductsRatio:r.length>0?o.length/r.length:0,lowPriceProductsRatio:r.length>0?s.length/r.length:0,activeModifiersCount:Object.keys(e.marketModifiers.categoryModifiers).length+Object.keys(e.marketModifiers.productModifiers).length}}}}),Ie="random",xe="story",We="location",Ae="market",Ce="personal",Oe="tutorial";let Re=class{constructor({id:e,title:t,description:i,options:r=[],conditions:o={},repeatable:s=!1,type:a=Ie,weight:n=1,imageUrl:c=null}){this.id=e,this.title=t,this.description=i,this.options=r,this.conditions=o,this.repeatable=s,this.type=a,this.weight=n,this.imageUrl=null}canTrigger(e,t=[]){var i,r;const o=this.conditions;if(!this.repeatable&&t.includes(this.id))return!1;if(null!==o.minWeek&&e.currentWeek<o.minWeek)return!1;if(null!==o.maxWeek&&e.currentWeek>o.maxWeek)return!1;if(null!==o.locations&&!o.locations.includes(null==(i=e.currentLocation)?void 0:i.id))return!1;if(null!==o.playerMoney){const t=e.player.money;if(void 0!==o.playerMoney.min&&t<o.playerMoney.min)return!1;if(void 0!==o.playerMoney.max&&t>o.playerMoney.max)return!1}if(null!==o.playerDebt){const t=e.player.debt;if(void 0!==o.playerDebt.min&&t<o.playerDebt.min)return!1;if(void 0!==o.playerDebt.max&&t>o.playerDebt.max)return!1}if(null!==o.inventoryItems)for(const s of o.inventoryItems){const t=e.player.inventory.find(e=>e.productId===s.productId),i=t?t.quantity:0;if(void 0!==s.minQuantity&&i<s.minQuantity)return!1;if(void 0!==s.maxQuantity&&i>s.maxQuantity)return!1}if(null!==o.attributes)for(const[s,a]of Object.entries(o.attributes)){const t=(null==(r=e.player.attributes)?void 0:r[s])||0;if(void 0!==a.min&&t<a.min)return!1;if(void 0!==a.max&&t>a.max)return!1}if(null!==o.requiredEvents)for(const s of o.requiredEvents)if(!t.includes(s))return!1;if(null!==o.excludedEvents)for(const s of o.excludedEvents)if(t.includes(s))return!1;return!(null!==o.customCondition&&!o.customCondition(e))&&Math.random()<=(o.probability||1)}getAvailableOptions(e){return this.options.filter(t=>null===t.condition||t.condition(e))}};class Ne{constructor({text:e,result:t,effects:i,condition:r=null}){this.text=e,this.result=t,this.effects=i,this.condition=r}isAvailable(e){return null===this.condition||this.condition(e)}}class De{constructor({money:e=0,debt:t=0,inventory:i=[],attributes:r={},market:o=null,forceLocationChange:s=!1,targetLocation:a=null,capacity:n=0,nextEvent:c=null,gameState:l=null}){this.money=e,this.debt=t,this.inventory=i,this.attributes=r,this.market=o,this.forceLocationChange=s,this.targetLocation=a,this.capacity=n,this.nextEvent=c,this.gameState=l}}class Ge{constructor({minWeek:e=null,maxWeek:t=null,locations:i=null,probability:r=1,playerMoney:o=null,playerDebt:s=null,inventoryItems:a=null,attributes:n=null,requiredEvents:c=null,excludedEvents:l=null,customCondition:u=null}){this.minWeek=e,this.maxWeek=t,this.locations=i,this.probability=r,this.playerMoney=o,this.playerDebt=s,this.inventoryItems=a,this.attributes=n,this.requiredEvents=c,this.excludedEvents=l,this.customCondition=u}}function Te(e){if("object"!=typeof e||Array.isArray(e)){const[e,t,i,r,o,s,a,n,c]=arguments;return new Re({id:e,title:t,description:i,options:r,conditions:o,repeatable:s,type:a,weight:n,imageUrl:c})}return new Re(e)}const $e=(e,t,i,r=null)=>new Ne({text:e,result:t,effects:i,condition:r}),je=e=>new De(e),He=e=>new Ge(e),Fe=[Te("market_boom","局部市场繁荣","最新经济报道：高端商城和电子科技城迎来消费热潮，商品价格普遍上涨！这可能是调整购买策略的好时机。",[$e("抓住机会在热门地区采购","你决定前往这些繁荣地区采购更多商品，希望能从价格波动中获益。",je({market:{locationModifiers:{premium_mall:1.25,electronics_hub:1.15},duration:2}})),$e("观望市场走势","你决定保持观望态度，不做任何特别的操作。",je({})),$e("趁高价出售相关库存商品","你决定利用这些地区价格上涨的机会出售一些库存商品。",je({market:{locationModifiers:{premium_mall:1.2,electronics_hub:1.1},duration:1}}),e=>e.player.inventoryUsed>0)],He({minWeek:5,probability:.2}),!0,Ae,1.5,"/assets/images/events/market_boom.jpg"),Te("market_crash","局部市场崩盘","突发消息：二手市场和地下黑市爆发安全事件，导致这些地区交易萎缩，商品价格大幅下跌！你需要决定是否利用这次低价机会。",[$e("抄底购买","你决定趁低价前往受影响地区大量购入商品，希望能在价格回升时获利。",je({market:{locationModifiers:{second_hand_market:.65,black_market:.7},duration:3}})),$e("等待市场稳定","你决定等待市场稳定后再行动，避免在动荡时期冒险。",je({})),$e("提前卖出持有商品","你担心其他地区也会受影响，决定立即出售部分商品减少可能的损失。",je({market:{locationModifiers:{second_hand_market:.75,black_market:.8},duration:1}}),e=>e.player.inventoryUsed>0)],He({minWeek:10,probability:.15}),!0,Ae,1.5,"/assets/images/events/market_crash.jpg"),Te("lucky_money","意外之财","你在路上捡到了一个钱包，里面有一些现金和失主的联系方式。这是个考验你诚信的时刻。",[$e("归还钱包","你联系了失主并归还了钱包，对方非常感谢并给了你500元酬金。",je({money:500,attributes:{creditRating:1,reputation:1}})),$e("据为己有","你决定把钱包里的钱据为己有，获得了2000元，但感到有些愧疚。",je({money:2e3,attributes:{creditRating:-2,reputation:-2}}))],He({probability:.1,minWeek:3}),!1,Ce,1,"/assets/images/events/lucky_money.jpg"),Te("health_problem","健康问题","你突然感到身体不适，医生建议你及时就医。不及时处理可能会影响到你的日常工作和生活。",[$e("立即就医","你选择立即去医院检查治疗，花费了一些医疗费，但迅速恢复了健康。",je({money:-800,attributes:{health:1}})),$e("暂时忍耐","你决定先忍着，希望症状会自行好转，省下医疗费用。但这导致你的健康状况有所下降。",je({attributes:{health:-1}})),$e("寻求中药调理","你选择购买一些中药进行调理，花费较少但效果温和。",je({money:-300,attributes:{health:.5}}))],He({probability:.15,minWeek:8}),!0,Ce,1,"/assets/images/events/health_problem.jpg"),Te("market_raid","黑市突袭","警方突然突袭了地下黑市！所有人都在慌乱中逃窜，你需要快速做出决定。",[$e("迅速离开","你迅速逃离了现场，虽然没能完成交易，但避免了不必要的麻烦。",je({forceLocationChange:!0,targetLocation:"commodity_market"})),$e("冒险完成交易","你冒险留下来完成交易，获得了低价商品，但差点被执法人员抓住。",je({market:{globalPriceModifier:.6,duration:1},attributes:{businessSkill:1,risk_tolerance:1}}))],He({locations:["black_market"],probability:.25}),!0,We,1.5,"/assets/images/events/market_raid.jpg"),Te("celebrity_appearance","名人现身","一位知名明星在高端商城现身购物，引起一阵轰动。人流激增，商家纷纷调高价格。",[$e("趁机提高售价","你抓住机会在附近设摊，以略高的价格出售商品，赚了一笔。",je({money:1500,market:{globalPriceModifier:1.2,duration:1}})),$e("尝试接近名人","你试图接近名人获取合影，结果不小心被保安推搡，手机摔坏了。",je({money:-500}))],He({locations:["premium_mall"],probability:.2}),!0,We,1,"/assets/images/events/celebrity.jpg"),Te("debt_relief","债务减免","银行推出了债务重组计划，你收到了参与机会。这可能是减轻债务负担的好机会。",[$e("申请参与","你成功申请了债务减免计划，债务减少了20%。",je({debt:-.2})),$e("放弃机会","你认为这可能有隐藏条款，决定放弃这个机会。",je({}))],He({minWeek:15,playerDebt:{min:5e3},probability:.3}),!1,Ce,1,"/assets/images/events/debt_relief.jpg"),Te("electronics_discount","电子产品促销","电子产品市场推出大规模促销活动，价格大幅下降！这是囤积电子产品的好时机。",[$e("购买电子产品","你趁机购买了一些电子产品，价格比平时便宜很多。",je({market:{categoryModifier:"ELECTRONICS",modifier:.7,duration:2}})),$e("不感兴趣","你对电子产品不感兴趣，决定忽略这次促销。",je({}))],He({probability:.15,minWeek:5}),!0,Ae,1,"/assets/images/events/electronics_sale.jpg"),Te("luxury_tax","奢侈品征税","政府宣布对奢侈品征收额外税费，导致奢侈品价格全面上涨。",[$e("提前囤货","你决定在税收政策实施前囤积一些奢侈品，以备后续高价出售。",je({market:{categoryModifier:"LUXURY",modifier:1.1,duration:1},nextEvent:"luxury_tax_aftermath"})),$e("观望市场","你决定等待看看市场如何反应，避免做出冒险决策。",je({market:{categoryModifier:"LUXURY",modifier:1.3,duration:4}}))],He({probability:.1,minWeek:12,excludedEvents:["luxury_tax","luxury_tax_aftermath"]}),!1,Ae,1,"/assets/images/events/luxury_tax.jpg"),Te("luxury_tax_aftermath","奢侈品价格飙升","奢侈品征税政策正式实施，市场价格如预期般大幅上涨。你之前的准备是否充分？",[$e("高价出售囤货","你将之前囤积的奢侈品以高价出售，获得了可观利润。",je({money:3e3,market:{categoryModifier:"LUXURY",modifier:1.4,duration:3}}),e=>e.player.inventory.some(t=>{const i=e.products.find(e=>e.id===t.productId);return i&&"LUXURY"===i.category})),$e("继续持有","你认为价格还会进一步上涨，决定继续持有囤积的商品。",je({market:{categoryModifier:"LUXURY",modifier:1.3,duration:3}}))],He({requiredEvents:["luxury_tax"]}),!1,Ae,1,"/assets/images/events/luxury_price_rise.jpg"),Te("storage_expansion","存储空间扩展","你发现一个可以扩展背包容量的好机会，但需要投入一些资金。",[$e("购买新背包","你花钱购买了一个更大的背包，提升了存储容量。",je({money:-1500,capacity:20})),$e("租用仓库空间","你租了一个小型仓库空间，花费较低但容量提升有限。",je({money:-500,capacity:10})),$e("放弃机会","你认为当前容量够用，决定节约资金不进行扩展。",je({}))],He({probability:.15,minWeek:10,playerMoney:{min:500},inventoryUsed:{min:.7}}),!0,Ce,1,"/assets/images/events/storage_expansion.jpg"),Te("tutorial_trading","交易入门","欢迎来到《买房记》！在这个游戏中，你的目标是通过买卖商品赚取差价，最终积累足够的资金购买理想的房产。",[$e("了解基本交易","你学习了基本的交易知识，明白了如何在不同地点之间买卖商品赚取差价。",je({nextEvent:"tutorial_market"}))],He({minWeek:1,maxWeek:1}),!1,Oe,1,"/assets/images/events/tutorial.jpg"),Te("tutorial_market","市场解析","不同地点的商品价格会有差异，同时还会随时间波动。关注价格趋势是获利的关键！",[$e("继续学习","你了解了价格趋势系统，以及如何利用价格波动获利。",je({nextEvent:"tutorial_goal"}))],He({requiredEvents:["tutorial_trading"]}),!1,Oe,1,"/assets/images/events/tutorial_market.jpg"),Te("tutorial_goal","游戏目标","游戏中你有52周的时间来积累财富。最终目标是购买一套理想住房，房屋种类从便宜的小公寓到豪华别墅不等。祝你好运！",[$e("开始游戏","你已经了解了游戏的基本规则，现在可以开始你的买房之旅了！",je({attributes:{businessSkill:1}}))],He({requiredEvents:["tutorial_market"]}),!1,Oe,1,"/assets/images/events/tutorial_goal.jpg"),Te("unexpected_inheritance","意外继承","你收到一份律师函，一位远房亲戚去世后将一笔资金留给了你。这是个意外之喜！",[$e("接受继承","你接受了这笔意外之财，获得了一笔可观的资金。",je({money:5e3,attributes:{happiness:1}})),$e("捐赠一部分","你决定将一部分继承的钱捐给慈善机构，感觉心情舒畅。",je({money:3500,attributes:{happiness:2,reputation:2}}))],He({probability:.05,minWeek:15}),!1,Ce,.8,"/assets/images/events/inheritance.jpg"),Te("business_training","商业培训","你发现一个商业技能培训班的广告，参加可能会提升你的交易能力，但需要付出一定费用和时间。",[$e("参加培训","你投入时间和金钱参加了培训，商业技能得到了提升。",je({money:-1e3,attributes:{businessSkill:2}})),$e("自学商业知识","你决定通过书籍和网络自学商业知识，花费较少但效果有限。",je({money:-200,attributes:{businessSkill:1}})),$e("忽略这个机会","你认为实践出真知，决定把时间和金钱用在实际交易上。",je({}))],He({probability:.15,minWeek:4,playerMoney:{min:1e3}}),!0,Ce,1,"/assets/images/events/business_training.jpg"),Te("social_networking","社交机会","你被邀请参加一个商业人士的社交聚会，这可能是结识人脉、获取信息的好机会。",[$e("积极参与","你在聚会上积极社交，结识了几位有价值的商业伙伴，获得了一些市场内幕。",je({money:-300,attributes:{socialSkill:1,businessSkill:.5},market:{insiderInfo:!0,duration:2}})),$e("简单出席","你低调地参加了聚会，没有特别的收获，但也开阔了眼界。",je({money:-300,attributes:{socialSkill:.5}})),$e("婉拒邀请","你因为忙于其他事务婉拒了邀请，错过了这次社交机会。",je({}))],He({probability:.12,minWeek:8,playerMoney:{min:300}}),!0,Ce,1,"/assets/images/events/social_networking.jpg"),Te("investment_opportunity","投资机会","一个朋友向你推荐了一个小型创业公司的投资机会，声称有高回报，但风险未知。",[$e("大笔投资","你决定投入一大笔资金，希望获得高回报。",je({money:-4e3,nextEvent:"investment_result_big"})),$e("小额投资","你谨慎地投入一小笔资金，降低可能的风险。",je({money:-1500,nextEvent:"investment_result_small"})),$e("拒绝投资","你对这个机会持怀疑态度，决定不冒险投资。",je({}))],He({probability:.1,minWeek:20,playerMoney:{min:4e3}}),!1,Ce,1,"/assets/images/events/investment_opportunity.jpg"),Te("investment_result_big","投资结果","几周后，你投资的创业公司有了新进展...",[$e("查看结果","你满怀期待地查看投资结果...",je({money:Math.random()>.3?8e3:-2e3,attributes:{businessSkill:1}}))],He({requiredEvents:["investment_opportunity"]}),!1,Ce,1,"/assets/images/events/investment_result.jpg"),Te("investment_result_small","投资结果","几周后，你投资的创业公司有了新进展...",[$e("查看结果","你满怀期待地查看投资结果...",je({money:Math.random()>.2?2500:-500,attributes:{businessSkill:.5}}))],He({requiredEvents:["investment_opportunity"]}),!1,Ce,1,"/assets/images/events/investment_result.jpg"),Te("clothing_fashion_trend","时尚潮流","一股新的时尚潮流席卷全城，服装类产品的需求突然增加！",[$e("囤积服装类商品","你预见到这是一个商机，决定大量购入服装类商品。",je({market:{categoryModifier:"CLOTHING",modifier:1.3,duration:3}})),$e("观望市场变化","你对时尚潮流持观望态度，决定继续关注市场变化再做决定。",je({})),$e("出售现有服装库存","你决定趁机出售手中的服装类商品，获得一定利润。",je({money:800}),e=>e.player.inventory.some(t=>{const i=e.products.find(e=>e.id===t.productId);return i&&"CLOTHING"===i.category}))],He({probability:.15,minWeek:4}),!0,Ae,1,"/assets/images/events/fashion_trend.jpg"),Te("food_shortage","食品短缺","由于恶劣天气影响，市场上出现了食品短缺的情况，价格开始上涨。",[$e("大量购入食品","你预计价格会进一步上涨，决定趁现在大量购入食品类商品。",je({market:{categoryModifiers:{FOOD:1.4},productModifiers:{201:1.6,202:1.5,204:1.7},duration:4}})),$e("寻找替代食品来源","你开始寻找替代的食品来源，避免受到价格波动的影响。",je({market:{categoryModifiers:{FOOD:1.2},productModifiers:{201:1.3,202:1.25},duration:2}}))],He({probability:.12,minWeek:8,excludedEvents:["food_shortage"]}),!0,Ae,1,"/assets/images/events/food_shortage.jpg"),Te("tech_innovation","科技创新","一项突破性的科技创新引起了市场关注，相关电子产品需求激增。",[$e("投资科技产品","你决定购入一批最新的科技产品，希望能够获得高额利润。",je({market:{categoryModifiers:{ELECTRONICS:1.25},productModifiers:{301:1.4,303:1.35,305:1.45},locationModifiers:{electronics_hub:1.15},duration:3}})),$e("继续关注传统产品","你认为科技创新只是短期效应，决定继续专注于传统产品。",je({market:{productModifiers:{301:1.2,305:1.25},duration:2}}))],He({probability:.15,minWeek:6}),!0,Ae,1,"/assets/images/events/tech_innovation.jpg"),Te("supply_chain_disruption","供应链中断","全球供应链出现严重中断，多种商品的供应受到影响，价格开始波动。",[$e("囤积受影响商品","你决定趁价格还未大幅上涨前，囤积一批受影响的商品。",je({market:{globalPriceModifier:1.15,duration:5}})),$e("转向本地产品","你决定转向采购本地生产的商品，减少对全球供应链的依赖。",je({market:{globalPriceModifier:1.1,duration:3}})),$e("延迟采购计划","你决定暂时延迟采购计划，等待供应链恢复正常。",je({nextEvent:"supply_chain_recovery"}))],He({probability:.1,minWeek:15}),!1,Ae,1.2,"/assets/images/events/supply_chain.jpg"),Te("supply_chain_recovery","全球供应链逐步恢复","经过一段时间的调整，全球供应链开始逐步恢复，但不同地区和商品的恢复速度存在显著差异。",[$e("把握恢复机会","你分析了市场恢复趋势，决定有选择地投资于价格开始恢复正常的商品。",je({market:{globalPriceModifier:.95,locationModifiers:{commodity_market:.9,electronics_hub:1.1,black_market:.85},locationProductModifiers:{commodity_market:{202:.85,203:.9},electronics_hub:{301:1.2,305:1.15},black_market:{502:.7,503:.75}},duration:3}})),$e("稳健策略","你决定采取稳健策略，平衡调整你的库存和交易计划。",je({market:{globalPriceModifier:.98,locationModifiers:{commodity_market:.95,premium_mall:.95,second_hand_market:.95},duration:2}}))],He({requiredEvents:["supply_chain_disruption","old_supply_chain_disruption"]}),!1,Ae,1,"/assets/images/events/supply_recovery.jpg"),Te("seasonal_sales","季节性促销","年度大促销活动开始了，各大商家纷纷降价吸引顾客。这是囤货的好时机！",[$e("大量采购","你决定利用促销活动大量采购各类商品，为未来的销售做准备。",je({market:{globalPriceModifier:.75,duration:2}})),$e("选择性采购","你有选择地购买一些特价商品，避免资金过度占用。",je({market:{globalPriceModifier:.85,duration:1}})),$e("跳过促销","你认为促销商品质量可能不高，决定跳过这次活动。",je({}))],He({probability:.2,minWeek:12,maxWeek:40}),!0,Ae,1,"/assets/images/events/seasonal_sales.jpg"),Te("market_discount","大宗交易优惠","大宗商品交易所今天推出特别优惠，所有商品都有额外折扣！",[$e("大量采购","你决定利用这个机会大量采购各类商品，为未来的销售做准备。",je({market:{locationModifiers:{commodity_market:.8},categoryModifiers:{FOOD:.75,DAILY:.7},productModifiers:{201:.6,202:.65,101:.6},duration:1},forceLocationChange:!0,targetLocation:"commodity_market"})),$e("有选择地购买","你仔细挑选，只购买那些真正划算的商品。",je({market:{locationModifiers:{commodity_market:.9},productModifiers:{202:.7,203:.75},duration:1},forceLocationChange:!0,targetLocation:"commodity_market"})),$e("放弃此次机会","你觉得价格优惠幅度不够大，决定不参与此次优惠活动。",je({market:{locationModifiers:{commodity_market:.95},duration:1}}))],He({locations:["commodity_market"],probability:.25}),!0,We,1,"/assets/images/events/wholesale_discount.jpg"),Te("mall_event","商城名人活动","高端商城举办了一场名人见面会，吸引了大量人流。商场内的商品价格临时上调。",[$e("趁机设摊销售","你在商城外设置临时摊位，利用人流量增加销售额。",je({money:1200,inventory:[{productId:"random",quantity:-5}]}),e=>e.player.inventoryUsed>=5),$e("避开人群","你决定避开拥挤的人群，改天再来购物。",je({forceLocationChange:!0}))],He({locations:["premium_mall"],probability:.2}),!0,We,1,"/assets/images/events/mall_celebrity.jpg"),Te("electronics_expo","电子科技城展销会","电子科技城举办大型数码产品展销会，最新款手机和智能手表都有特别优惠！这是采购电子产品的绝佳时机。",[$e("参观展会","你花费一些时间参观展销会，了解最新的科技趋势。",je({money:-100,market:{locationModifiers:{electronics_hub:.95},duration:1}})),$e("采购特价电子产品","你决定投资购买展会上的特价手机和智能手表，期望能在价格上涨前转售获利。",je({money:-2e3,market:{locationProductModifiers:{electronics_hub:{301:.7,305:.75}},duration:2}}),e=>e.player.money>=2e3)],He({locations:["electronics_hub"],probability:.3}),!0,We,1,"/assets/images/events/electronics_expo.jpg"),Te("market_inspection","市场检查","市场管理人员突然来到折扣市场进行检查，查验摊位合规性！你需要快速决定如何应对。",[$e("配合检查","你主动配合检查，展示自己的合规经营，获得了管理人员的好感。",je({money:-50,attributes:{businessSkill:1}})),$e("暂时离场","你决定暂时收摊离场，避开这次检查，但损失了一天的生意。",je({money:-300,attributes:{businessSkill:-1}}))],He({locations:["discount_market"],probability:.25}),!0,We,1,"/assets/images/events/market_inspection.jpg"),Te("business_competition","商业竞赛","当地举办了一场商业技能竞赛，测试参赛者的商业头脑和决策能力。这可能是展示你实力的好机会！",[$e("全力参赛","你决定全力以赴参加比赛，希望能获得好名次。",je({money:e=>{const t=e.player.attributes.businessSkill||0;return t>=8?5e3:t>=5?2e3:t>=3?500:0},attributes:{businessSkill:1,reputation:1}})),$e("随便参与","你抱着学习的态度参加比赛，不期望获奖。",je({money:200,attributes:{businessSkill:.5}})),$e("放弃参赛","你认为自己还没准备好，决定放弃这次比赛机会。",je({}))],He({probability:.08,minWeek:25}),!1,Ce,1,"/assets/images/events/business_competition.jpg"),Te("market_insider_info","内幕消息","你的一个朋友透露给你一个市场内幕消息，暗示某类商品即将大涨价。这可能是一个发财的好机会！",[$e("相信消息并行动","你相信这个内幕消息，决定投入大量资金购买相关商品。",je({nextEvent:"insider_info_result"})),$e("小规模试水","你不确定消息的可靠性，决定小规模投资以降低风险。",je({nextEvent:"insider_info_result_small"})),$e("忽略消息","你对这种内幕消息持怀疑态度，决定不采取任何行动。",je({}))],He({probability:.1,minWeek:15,playerMoney:{min:3e3}}),!1,Ae,1,"/assets/images/events/insider_info.jpg"),Te("insider_info_result","内幕消息结果","一周后，你等待看到内幕消息的结果...",[$e("查看结果","你满怀期待地查看市场变化。",je({market:Math.random()>.3?{categoryModifier:["LUXURY","ELECTRONICS","CLOTHING"][Math.floor(3*Math.random())],modifier:1.8,duration:2}:{globalPriceModifier:.9,duration:1}}))],He({requiredEvents:["market_insider_info"]}),!1,Ae,1,"/assets/images/events/insider_result.jpg"),Te("insider_info_result_small","内幕消息小规模试水结果","一周后，你等待看到内幕消息的结果...",[$e("查看结果","你查看小规模投资的结果。",je({market:Math.random()>.3?{categoryModifier:["LUXURY","ELECTRONICS","CLOTHING"][Math.floor(3*Math.random())],modifier:1.5,duration:1}:{globalPriceModifier:.95,duration:1}}))],He({requiredEvents:["market_insider_info"]}),!1,Ae,1,"/assets/images/events/insider_result.jpg"),Te("real_estate_opportunity","房产机会","你偶然听说有一处房产即将以低于市场价的价格出售，这可能是一个难得的买房机会。",[$e("立即考察","你决定立即去考察这处房产，看看是否值得购买。",je({nextEvent:"real_estate_inspection"})),$e("咨询专业人士","你决定先咨询一位房产专家，获取专业意见。",je({money:-500,nextEvent:"real_estate_expert_advice"}),e=>e.player.money>=500),$e("忽略这个消息","你认为目前还没有准备好购房，决定忽略这个消息。",je({}))],He({probability:.1,minWeek:30,playerMoney:{min:5e4}}),!1,xe,1,"/assets/images/events/real_estate_opportunity.jpg"),Te("real_estate_inspection","房产考察","你仔细考察了这处房产，发现它确实低于市场价，但需要一些维修。",[$e("以优惠价购买","你决定抓住这个机会，以优惠价格购买这处房产。",je({money:-6e4,attributes:{housingValue:8e4}}),e=>e.player.money>=6e4),$e("继续等待更好的机会","你认为这处房产不够完美，决定继续等待更好的机会。",je({}))],He({requiredEvents:["real_estate_opportunity"]}),!1,xe,1,"/assets/images/events/real_estate_inspection.jpg"),Te("real_estate_expert_advice","专家建议","房产专家仔细分析后告诉你，这处房产位置很好，但维修成本可能比预期高。",[$e("接受建议并购买","你接受专家建议并决定购买这处房产，同时为维修预留资金。",je({money:-65e3,attributes:{housingValue:85e3}}),e=>e.player.money>=65e3),$e("放弃这次机会","专家的分析让你意识到风险，你决定放弃这次购房机会。",je({}))],He({requiredEvents:["real_estate_opportunity"]}),!1,xe,1,"/assets/images/events/real_estate_expert.jpg"),Te("housing_market_boom","房市繁荣","最近房地产市场异常火爆，房价普遍上涨。现在可能是购房或出售现有房产的好时机。",[$e("抓紧购房","你认为房价还会继续上涨，决定趁现在抓紧购房。",je({market:{houseMarketModifier:1.1,duration:4}})),$e("出售现有房产","你决定趁房价高点出售现有房产，获得可观利润。",je({money:e=>1.15*(e.player.attributes.housingValue||0),attributes:{housingValue:0}}),e=>e.player.attributes.housingValue>0),$e("观望市场","你认为目前房价过高，可能是泡沫，决定继续观望。",je({}))],He({probability:.1,minWeek:35}),!0,Ae,1,"/assets/images/events/housing_boom.jpg"),Te("housing_market_crash","房市崩盘","突发经济危机导致房地产市场急剧降温，房价开始下跌。这可能是低价购入的机会，也可能带来风险。",[$e("逆势购房","你认为这是难得的低价购房机会，决定逆势而上。",je({market:{houseMarketModifier:.8,duration:3}})),$e("观望市场","你决定等待市场进一步稳定后再做决定。",je({market:{houseMarketModifier:.85,duration:2}}))],He({probability:.08,minWeek:40,excludedEvents:["housing_market_boom"]}),!1,Ae,1,"/assets/images/events/housing_crash.jpg"),Te("business_partner_proposal","商业合作提议","一位经验丰富的商人提议与你合作开展更大规模的贸易，但需要你投入一笔资金作为启动资本。",[$e("接受合作","你决定与这位商人合作，投入一笔资金开展大规模贸易。",je({money:-1e4,nextEvent:"business_partnership_result"}),e=>e.player.money>=1e4),$e("小规模试水","你对合作持谨慎态度，决定先小规模投资测试。",je({money:-3e3,nextEvent:"business_partnership_small_result"}),e=>e.player.money>=3e3),$e("拒绝合作","你对这个合作提议持怀疑态度，决定婉拒。",je({}))],He({probability:.1,minWeek:30,playerMoney:{min:1e4},attributes:{businessSkill:{min:5}}}),!1,xe,1,"/assets/images/events/business_partner.jpg"),Te("business_partnership_result","商业合作结果","几周过去了，你与商业伙伴的合作项目有了结果...",[$e("查看结果","你期待地查看合作的成果。",je({money:e=>15e3+1e3*(e.player.attributes.businessSkill||0),attributes:{businessSkill:2}}))],He({requiredEvents:["business_partner_proposal"]}),!1,xe,1,"/assets/images/events/partnership_result.jpg"),Te("business_partnership_small_result","小规模合作结果","几周过去了，你的小规模合作项目有了结果...",[$e("查看结果","你查看小规模合作的成果。",je({money:e=>4500+300*(e.player.attributes.businessSkill||0),attributes:{businessSkill:1}}))],He({requiredEvents:["business_partner_proposal"]}),!1,xe,1,"/assets/images/events/partnership_result.jpg"),Te("final_opportunity","最终机会","游戏接近尾声，市场出现了一次难得的价格波动，这可能是你最后的发财机会！",[$e("全力投入","你决定将大部分资金投入到这次机会中，希望能实现最后的翻盘。",je({market:{globalPriceModifier:.6,duration:1},nextEvent:"final_market_surge"})),$e("谨慎投资","你决定谨慎投资，避免在最后关头冒过大风险。",je({market:{globalPriceModifier:.8,duration:1}}))],He({minWeek:45,probability:.5}),!1,xe,2,"/assets/images/events/final_opportunity.jpg"),Te("final_market_surge","最终市场大涨","就在游戏即将结束前，市场出现了戏剧性的价格上涨！这是最后的变现机会。",[$e("全部卖出","你决定趁这次价格上涨全部卖出库存，最大化你的利润。",je({market:{globalPriceModifier:2,duration:1}})),$e("部分卖出","你决定卖出部分库存，保留一些以防后市继续上涨。",je({market:{globalPriceModifier:1.7,duration:1}}))],He({requiredEvents:["final_opportunity"],minWeek:48}),!1,xe,1,"/assets/images/events/market_surge.jpg"),Te("property_expo","房产展览会","城市中心正在举办一场大型房产展览会，各个开发商都带来了他们最新的楼盘项目。这是了解市场动态和获取优惠信息的好机会。",[$e("参观展览会","你决定花时间参观房产展览会，了解市场最新动态。",je({money:-200,nextEvent:"property_expo_discover"}),e=>e.player.money>=200),$e("与中介交谈","你决定只与几位房产中介交谈，不花太多时间。",je({nextEvent:"property_broker_info"})),$e("忽略这个活动","你现在没有购房计划，决定忽略这次展览会。",je({}))],He({probability:.15,minWeek:15,playerMoney:{min:3e4}}),!1,xe,1,"/assets/images/events/property_expo.jpg"),Te("property_expo_discover","展会发现","在展览会上，你发现一个正在预售的新楼盘，开发商提供了独特的折扣方案。销售人员告诉你，如果现在预订，可以获得比市场价低15%的优惠。",[$e("预付定金","你决定抓住这个机会，预付10%的定金锁定这个优惠。",je({money:e=>-1e4,nextEvent:"property_investment_result"}),e=>e.player.money>=1e4),$e("记录信息","你记下了这个楼盘的信息，但决定先不付定金，回去再考虑。",je({nextEvent:"property_later_decision"})),$e("寻找其他机会","你对这个楼盘不太感兴趣，决定继续寻找其他机会。",je({}))],He({requiredEvents:["property_expo"]}),!1,xe,1,"/assets/images/events/property_discover.jpg"),Te("property_investment_result","房产投资结果","几周后，你收到开发商的通知，你预订的楼盘项目进展顺利，已经开始正式建设。根据最新的市场评估，类似房产的价值已经上涨了。",[$e("继续持有","你决定继续持有这项投资，期待房产完工后的升值。",je({attributes:{housingInvestment:1e4,propertyValue:1e5},nextEvent:"property_completion_notice"})),$e("转让投资","你决定趁着市场上涨，将你的预购权转让给其他买家，获取快速利润。",je({money:13e3,attributes:{housingInvestment:0,propertyValue:0}}))],He({requiredEvents:["property_expo_discover"]}),!1,xe,1,"/assets/images/events/property_investment.jpg"),Te("property_completion_notice","房产完工通知","你收到了开发商的通知，你投资的房产项目已经完工，现在价值约120,000元。你可以选择支付剩余的购房款完成购买，或者出售你的预购权。",[$e("完成购买","你决定支付剩余的购房款，完成这处房产的购买。",je({money:-9e4,attributes:{housingInvestment:0,propertyValue:12e4,hasHouse:!0},nextEvent:"new_house_celebration"}),e=>e.player.money>=9e4),$e("出售预购权","你决定出售你的预购权，获取投资回报。",je({money:25e3,attributes:{housingInvestment:0,propertyValue:0}})),$e("继续等待","你认为房产价值还会上涨，决定继续持有，但暂不付款。",je({nextEvent:"property_market_change"}))],He({requiredEvents:["property_investment_result"],minWeek:35}),!1,xe,1,"/assets/images/events/property_completion.jpg"),Te("property_market_change","房产市场变化","由于市场条件变化，你持有的房产预购权价值出现了波动。",[$e("查看市场变化","你密切关注市场动态，查看你的投资受到了什么影响。",je({attributes:{propertyValue:Math.random()>.5?13e4:11e4}}))],He({requiredEvents:["property_completion_notice"]}),!1,Ae,1,"/assets/images/events/market_change.jpg"),Te("new_house_celebration","新房庆祝","你终于拥有了自己的房产！这是人生的一个重要里程碑。朋友们提议举办一个小型聚会来庆祝这一时刻。",[$e("举办庆祝派对","你决定举办一个庆祝派对，邀请朋友们一起分享这个喜悦时刻。",je({money:-2e3,attributes:{happiness:5,socialNetwork:2}}),e=>e.player.money>=2e3),$e("简单庆祝","你决定简单地请几个好友吃顿饭庆祝一下。",je({money:-500,attributes:{happiness:3}}),e=>e.player.money>=500),$e("独自欣赏","你决定独自一人好好欣赏你的新家，享受这份成就感。",je({attributes:{happiness:2}}))],He({requiredEvents:["property_completion_notice"]}),!1,Ce,1,"/assets/images/events/house_celebration.jpg"),Te("property_broker_info","房产中介信息","与房产中介交谈后，你获得了一些关于当前房市的内部信息。中介表示，某些特定区域的房产可能即将升值。",[$e("深入了解","你决定与中介进一步交流，了解更多细节。",je({money:-500,nextEvent:"property_insider_tip"}),e=>e.player.money>=500),$e("保持关注","你对这些信息表示感谢，但决定暂时只是保持关注。",je({}))],He({requiredEvents:["property_expo"]}),!1,xe,1,"/assets/images/events/broker_info.jpg"),Te("property_insider_tip","内部消息","支付咨询费后，中介向你透露了一个内部消息：城市规划部门即将宣布在某区域建设新的地铁线，这很可能导致该区域房价上涨。",[$e("投资该区域房产","你决定相信这个消息，投资该区域的房产。",je({money:-3e4,nextEvent:"property_insider_result"}),e=>e.player.money>=3e4),$e("谨慎观望","你对这个消息持谨慎态度，决定先观察一段时间。",je({nextEvent:"property_missed_opportunity"}))],He({requiredEvents:["property_broker_info"]}),!1,xe,1,"/assets/images/events/insider_tip.jpg"),Te("property_insider_result","内部消息结果","几周后，城市规划部门果然宣布了新地铁线的建设计划，你投资的区域房产价值开始上涨！",[$e("继续持有","你决定继续持有这项投资，期待更大的升值空间。",je({attributes:{propertyValue:45e3}})),$e("立即出售","你决定趁着消息公布后的价格上涨立即出售获利。",je({money:4e4,attributes:{propertyValue:0}}))],He({requiredEvents:["property_insider_tip"]}),!1,xe,1,"/assets/images/events/insider_result.jpg"),Te("property_missed_opportunity","错失机会","城市规划部门宣布了新地铁线的建设计划，中介提到的区域房价果然上涨了。你有些遗憾没有把握这个投资机会。",[$e("寻找新机会","错过了这次机会，但你决定继续寻找新的投资机会。",je({nextEvent:"property_new_opportunity"})),$e("接受教训","你接受这个教训，决定以后在有内部消息时更加果断。",je({attributes:{businessSkill:1}}))],He({requiredEvents:["property_insider_tip"]}),!1,xe,1,"/assets/images/events/missed_opportunity.jpg"),Te("property_new_opportunity","新的房产机会","尽管错过了之前的机会，但你很快发现了另一个潜在的房产投资机会。一处位置较好但略显老旧的房产正在出售，价格相对较低。",[$e("购买并翻新","你决定购买这处房产并进行翻新，提升其价值。",je({money:-4e4,attributes:{propertyValue:4e4},nextEvent:"property_renovation_results"}),e=>e.player.money>=4e4),$e("仅购买不翻新","你决定购买这处房产，但暂不进行翻新。",je({money:-35e3,attributes:{propertyValue:35e3}}),e=>e.player.money>=35e3),$e("放弃这个机会","经过评估，你认为这个机会风险太大，决定放弃。",je({}))],He({requiredEvents:["property_missed_opportunity"]}),!1,xe,1,"/assets/images/events/new_opportunity.jpg"),Te("property_renovation_results","房产翻新结果","经过一段时间的翻新，你的房产焕然一新。周边邻居和房产评估师都对你的翻新工作表示赞赏。",[$e("查看房产估值","你请房产评估师对翻新后的房产进行正式估值。",je({money:-500,attributes:{propertyValue:55e3}}),e=>e.player.money>=500),$e("挂牌出售","你决定将翻新后的房产立即挂牌出售。",je({nextEvent:"property_sale_result"})),$e("继续持有","你决定暂时继续持有这处房产，观察市场变化。",je({}))],He({requiredEvents:["property_new_opportunity"]}),!1,xe,1,"/assets/images/events/renovation_results.jpg"),Te("property_sale_result","房产出售结果","经过几周的挂牌，你的房产终于找到了买家。买家对房子的状况非常满意，愿意支付一个不错的价格。",[$e("接受报价","你决定接受买家的报价，完成房产交易。",je({money:6e4,attributes:{propertyValue:0,businessSkill:2}})),$e("继续等待更高报价","你认为房产价值更高，决定拒绝当前报价，继续等待。",je({nextEvent:"property_price_negotiation"}))],He({requiredEvents:["property_renovation_results"]}),!1,xe,1,"/assets/images/events/sale_result.jpg"),Te("property_price_negotiation","房价谈判","在拒绝了第一位买家的报价后，又有新买家对你的房产表示了兴趣，双方开始了价格谈判。",[$e("坚持要价","你坚持自己的定价，表示这是最终价格。",je({money:Math.random()>.5?65e3:0,attributes:Math.random()>.5?{propertyValue:0,businessSkill:3}:{businessSkill:1}})),$e("适当让步","你决定在价格上适当让步，以确保交易成功。",je({money:58e3,attributes:{propertyValue:0,businessSkill:1}}))],He({requiredEvents:["property_sale_result"]}),!1,xe,1,"/assets/images/events/price_negotiation.jpg"),Te("property_later_decision","延迟购房决定","在记录了楼盘信息后，你一直在考虑是否应该投资这个项目。最近，你注意到该项目的市场反响很好，销售进展迅速。",[$e("现在投资","你决定不再犹豫，立即投资这个项目，尽管价格已经略有上涨。",je({money:-12e3,nextEvent:"property_investment_result"}),e=>e.player.money>=12e3),$e("放弃这个项目","你决定放弃这个项目，继续寻找其他投资机会。",je({}))],He({requiredEvents:["property_expo_discover"]}),!1,xe,1,"/assets/images/events/later_decision.jpg"),Te("bag_expansion_opportunity","背包扩展机会","你遇到一个旅行用品店，店主正在出售一款特制的高容量背包，看起来很实用。",[$e("购买高级背包","你购买了高级背包，现在你可以携带更多物品了。",je({money:-5e3,capacity:20}),e=>e.player.money>=5e3),$e("购买普通背包","你购买了一个普通背包，略微增加了携带容量。",je({money:-2e3,capacity:10}),e=>e.player.money>=2e3),$e("放弃购买","你决定暂时不购买新背包。",je({}))],He({probability:.8,playerMoney:{min:3e3}}),!1,Ie,2,"/assets/images/events/bag_expansion.jpg"),Te("market_price_surge","奢侈品与收藏品价格飙升","最新财经报道：随着富裕阶层消费回暖，高端商城的奢侈品和地下黑市的稀有收藏品价格大幅上涨，其中尤以名表和古董涨幅最大。",[$e("调整投资策略","你仔细分析了价格波动趋势，决定调整你的交易策略，重点关注高端商品。",je({market:{globalPriceModifier:1.05,locationModifiers:{premium_mall:1.15,black_market:1.2},locationProductModifiers:{premium_mall:{401:1.5},black_market:{503:1.6}},duration:2}})),$e("前往高端市场","你决定立即前往高端商城和地下黑市，希望能在价格进一步上涨前采购一些潜力商品。",je({forceLocationChange:!0,targetLocation:"premium_mall",market:{locationProductModifiers:{premium_mall:{401:1.3},black_market:{503:1.4}},duration:1}}))],He({probability:.3,minWeek:8}),!0,Ae,1,"/assets/images/events/price_surge.jpg"),Te("market_price_drop","市场价格下跌","全球经济出现波动，导致多个市场的商品价格出现下跌趋势。",[$e("观察市场","你决定观察市场动向，寻找低价购入的机会。",je({market:{globalPriceModifier:.85,duration:1}}))],He({probability:.7}),!0,Ae,1,"/assets/images/events/price_drop.jpg"),Te("property_investment_chance","房产投资机会","你听说一个新兴区域正在开发，现在购买房产可能会有不错的升值空间。",[$e("投资房产","你决定投资这个新兴区域的房产项目。",je({money:-3e4,attributes:{housingInvestment:3e4,propertyValue:3e4},nextEvent:"property_investment_result"}),e=>e.player.money>=3e4),$e("谨慎观望","你觉得目前时机不成熟，决定继续观望。",je({}))],He({minWeek:10,playerMoney:{min:3e4}}),!1,xe,1,"/assets/images/events/property_investment.jpg"),Te("financial_advisor","理财顾问","你遇到了一位专业的理财顾问，他愿意为你提供一些投资建议。",[$e("咨询建议","你支付咨询费，获得了一些关于当前市场的专业建议。",je({money:-1e3,market:{productModifiers:{house_a:1.05,house_b:.95,land_a:1.1},duration:604800}}),e=>e.player.money>=1e3),$e("委托投资","你决定委托他进行一些小额投资。",je({money:-3e3,nextEvent:"financial_advisor_result"}),e=>e.player.money>=3e3),$e("婉拒","你礼貌地拒绝了他的建议。",je({}))],He({probability:.6,minWeek:5}),!0,Ie,1,"/assets/images/events/financial_advisor.jpg"),Te("financial_advisor_result","投资结果","你之前委托理财顾问进行的投资有了结果。",[$e("查看结果",Math.random()<.7?"你的投资取得了不错的回报，获得了4000元。":"很遗憾，由于市场波动，你的投资出现了亏损，只收回了2000元。",je({money:Math.random()<.7?4e3:2e3}))],He({requiredEvents:["financial_advisor"]}),!1,xe,1,"/assets/images/events/investment_result.jpg"),Te({id:"supply_chain_disruption",title:"全球供应链中断危机",description:"突发新闻：全球贸易遭遇严重供应链中断！各地区不同商品价格出现剧烈波动，部分商品短缺涨价，部分商品积压降价。此次危机预计将对市场产生深远影响。",type:Ae,options:[$e("在大宗市场囤积基本物资","你预判到基本生活物资将会短缺，决定前往大宗商品交易所囤积必需品。",{market:{globalPriceModifier:1.05,locationProductModifiers:{commodity_market:{202:1.6,203:1.5,101:1.4},electronics_hub:{301:.7,305:.75},premium_mall:{404:.8}},duration:4},forceLocationChange:!0,targetLocation:"commodity_market"}),$e("投资受影响商品","你认为这是投资低价电子产品的好机会，决定前往电子科技城大量购入。",{market:{locationModifiers:{electronics_hub:.85},locationProductModifiers:{electronics_hub:{301:.6,305:.65},commodity_market:{202:1.45,203:1.4}},duration:3},forceLocationChange:!0,targetLocation:"electronics_hub"}),$e("寻找黑市稀缺资源","你猜测某些特殊商品可能在黑市变得更加稀缺且价值上升，决定前往地下黑市探索机会。",{market:{locationModifiers:{black_market:1.2},locationProductModifiers:{black_market:{502:1.8,503:1.9},second_hand_market:{107:.7,106:.75}},duration:3},forceLocationChange:!0,targetLocation:"black_market"}),$e("保持观望","你决定暂时不介入这次混乱的市场波动，等待形势更加明朗。",{market:{globalPriceModifier:1.02,duration:2}})],conditions:{probability:.15,minWeek:15},repeatable:!1,weight:3}),Te({id:"market_contrast_event",title:"城市区域发展不均",description:"最新城市规划调整导致电子科技城获得大量投资和客流，而地下黑市却因管控加强而客流锐减。这种发展不均衡引发了明显的市场差异。",type:Ae,options:[$e("分析市场机会","你仔细分析了城市不同区域的发展变化，寻找其中的交易机会。",{market:{locationModifiers:{electronics_hub:.8,black_market:1.4},duration:5}})],conditions:{probability:.2,minWeek:12},repeatable:!0,weight:2})];let Ue=[];const qe=[],Ve=[],ze=[],Be=[],Je=[],Ke=[];function Ye(){if(qe.length>0||Fe.forEach(e=>{const t=e.options.map(e=>e instanceof Ne?e:new Ne(e)),i=new Re({...e,options:t,imageUrl:e.imageUrl||("string"==typeof e[8]?e[8]:null)});switch(i.type){case Oe:qe.push(i);break;case Ie:Ve.push(i);break;case We:ze.push(i);break;case Ae:Be.push(i);break;case Ce:Je.push(i);break;case xe:Ke.push(i);break;default:Ve.push(i)}}),Ue.length>0)return Ue;const e=[];return e.push(...qe),e.push(...Ve),e.push(...ze),e.push(...Be),e.push(...Je),e.push(...Ke),e.push(Te({id:"location_inflation_electronics_hub",title:"电子科技城芯片短缺",description:"最新消息：电子科技城的主要芯片供应商工厂停产，导致该地区电子产品整体涨价。分析师预计这种情况将持续数周。",type:Ae,options:[$e("了解情况","你记下了这个信息，这可能影响你在电子科技城的交易策略。",{market:{locationModifiers:{electronics_hub:1.3},duration:4}})],conditions:{probability:.3,minWeek:5},repeatable:!0,weight:2}),Te({id:"premium_mall_luxury_watch_discount",title:"高端商城名表促销",description:"高端商城的名表专柜开始大规模促销活动，所有品牌手表都有特别折扣。这是购买奢侈手表的好机会！",type:Ae,options:[$e("记下信息","你记下了这个促销信息，可以考虑去高端商城购买手表。",{market:{locationProductModifiers:{premium_mall:{401:.6}},duration:2}})],conditions:{probability:.3,minWeek:3},repeatable:!0,weight:1}),Te({id:"nationwide_paper_shortage",title:"全国性纸张短缺",description:"由于环保政策收紧和原料价格上涨，全国范围内出现纸张短缺现象。大宗商品交易所和二手市场的卫生纸价格飙升，而其他地区受影响较小。",type:Ae,options:[$e("分析影响","你分析了这次纸张短缺对各个市场的影响，并调整了你的交易策略。",{market:{locationProductModifiers:{commodity_market:{101:1.7},second_hand_market:{101:1.5}},duration:3}})],conditions:{probability:.25,minWeek:8},repeatable:!0,weight:2}),Te({id:"market_contrast_event",title:"城市区域发展不均",description:"最新城市规划调整导致电子科技城获得大量投资和客流，而地下黑市却因管控加强而客流锐减。这种发展不均衡引发了明显的市场差异。",type:Ae,options:[$e("分析市场机会","你仔细分析了城市不同区域的发展变化，寻找其中的交易机会。",{market:{locationModifiers:{electronics_hub:.8,black_market:1.4},duration:5}})],conditions:{probability:.2,minWeek:12},repeatable:!0,weight:2}),Te({id:"supply_chain_disruption",title:"全球供应链中断危机",description:"突发新闻：全球贸易遭遇严重供应链中断！各地区不同商品价格出现剧烈波动，部分商品短缺涨价，部分商品积压降价。此次危机预计将对市场产生深远影响。",type:Ae,options:[$e("在大宗市场囤积基本物资","你预判到基本生活物资将会短缺，决定前往大宗商品交易所囤积必需品。",{market:{globalPriceModifier:1.05,locationProductModifiers:{commodity_market:{202:1.6,203:1.5,101:1.4},electronics_hub:{301:.7,305:.75},premium_mall:{404:.8}},duration:4},forceLocationChange:!0,targetLocation:"commodity_market"}),$e("投资受影响商品","你认为这是投资低价电子产品的好机会，决定前往电子科技城大量购入。",{market:{locationModifiers:{electronics_hub:.85},locationProductModifiers:{electronics_hub:{301:.6,305:.65},commodity_market:{202:1.45,203:1.4}},duration:3},forceLocationChange:!0,targetLocation:"electronics_hub"}),$e("寻找黑市稀缺资源","你猜测某些特殊商品可能在黑市变得更加稀缺且价值上升，决定前往地下黑市探索机会。",{market:{locationModifiers:{black_market:1.2},locationProductModifiers:{black_market:{502:1.8,503:1.9},second_hand_market:{107:.7,106:.75}},duration:3},forceLocationChange:!0,targetLocation:"black_market"}),$e("保持观望","你决定暂时不介入这次混乱的市场波动，等待形势更加明朗。",{market:{globalPriceModifier:1.02,duration:2}})],conditions:{probability:.15,minWeek:15},repeatable:!1,weight:3})),Ue=e,e}const Qe=new class{constructor(){this.events={},this.onceEvents={}}on(e,t){return this.events[e]||(this.events[e]=[]),this.events[e].push(t),()=>this.off(e,t)}once(e,t){return this.onceEvents[e]||(this.onceEvents[e]=[]),this.onceEvents[e].push(t),()=>{if(this.onceEvents[e]){const i=this.onceEvents[e].indexOf(t);-1!==i&&this.onceEvents[e].splice(i,1)}}}off(e,t){if(this.events[e]){const i=this.events[e].indexOf(t);-1!==i&&this.events[e].splice(i,1)}}emit(e,t){if(this.events[e]&&this.events[e].forEach(i=>{try{i(t)}catch(r){F(r,`EventEmitter.emit(${e})`,c.SYSTEM,l.WARNING),console.error(`Error in event listener for ${e}:`,r)}}),this.onceEvents[e]){const i=[...this.onceEvents[e]];this.onceEvents[e]=[],i.forEach(i=>{try{i(t)}catch(r){F(r,`EventEmitter.emit.once(${e})`,c.SYSTEM,l.WARNING),console.error(`Error in once event listener for ${e}:`,r)}})}}clear(){this.events={},this.onceEvents={}}clearEvent(e){e&&(this.events[e]=[],this.onceEvents[e]=[])}},Xe="easy",Ze="normal",et="hard",tt={[Xe]:{player:{initialMoney:8e3,initialDebt:1e3,initialCapacity:150,debtInterestRate:.004,debtGracePeriod:4},market:{priceTrendStrength:.8,priceVolatility:.8,specialProductDiscount:.25,trendContinuationChance:.8},events:{positiveEventChance:.7,eventFrequency:.3,earlyGameEventMultiplier:.7,lateGameEventMultiplier:1.1},houses:{housePriceMultipliers:{apartment:.9,house:.9,villa:.85,mansion:.85}},gameGoals:{requiredNetWorth:35e4,targetWeeks:52,debtRatio:.5}},[Ze]:{player:{initialMoney:5e3,initialDebt:2e3,initialCapacity:100,debtInterestRate:.005,debtGracePeriod:3},market:{priceTrendStrength:1,priceVolatility:1,specialProductDiscount:.15,trendContinuationChance:.75},events:{positiveEventChance:.5,eventFrequency:.4,earlyGameEventMultiplier:.8,lateGameEventMultiplier:1.2},houses:{housePriceMultipliers:{apartment:1,house:1,villa:1,mansion:1}},gameGoals:{requiredNetWorth:4e5,targetWeeks:52,debtRatio:.4}},[et]:{player:{initialMoney:3500,initialDebt:3e3,initialCapacity:80,debtInterestRate:.006,debtGracePeriod:2},market:{priceTrendStrength:1.2,priceVolatility:1.3,specialProductDiscount:.1,trendContinuationChance:.7},events:{positiveEventChance:.4,eventFrequency:.5,earlyGameEventMultiplier:.9,lateGameEventMultiplier:1.3},houses:{housePriceMultipliers:{apartment:1.1,house:1.15,villa:1.2,mansion:1.25}},gameGoals:{requiredNetWorth:45e4,targetWeeks:52,debtRatio:.35}}};const it="event:triggered",rt="event:completed",ot="event:effects_applied",st="positive",at="negative",nt="early",ct="mid",lt="late";class ut{constructor(e){this.events=e||[],this.triggeredEvents=new Set,this.activeEvents=[],this.eventHistory=[],this.cooldowns={},this.difficultyLevel="normal"}setDifficulty(e){this.difficultyLevel=e}generateStageAppropriateEvent(e){var t,i,r;console.log("尝试生成阶段适当的事件，当前周数:",e.currentWeek);const{currentWeek:o,maxWeeks:s=52}=e,a=o/s;let n;n=a<.3?nt:a<.7?ct:lt,console.log("当前游戏阶段:",n,"进度:",a);const c=function(e=Ze){return tt[e]||tt[Ze]}(this.difficultyLevel),l=function(e,t=52){const i=e/t;return i<.2?{phase:"early",eventMultiplier:.8,priceVolatilityMultiplier:.9}:i<.4?{phase:"early_mid",eventMultiplier:.9,priceVolatilityMultiplier:1}:i<.6?{phase:"mid",eventMultiplier:1,priceVolatilityMultiplier:1}:i<.8?{phase:"mid_late",eventMultiplier:1.1,priceVolatilityMultiplier:1.1}:{phase:"late",eventMultiplier:1.2,priceVolatilityMultiplier:1.2}}(o,s),u=1.8*c.events.eventFrequency,d=1.3*l.eventMultiplier,m=Math.min(.95,u*d);console.log("事件触发概率计算:",{baseEventChance:u,stageMultiplier:d,finalEventChance:m});const p=Math.random(),h=p<=m;if(console.log(`随机值: ${p}, 是否触发事件: ${h}`),!h)return null;let g=c.events.positiveEventChance;n===nt?g*=1.3:n===lt&&(g*=.8);const y=null==(t=e.currentLocation)?void 0:t.id;if(y){const e=this.eventHistory.filter(e=>{var t,i;const r=this.getEventById(e.id);return null==(i=null==(t=null==r?void 0:r.conditions)?void 0:t.locations)?void 0:i.includes(y)});if(e.length>3){const t=Math.min(.8,Math.pow(.9,e.length-3));eventProbability*=t}}e.player.money<5e3?g*=1.2:e.player.money>1e5&&(g*=.9);let v=1;const f=(null==(i=e.player.attributes)?void 0:i.hasHouse)||!1,b=(null==(r=e.player.attributes)?void 0:r.propertyValue)||0;!f&&b<1e3&&o>20?v=1.5:(f||b>5e4)&&(v=.7);const k=Math.random()<g?st:at;console.log("事件类型确定:",{positiveChance:g,eventEffectType:k});const P=this.events.filter(t=>{if(this.isEventInCooldown(t.id,o))return!1;if(!1===t.repeatable&&this.triggeredEvents.has(t.id))return!1;if(k===st&&t.effectType===at)return!1;if(k===at&&t.effectType===st)return!1;if(t.gameStage){if(t.gameStage===nt&&n!==nt)return!1;if(t.gameStage===ct&&n!==ct)return!1;if(t.gameStage===lt&&n!==lt)return!1}return!(t.id.startsWith("property_")&&Math.random()>v)&&this.checkEventConditions(t,e)});if(console.log(`筛选后的符合条件事件数量: ${P.length}`),0===P.length)return null;const _=this.selectEventByWeight(P,a);return console.log("选择的事件:",_?_.id:"null"),_}checkForEvents(e,t=null){console.log("事件系统 - 检查是否触发事件, 当前周数:",e.currentWeek),console.log("事件系统 - 当前地点:",e.currentLocation?e.currentLocation.id:"未知");let i=.6;e.currentLocation&&e.currentLocation.eventProbability&&(i=1.5*e.currentLocation.eventProbability,console.log(`事件系统 - 当前地点事件触发概率: ${i}`));const r=Math.min(1,(e.currentWeek||1)/52);i+=.2*r,i=Math.min(.95,i);const o=Math.random();if(console.log(`事件系统 - 事件随机检定: ${o.toFixed(2)} vs ${i.toFixed(2)} (触发阈值)`),t){const i=this.getEligibleEvents(e,t);if(console.log(`事件系统 - 找到 ${i.length} 个符合条件的 ${t} 类型事件`),0===i.length)return null;const o=this.selectEventByWeight(i,r);return o&&(console.log("事件系统 - 已选择事件:",o.id,o.title),this.recordEvent(o.id,e.currentWeek),Qe.emit(it,{event:o,week:e.currentWeek})),o}let s;if(!(o<i&&this.events.length>0))return console.log("事件系统 - 随机检定未通过，本周不触发事件"),null;{const t=this.getEligibleEvents(e);if(console.log(`事件系统 - 找到 ${t.length} 个符合条件的事件`),!(t.length>0))return console.log("事件系统 - 没有找到符合条件的事件"),null;s=this.selectEventByWeight(t,r),console.log("事件系统 - 选择事件:",s?s.id:"无")}return s?(console.log("事件系统 - 生成事件成功:",s.id,s.title),this.recordEvent(s.id,e.currentWeek),Qe.emit(it,{event:s,week:e.currentWeek})):console.log("事件系统 - 没有生成事件"),s}getEligibleEvents(e,t=null){return this.events.filter(i=>{if(t&&i.type!==t)return!1;if(this.isEventInCooldown(i.id,e.currentWeek))return!1;if(!1===i.repeatable&&this.triggeredEvents.has(i.id))return!1;return!(this.eventHistory.filter(t=>t.id===i.id&&e.currentWeek-t.week<=10).length>=2&&Math.random()>.3)&&this.checkEventConditions(i,e)})}checkEventConditions(e,t){var i;const r=e.conditions||{};if(r.minWeek&&t.currentWeek<r.minWeek)return!1;if(r.maxWeek&&t.currentWeek>r.maxWeek)return!1;if(r.locations&&t.currentLocation&&!r.locations.includes(t.currentLocation.id))return!1;if(r.playerMoney){const{min:e,max:i}=r.playerMoney;if(void 0!==e&&t.player.money<e)return!1;if(void 0!==i&&t.player.money>i)return!1}if(r.playerDebt){const{min:e,max:i}=r.playerDebt;if(void 0!==e&&t.player.debt<e)return!1;if(void 0!==i&&t.player.debt>i)return!1}if(r.inventoryItems)for(const o of r.inventoryItems){const e=t.player.inventory.find(e=>e.productId===o.productId),i=e?e.quantity:0;if(void 0!==o.minQuantity&&i<o.minQuantity)return!1;if(void 0!==o.maxQuantity&&i>o.maxQuantity)return!1}if(r.attributes)for(const[o,{min:s,max:a}]of Object.entries(r.attributes)){const e=(null==(i=t.player.attributes)?void 0:i[o])||0;if(void 0!==s&&e<s)return!1;if(void 0!==a&&e>a)return!1}if(r.requiredEvents)for(const o of r.requiredEvents)if(!this.triggeredEvents.has(o))return!1;if(r.excludedEvents)for(const o of r.excludedEvents)if(this.triggeredEvents.has(o))return!1;if(r.customCondition&&!r.customCondition(t))return!1;if(void 0!==r.probability){let t=r.probability;if(this.triggeredEvents.has(e.id)||(t=Math.min(.95,1.5*t)),Math.random()>t)return!1}return!0}isEventInCooldown(e,t){return!!this.cooldowns[e]&&this.cooldowns[e]>t}setEventCooldown(e,t,i=5){this.cooldowns[e]=t+i}recordEvent(e,t){this.triggeredEvents.add(e),this.eventHistory.push({id:e,week:t,timestamp:(new Date).toISOString()});const i=this.getEventById(e);let r;switch(null==i?void 0:i.type){case Ce:r=6;break;case Ae:r=3;break;case We:r=2;break;default:r=4}i&&!i.repeatable&&(r=999),this.setEventCooldown(e,t,r)}selectEventByWeight(e,t=.5){if(!e||0===e.length)return null;let i=0;const r=e.map(e=>{let r=e.weight||1;if(e.type===xe?r*=1.2:e.type===Ae&&(r*=1.1),e.id.startsWith("property_")&&t>.4&&(r*=1+t),e.options&&e.options.some(e=>e.effects&&e.effects.nextEvent)&&(r*=1.3),"meet_mucs"===e.id)return 0;this.triggeredEvents.has(e.id)?r*=.2:r*=2;const o=this.eventHistory.filter(t=>t.id===e.id).length;if(o>0){if(!e.repeatable)return 0;const t=.5,i=.2;r*=Math.max(i,Math.pow(t,o))}return console.log(`事件权重计算 - ${e.id}: ${r.toFixed(2)}`),i+=r,r});if(i<=0)return null;let o=Math.random()*i;for(let s=0;s<e.length;s++)if(o-=r[s],o<=0)return e[s];return e[0]}getEventById(e){const t=this.events.find(t=>t.id===e);return t?this.prepareEvent(t):null}triggerSpecificEvent(e,t){const i=this.getEventById(e);return i?(this.recordEvent(e,t.currentWeek),Qe.emit(it,{event:i,week:t.currentWeek,isSpecific:!0}),i):null}prepareEvent(e){if(!e)return null;const t={...e};return t.options&&(t.options=t.options.map(e=>("function"==typeof e.text?e.displayText=e.text():e.displayText=e.text,e))),t}updateActiveEvents(){this.activeEvents=this.activeEvents.filter(e=>!e.expired);const e=Date.now();return this.activeEvents.forEach(t=>{t.expiryTime&&e>t.expiryTime&&(t.expired=!0)}),this.activeEvents}getActiveMarketModifiers(){this.updateActiveEvents();const e={globalPriceModifier:1,categoryModifiers:{},productModifiers:{},specialProducts:[]};return this.activeEvents.forEach(t=>{t.expired||(t.globalPriceModifier&&(e.globalPriceModifier*=t.globalPriceModifier),t.categoryModifiers&&Object.entries(t.categoryModifiers).forEach(([t,i])=>{e.categoryModifiers[t]=(e.categoryModifiers[t]||1)*i}),t.productModifiers&&Object.entries(t.productModifiers).forEach(([t,i])=>{e.productModifiers[t]=(e.productModifiers[t]||1)*i}),t.specialProducts&&(e.specialProducts=[...e.specialProducts,...t.specialProducts]))}),e}applyEventEffects(e,t){var i;const r={appliedEffects:[],failedEffects:[]};if(console.log("应用事件效果:",t),void 0!==t.money){const i=t.money;i>0?(e.player.money+=i,r.appliedEffects.push({type:"money",value:i,success:!0})):i<0&&(e.player.money+i<0?(console.warn("EventSystem - 金钱不足，无法扣款",{required:Math.abs(i),available:e.player.money}),r.failedEffects.push({type:"money",value:i,reason:"insufficient_funds"})):(e.player.money+=i,r.appliedEffects.push({type:"money",value:i,success:!0})))}if(void 0!==t.debt){const i=t.debt;if(i>0)e.player.debt+=i,r.appliedEffects.push({type:"debt",value:i,success:!0});else if(i<0){const t=Math.min(e.player.debt,Math.abs(i));e.player.debt-=t,r.appliedEffects.push({type:"debt",value:-t,success:!0})}}if(t.items&&t.items.forEach(t=>{if(t.quantity>0){const i=e.products.find(e=>e.id===t.productId);if(i){const o=i.size*t.quantity;if(e.player.inventoryUsed+o<=e.player.capacity){const s=e.player.inventory.find(e=>e.productId===t.productId&&e.purchasePrice===(t.price||0));s?s.quantity+=t.quantity:e.player.inventory.push({productId:t.productId,name:i.name,quantity:t.quantity,purchasePrice:t.price||0,size:i.size}),e.player.inventoryUsed+=o,r.appliedEffects.push({type:"item_add",productId:t.productId,quantity:t.quantity,success:!0})}else r.failedEffects.push({type:"item_add",productId:t.productId,quantity:t.quantity,reason:"inventory_full"})}else r.failedEffects.push({type:"item_add",productId:t.productId,quantity:t.quantity,reason:"product_not_found"})}else if(t.quantity<0){const i=e.player.inventory.find(e=>e.productId===t.productId);if(i&&i.quantity>=Math.abs(t.quantity)){const o=Math.abs(t.quantity),s=i.size*o;if(i.quantity-=o,e.player.inventoryUsed-=s,i.quantity<=0){const t=e.player.inventory.indexOf(i);e.player.inventory.splice(t,1)}r.appliedEffects.push({type:"item_remove",productId:t.productId,quantity:o,success:!0})}else r.failedEffects.push({type:"item_remove",productId:t.productId,quantity:Math.abs(t.quantity),reason:"insufficient_items"})}}),t.capacity&&(e.player.capacity+=t.capacity,r.appliedEffects.push({type:"capacity",value:t.capacity,success:!0})),t.attributes&&Object.keys(t.attributes).length>0){e.player.attributes||(e.player.attributes={});for(const[i,o]of Object.entries(t.attributes)){const t=e.player.attributes[i]||0;e.player.attributes[i]=o,r.appliedEffects.push({type:"attribute",attribute:i,oldValue:t,newValue:o,success:!0})}}if(t.market){const o={...t.market,startTime:Date.now(),expiryTime:t.market.duration?Date.now()+7*t.market.duration*24*60*60*1e3:Date.now()+12096e5,expired:!1};if(this.activeEvents.push(o),e.market&&e.market.productPrices){if(o.globalPriceModifier){console.log(`应用全局价格修正: ${o.globalPriceModifier}`);for(const[t,i]of Object.entries(e.market.productPrices))e.market.productPrices[t]*=o.globalPriceModifier}if(o.categoryModifiers)for(const[t,r]of Object.entries(o.categoryModifiers)){console.log(`应用类别 ${t} 价格修正: ${r}`);const o=(null==(i=e.products)?void 0:i.filter(e=>e.category===t))||[];for(const t of o)e.market.productPrices[t.id]&&(e.market.productPrices[t.id]*=r)}if(o.productModifiers)for(const[t,i]of Object.entries(o.productModifiers))console.log(`应用产品 ${t} 价格修正: ${i}`),e.market.productPrices[t]&&(e.market.productPrices[t]*=i)}r.appliedEffects.some(e=>"market"===e.type)||r.appliedEffects.push({type:"market",effect:{globalPriceModifier:o.globalPriceModifier,categoryModifiers:o.categoryModifiers,productModifiers:o.productModifiers,locationModifiers:o.locationModifiers,locationProductModifiers:o.locationProductModifiers,duration:o.duration},success:!0})}return t.nextEvent&&r.appliedEffects.push({type:"next_event",eventId:t.nextEvent,success:!0}),t.locationChange&&r.appliedEffects.push({type:"location_change",locationId:t.locationChange,success:!0}),Qe.emit(ot,{effects:r.appliedEffects,failedEffects:r.failedEffects}),r}reset(){this.triggeredEvents.clear(),this.activeEvents=[],this.eventHistory=[],this.cooldowns={}}getSaveState(){return{triggeredEvents:Array.from(this.triggeredEvents),activeEvents:this.activeEvents,eventHistory:this.eventHistory,cooldowns:this.cooldowns}}loadFromSaveState(e){e&&(this.triggeredEvents=new Set(e.triggeredEvents||[]),this.activeEvents=e.activeEvents||[],this.eventHistory=e.eventHistory||[],this.cooldowns=e.cooldowns||{})}}const dt=r("event",{state:()=>({activeEvents:[],activeEvent:null,forceLocationChange:!1,targetLocation:null,nextEventId:null,triggeredEvents:[],eventSystem:null}),actions:{initializeEvents(){return console.log("EventStore - 初始化事件系统"),new Promise(e=>{setTimeout(()=>{this.initEventSystem(),console.log("EventStore - 事件系统初始化完成"),e()},300)})},initEventSystem(){this.eventSystem=new ut(Ye()),this.activeEvents=[],this.activeEvent=null,this.forceLocationChange=!1,this.targetLocation=null,this.nextEventId=null,this.triggeredEvents=[],this.setupEventListeners()},setupEventListeners(){Qe.on(it,e=>{this.activeEvent=e.event}),Qe.on(rt,e=>{this.activeEvent=null,e.nextEventId&&(this.nextEventId=e.nextEventId)}),Qe.on(ot,e=>{const t=e.effects.find(e=>"location_change"===e.type);t&&(this.forceLocationChange=!0,this.targetLocation=t.locationId);const i=e.effects.find(e=>"next_event"===e.type);i&&(this.nextEventId=i.eventId)})},resetEvents(){this.eventSystem?this.eventSystem.reset():this.initEventSystem(),this.activeEvents=[],this.activeEvent=null,this.forceLocationChange=!1,this.targetLocation=null,this.nextEventId=null,this.triggeredEvents=[]},generateRandomEvent(e,t,i){if(console.log("EventStore - 尝试生成随机事件, 当前周数:",e),null!==this.activeEvent)return console.log("EventStore - 已有待处理事件，跳过生成:",this.activeEvent.id),null;if(this.nextEventId){console.log("EventStore - 检测到预设的下一个事件:",this.nextEventId);const t=this.eventSystem.getEventById(this.nextEventId);if(this.nextEventId=null,t)return console.log("EventStore - 触发预设事件:",t.id,t.title),this.triggeredEvents.push({id:t.id,week:e}),this.activeEvent=t,t}console.log("EventStore - 创建游戏状态对象"),console.log("EventStore - playerData:",t?"已提供":"未提供"),console.log("EventStore - marketData:",i?"已提供":"未提供");try{const r={currentWeek:e,player:t,market:i,currentLocation:i.currentLocation};console.log("EventStore - 游戏状态对象创建成功"),console.log("EventStore - 当前地点:",r.currentLocation?r.currentLocation.id:"未知");const o=Math.random();if(o<.15){console.log("EventStore - 尝试触发彩蛋事件");const t=this.eventSystem.getEventById("meet_mucs");if(t&&this.eventSystem.checkEventConditions(t,r))return console.log("EventStore - 成功触发彩蛋事件:",t.id,t.title),this.triggeredEvents.push({id:t.id,week:e}),this.activeEvent=t,t}const s=Math.min(.3,.01*e);console.log("EventStore - 调用事件系统检查事件，额外概率:",s);let a=this.eventSystem.checkForEvents(r);return!a&&Math.random()<s&&(console.log("EventStore - 应用额外概率，强制尝试生成事件"),a=this.eventSystem.generateStageAppropriateEvent(r)),a?(console.log("EventStore - 成功生成事件:",a.id,a.title),this.triggeredEvents.push({id:a.id,week:e}),this.activeEvent=a,a):(console.log("EventStore - 没有生成事件"),null)}catch(r){return F(r,"EventState.generateRandomEvent",c.GAME_LOGIC,l.ERROR),console.error("EventStore - 生成随机事件时出错:",r),null}},triggerSpecificEvent(e,t,i){const r={currentWeek:t.statistics.weekCount,player:t,market:i,currentLocation:i.currentLocation},o=this.eventSystem.triggerSpecificEvent(e,r);return o?(this.triggeredEvents.push({id:o.id,week:t.statistics.weekCount}),o):null},triggerTutorialEvent(e){const t=e.startsWith("tutorial_")?e:`tutorial_${e}`,i=this.eventSystem.getEventById(t);return i?(this.activeEvent=i,i):null},triggerEvent(e){var t;try{if(e.startsWith("tutorial_")){return!!this.triggerTutorialEvent(e)}{const i=null==(t=this.eventSystem)?void 0:t.getEventById(e);if(i)return this.activeEvent=i,!0}return!1}catch(i){return F(i,"EventState.triggerEvent",c.GAME_LOGIC,l.WARNING),console.error("触发事件失败:",i),!1}},handleEventOption(e,t,i){if(!this.activeEvent||!e)return{success:!1,message:"无效的事件或选项",appliedEffects:[]};console.log("EventState - 处理事件选项:",e),console.log("EventState - 当前事件:",this.activeEvent.id);const r={currentWeek:t.statistics.weekCount,player:t,market:i,currentLocation:i.currentLocation,products:i.products};let o;try{o=this.eventSystem.applyEventEffects(r,e.effects),console.log("EventState - 事件效果应用结果:",o)}catch(a){console.error("EventState - 应用事件效果时出错:",a),F(a,"EventState.handleEventOption",c.GAME_LOGIC,l.ERROR),o={success:!1,message:"应用事件效果时出错",appliedEffects:[]}}const s=o||{success:!0,appliedEffects:[]};if(void 0===s.success&&(s.success=!0),s.appliedEffects||(s.appliedEffects=[]),e.effects&&e.effects.nextEvent&&(this.nextEventId=e.effects.nextEvent,console.log("EventState - 设置下一个事件:",this.nextEventId)),e.effects&&e.effects.forceLocationChange&&(this.forceLocationChange=!0,this.targetLocation=e.effects.targetLocation,console.log("EventState - 设置强制地点变更:",this.targetLocation)),e.effects&&e.effects.capacity&&e.effects.capacity>0&&(console.log("EventState - 背包容量增加:",e.effects.capacity),t.capacity+=e.effects.capacity,s.appliedEffects.some(e=>"capacity"===e.type)||s.appliedEffects.push({type:"capacity",value:e.effects.capacity,success:!0})),e.effects&&e.effects.attributes){console.log("EventState - 玩家属性变化:",e.effects.attributes),t.attributes||(t.attributes={});for(const[i,r]of Object.entries(e.effects.attributes)){const e=t.attributes[i];t.attributes[i]=r,s.appliedEffects.push({type:"attribute",attribute:i,oldValue:e,newValue:r,success:!0})}}if(i&&s.appliedEffects){s.appliedEffects.filter(e=>"market"===e.type).length>0&&(console.log("EventState - 应用市场效果到市场数据"),"function"==typeof i.calculateAllPrices?i.calculateAllPrices():"function"==typeof i.updatePrices&&i.updatePrices())}return Qe.emit(rt,{eventId:this.activeEvent.id,optionId:e.id,nextEventId:this.nextEventId,effects:s.appliedEffects}),this.activeEvent=null,s},getActiveMarketModifiers(){return this.eventSystem?this.eventSystem.getActiveMarketModifiers():{}},clearForceLocationChange(){this.forceLocationChange=!1,this.targetLocation=null},clearNextEvent(){this.nextEventId=null}},getters:{currentEvent:e=>e.activeEvent,needsLocationChange:e=>e.forceLocationChange,targetLocationId:e=>e.targetLocation,eventStatistics(e){if(!e.eventSystem)return{total:0,byType:{}};const t=e.triggeredEvents.length,i={};return e.triggeredEvents.forEach(t=>{const r=e.eventSystem.getEventById(t.id);if(r){const e=r.type||"unknown";i[e]=(i[e]||0)+1}}),{total:t,byType:i}}}}),mt=()=>{const e=dt(),t=te(),i=Le(),r=e=>({commodity_market:"大宗商品市场",second_hand_market:"二手市场",premium_mall:"高端商场",electronics_hub:"电子产品中心",black_market:"黑市"}[e]||e);return{generateRandomEvent:r=>{const o={money:t.money,debt:t.debt,inventory:t.inventory,statistics:t.statistics,purchasedHouses:t.purchasedHouses},s={marketModifiers:i.marketModifiers,currentLocation:i.currentLocation?i.currentLocation.id:null,productPrices:i.productPrices};return e.generateRandomEvent(r,o,s)},handleEventOption:o=>{const s=e.currentEvent;if(!s)return{success:!1,message:"没有活跃事件"};let a=o;if("number"==typeof o){if(o<0||o>=s.options.length)return{success:!1,message:"无效的选项索引"};a=s.options[o]}if(!a)return console.warn("EventActions - 无法处理空选项"),{success:!1,message:"无效的选项"};try{console.log("EventActions - 处理选项:",a);const o=a.effects||{},s=t,n=i,c={money:t.money,debt:t.debt,capacity:t.capacity,inventoryUsed:t.inventoryUsed,inventoryCount:t.inventory.length};console.log("EventActions - 处理选项前状态:",c);const l=e.handleEventOption(a,s,n),u={money:t.money,debt:t.debt,capacity:t.capacity,inventoryUsed:t.inventoryUsed,inventoryCount:t.inventory.length};console.log("EventActions - 处理选项后状态:",u);const d={money:u.money-c.money,debt:u.debt-c.debt,capacity:u.capacity-c.capacity,inventoryUsed:u.inventoryUsed-c.inventoryUsed,inventoryCount:u.inventoryCount-c.inventoryCount};console.log("EventActions - 状态变化:",d);const m=l||{success:!0};if(!1!==m.success){if(m.success=!0,m.appliedEffects||(m.appliedEffects=[]),0===d.money||m.appliedEffects.some(e=>"money"===e.type)||m.appliedEffects.push({type:"money",value:d.money,success:!0}),0===d.debt||m.appliedEffects.some(e=>"debt"===e.type)||m.appliedEffects.push({type:"debt",value:d.debt,success:!0}),0===d.capacity||m.appliedEffects.some(e=>"capacity"===e.type)||m.appliedEffects.push({type:"capacity",value:d.capacity,success:!0}),o.market&&!m.appliedEffects.some(e=>"market"===e.type)){const e={type:"market",effect:{...o.market},success:!0};(o.market.globalPriceModifier||o.market.categoryModifiers||o.market.productModifiers||o.market.locationModifiers||o.market.locationProductModifiers)&&m.appliedEffects.push(e)}if(m.effects&&m.effects.locationChanged&&e.needsLocationChange){const t=e.targetLocationId;t&&(i.changeLocation(t),e.clearForceLocationChange(),m.appliedEffects.push({type:"info",description:`已前往${r(t)}`,success:!0}))}0===m.appliedEffects.length&&m.appliedEffects.push({type:"info",description:"选项已执行，但没有产生直接效果",success:!0})}return m}catch(n){return console.error("EventActions - 处理选项出错:",n),{success:!1,message:"处理选项时出错: "+(n.message||"未知错误"),appliedEffects:[{type:"error",description:"处理选项失败: "+(n.message||"未知错误"),success:!1}]}}},triggerSpecificEvent:r=>{const o={money:t.money,debt:t.debt,inventory:t.inventory,statistics:t.statistics,purchasedHouses:t.purchasedHouses},s={marketModifiers:i.marketModifiers,currentLocation:i.currentLocation?i.currentLocation.id:null,productPrices:i.productPrices};return e.triggerSpecificEvent(r,o,s)},triggerTutorialEvent:t=>e.triggerTutorialEvent(t),getCurrentEvent:()=>e.currentEvent,hasPendingEvent:()=>null!==e.currentEvent,getEventStatistics:()=>e.eventStatistics}},pt=r("gameCore",{state:()=>({currentWeek:1,maxWeeks:52,gameStarted:!1,gamePaused:!1,gameOver:!1,victoryAchieved:!1,gameResult:null,notifications:[],initialized:!1,gameGoals:{requiredNetWorth:4e5,targetWeeks:30}}),actions:{async startNewGame(e){console.log("GameCore - 开始新游戏:",e),this.currentWeek=1,this.gameStarted=!0,this.gamePaused=!1,this.gameOver=!1,this.victoryAchieved=!1,this.gameResult=null;try{const t=te(),i=Le(),r=dt();await t.initializePlayer(e),!t.name&&e&&(t.name=e),i.initializeMarket().then(()=>{i.updateLocationProducts(),console.log("GameCore - 市场商品已更新")}),r.resetEvents(),localStorage.setItem("lastPlayerName",e),console.log("GameCore - 游戏初始化完成")}catch(t){throw F(t,"gameState (gameCore)",c.UNKNOWN,l.ERROR),console.error("GameCore - 初始化游戏模块时出错:",t),t}},advanceWeek(){if(this.currentWeek<=this.maxWeeks&&!this.gameOver){this.currentWeek++,console.log(`GameCore - 进入第 ${this.currentWeek} 周`);const e=te(),t=Le(),i=dt();console.log("GameCore - 更新玩家状态"),e.updateWeeklyPlayerState(this.currentWeek),console.log("GameCore - 更新市场状态"),t.updateMarketState(this.currentWeek),console.log("GameCore - 准备生成随机事件");const r={money:e.money,debt:e.debt,inventory:e.inventory,statistics:e.statistics,purchasedHouses:e.purchasedHouses,name:e.name,capacity:e.capacity,inventoryUsed:e.inventoryUsed};console.log("GameCore - 已准备玩家数据:",{money:r.money,debt:r.debt,inventoryCount:r.inventory.length});const o={marketModifiers:t.marketModifiers,currentLocation:t.currentLocation,productPrices:t.productPrices,products:t.products,locations:t.locations};console.log("GameCore - 已准备市场数据:",{currentLocationId:o.currentLocation?o.currentLocation.id:"未设置",productCount:o.products.length,locationCount:o.locations.length}),console.log("GameCore - 调用事件生成函数");let s=i.generateRandomEvent(this.currentWeek,r,o);return s||this.currentWeek%3!=0||(console.log("GameCore - 第一次未生成事件，尝试第二次生成"),s=i.generateRandomEvent(this.currentWeek,r,o)),s?(console.log("GameCore - 成功生成随机事件:",s.id,s.title),i.activeEvents.includes(s)||(i.activeEvents.push(s),console.log("GameCore - 事件已加入活跃队列, 当前队列长度:",i.activeEvents.length))):console.log("GameCore - 本周未触发事件"),this.checkGameEnd(),!0}if(!(52===this.maxWeeks&&this.currentWeek>this.maxWeeks)){this.currentWeek++;const e=te(),t=Le(),i=dt();e.updateWeeklyPlayerState(this.currentWeek),t.updateMarketState(this.currentWeek);const r={money:e.money,debt:e.debt,inventory:e.inventory,statistics:e.statistics,purchasedHouses:e.purchasedHouses,name:e.name,capacity:e.capacity,inventoryUsed:e.inventoryUsed},o={marketModifiers:t.marketModifiers,currentLocation:t.currentLocation,productPrices:t.productPrices,products:t.products,locations:t.locations};let s=i.generateRandomEvent(this.currentWeek,r,o);return s||this.currentWeek%3!=0||(s=i.generateRandomEvent(this.currentWeek,r,o)),s&&(i.activeEvents.includes(s)||i.activeEvents.push(s)),this.checkGameEnd(),!0}return this.gameOver=!0,!1},hasAffordableProducts(e=!0){const t=te(),i=Le(),r=e?t.money+t.bankDeposit:t.money;if(t.inventoryUsed>0)return!0;for(const o of i.locations){const e=i.getLocationAvailableProducts(o);for(const t of e){if(!i.products.find(e=>e.id===t))continue;if(i.getCurrentProductPrice(t)<=r)return!0}}return!1},checkGameEnd(){if(this.gameOver)return;if(this.currentWeek>this.maxWeeks)return void this.endGameWithTimeLimit();const e=te().netWorth;e>=1e6&&!this.victoryAchieved?this.achieveVictory():this.currentWeek>1&&e<0&&!this.hasAffordableProducts(!0)&&this.endGame("bankruptcy")},endGameWithTimeLimit(){var e,t,i,r,o,s,a;const n=te(),c=n.purchasedHouses&&n.purchasedHouses.length>0;if(console.log("游戏时间限制达到 - endGameWithTimeLimit",{victoryAchieved:this.victoryAchieved,hasHouses:c,purchasedHouses:null==(e=n.purchasedHouses)?void 0:e.length,netWorth:n.netWorth}),this.victoryAchieved||c){const e=this.calculateGameScore("victoryTimeLimit"),c=this.calculateRank(e),l=this.calculateScoreDetails("victoryTimeLimit");if(console.log("时间限制胜利 - 直接计算得分",{finalScore:e,rank:c}),this.gameResult={reason:"victoryTimeLimit",week:this.currentWeek,weeksPassed:this.currentWeek,score:e,achievementName:null,victoryAchieved:!0,firstVictoryWeek:(null==(t=this.gameResult)?void 0:t.firstVictoryWeek)||this.currentWeek,firstVictoryHouse:(null==(i=this.gameResult)?void 0:i.firstVictoryHouse)||null,finalMoney:n.money,finalAssets:n.netWorth,debt:n.debt,tradeStats:{totalTrades:(null==(r=n.statistics)?void 0:r.transactionCount)||0,totalProfit:(null==(o=n.statistics)?void 0:o.totalProfit)||0,averageProfit:(null==(s=n.statistics)?void 0:s.transactionCount)>0?((null==(a=n.statistics)?void 0:a.totalProfit)||0)/n.statistics.transactionCount:0},scoreDetails:{score:e,rank:c,details:l},endReason:"victoryTimeLimit"},this.gameOver=!0,n.purchasedHouses.length>0){this.gameResult.allPurchasedHouses=n.purchasedHouses,this.gameResult.houseCount=n.purchasedHouses.length;let e=n.purchasedHouses[0],t=n.purchasedHouses[0];n.purchasedHouses.forEach(i=>{i.purchasePrice>e.purchasePrice&&(e=i),(i.level>t.level||i.level===t.level&&i.purchasePrice>t.purchasePrice)&&(t=i)}),this.gameResult.mostExpensiveHouse=e,this.gameResult.highestLevelHouse=t}console.log("时间限制胜利 - 游戏结果对象已创建",{score:this.gameResult.score,scoreDetails:this.gameResult.scoreDetails})}else this.endGame("timeLimit")},achieveVictory(){const e=te();this.gameResult={reason:"victory",week:this.currentWeek,score:this.calculateGameScore("victory"),continuedPlay:!0,firstVictoryWeek:this.currentWeek,firstVictoryHouse:e.mostExpensiveHouse},e.addMoney(5e4),this.addNotification("reward","作为购买豪宅的奖励，您获得了额外的50,000元！")},achieveVictoryWithHouse(e){var t,i,r,o;this.victoryAchieved=!0;const s=te();console.log("购房胜利 - 开始计算结果",{houseCount:s.purchasedHouses.length,netWorth:s.netWorth}),e&&(e.image?e.image.startsWith("./")?e.image=e.image.replace("./","/"):e.image.startsWith("/")||(e.image=`/${e.image}`):e.image="/resources/assets/images/house_1.jpeg");s.purchasedHouses.some(t=>t.houseId===e.id||t.id===e.id)||console.warn("房屋购买记录不一致，这种情况不应该出现");const a=this.calculateGameScore("houseVictory"),n=this.calculateRank(a),c=this.calculateScoreDetails("houseVictory");console.log("购房胜利 - 计算得分结果",{finalScore:a,scoreRank:n,details:c});const l={...e};l.image&&!l.image.includes("NaN")||(console.warn("房屋图片路径无效，使用默认值"),l.image="/resources/assets/images/house_1.jpeg"),this.gameResult={reason:"houseVictory",week:this.currentWeek,weeksPassed:this.currentWeek,score:a,victoryAchieved:!0,firstVictoryWeek:this.currentWeek,firstVictoryHouse:l,canContinue:!0,finalMoney:s.money,finalAssets:s.netWorth,debt:s.debt,purchasedHouse:l,tradeStats:{totalTrades:(null==(t=s.statistics)?void 0:t.transactionCount)||0,totalProfit:(null==(i=s.statistics)?void 0:i.totalProfit)||0,averageProfit:(null==(r=s.statistics)?void 0:r.transactionCount)>0?((null==(o=s.statistics)?void 0:o.totalProfit)||0)/s.statistics.transactionCount:0},scoreDetails:{score:a,rank:n,details:c},endReason:"houseVictory"},this.gameOver=!0,console.log("购房胜利 - 游戏结果对象创建完成",{score:this.gameResult.score,scoreDetails:this.gameResult.scoreDetails})},continueGame(){this.gameOver=!1,this.victoryAchieved=!0},endGame(e,t=null){var i,r,o,s,a,n,c,l;this.gameOver=!0,this.victoryAchieved&&"victory"!==e&&"victoryTimeLimit"!==e&&(e="victoryOther");const u=te();console.log("游戏结束 - endGame",{reason:e,week:this.currentWeek,netWorth:u.netWorth,houseCount:(null==(i=u.purchasedHouses)?void 0:i.length)||0});const d=this.calculateGameScore(e),m=this.calculateRank(d),p=this.calculateScoreDetails(e);console.log("endGame得分计算完成",{score:d,rank:m,details:p}),this.gameResult={reason:e,week:this.currentWeek,weeksPassed:this.currentWeek,score:d,achievementName:t,victoryAchieved:this.victoryAchieved,firstVictoryWeek:(null==(r=this.gameResult)?void 0:r.firstVictoryWeek)||null,firstVictoryHouse:(null==(o=this.gameResult)?void 0:o.firstVictoryHouse)||null,finalMoney:u.money,finalAssets:u.netWorth,debt:u.debt,tradeStats:{totalTrades:(null==(s=u.statistics)?void 0:s.transactionCount)||0,totalProfit:(null==(a=u.statistics)?void 0:a.totalProfit)||0,averageProfit:(null==(n=u.statistics)?void 0:n.transactionCount)>0?((null==(c=u.statistics)?void 0:c.totalProfit)||0)/u.statistics.transactionCount:0},scoreDetails:{score:d,rank:m,details:p},endReason:e,data:{debt:u.debt,firstVictoryWeek:(null==(l=this.gameResult)?void 0:l.firstVictoryWeek)||this.currentWeek}},console.log("游戏结果对象已创建",{score:this.gameResult.score,scoreInDetails:this.gameResult.scoreDetails.score})},calculateGameScore(e){var t,i;const r=te();try{console.log("计算游戏得分 - 原始数据",{netWorth:r.netWorth,money:r.money,debt:r.debt,week:this.currentWeek,endReason:e,purchasedHouses:(null==(t=r.purchasedHouses)?void 0:t.length)||0});let o=r.netWorth;(isNaN(o)||void 0===o)&&(console.warn("计算游戏得分 - 净资产无效，使用备用计算"),o=(r.money||0)-(r.debt||0)),o=Math.max(1e3,o);const s=o/1e3;let a=1;switch(e){case"victory":case"houseVictory":a=1.5;break;case"victoryTimeLimit":a=2;break;case"bankruptcy":a=.5;break;case"achievement":a=1.2;break;default:a=1}let n=1;if(e.includes("victory")){const e=Math.max(1,this.currentWeek);n=Math.max(.5,1+10/e)}let c=1;const l=(null==(i=r.purchasedHouses)?void 0:i.length)||0;l>0&&(c=1+.2*l);let u=s*a*n*c;return u=Math.max(1,Math.floor(u)),console.log("计算游戏得分 - 最终结果",{baseScore:s,multiplier:a,speedMultiplier:n,houseBonus:c,totalScore:u}),u}catch(o){return console.error("计算游戏得分时发生错误:",o),Math.max(1,Math.floor(r.netWorth/1e3))}},calculateRank:e=>e>=1e6?"S":e>=5e5?"A":e>=2e5?"B":e>=1e5?"C":"D",calculateScoreDetails(e){var t,i,r;try{const s=te();console.log("计算得分明细 - 开始",{endReason:e,playerNetWorth:s.netWorth});let a=0;try{a=Math.max(0,Math.floor(s.netWorth/800)),console.log("资产得分计算",{netWorth:s.netWorth,assetsScore:a})}catch(o){console.error("资产得分计算错误:",o),a=100}let n=0;try{if(e.includes("victory")){const e=Math.max(1,this.currentWeek);n=Math.round(5e5/e),console.log("时间效率得分计算",{week:e,timeScore:n})}}catch(o){console.error("时间效率得分计算错误:",o),n=50}let c=0;try{if(s.purchasedHouses&&s.purchasedHouses.length>0){let e=0;s.purchasedHouses.forEach(t=>{const i=t.purchasePrice||t.price||0;e+=i}),c=Math.floor(e/5e3),s.purchasedHouses.length>1&&(c*=1+.2*(s.purchasedHouses.length-1)),console.log("房产得分计算",{houseCount:s.purchasedHouses.length,totalHouseValue:e,houseScore:c})}}catch(o){console.error("房产得分计算错误:",o),c=100}let l=0;try{const e=(null==(t=s.statistics)?void 0:t.totalProfit)||0,r=(null==(i=s.statistics)?void 0:i.transactionCount)||0;r>0&&(l=Math.floor(e/1e3),r>10&&(l*=1+.02*(r-10))),console.log("交易得分计算",{tradeCount:r,totalProfit:e,tradeScore:l})}catch(o){console.error("交易得分计算错误:",o),l=50}let u=0;try{const e=(null==(r=s.statistics)?void 0:r.totalInterestEarned)||0;u=e>0?Math.floor(e/500):Math.floor(s.bankDeposit/1e4),console.log("银行得分计算",{totalInterest:e,bankDeposit:s.bankDeposit,bankScore:u})}catch(o){console.error("银行得分计算错误:",o),u=10}const d=a+n+c+l+u;return console.log("得分明细总结",{assetsScore:a,timeScore:n,houseScore:c,tradeScore:l,bankScore:u,totalScore:d}),{assetsScore:a,timeScore:n,houseScore:c,tradeScore:l,bankScore:u,totalScore:d}}catch(s){return console.error("计算得分明细时出错:",s),{assetsScore:100,timeScore:50,houseScore:100,tradeScore:50,bankScore:10,totalScore:310}}},addNotification(e,t){this.notifications.push({id:Date.now(),type:e,message:t,timestamp:(new Date).toISOString()}),this.notifications.length>10&&this.notifications.shift()},pauseGame(){this.gameStarted&&!this.gameOver&&(this.gamePaused=!0)},resumeGame(){this.gamePaused=!1},manualEndGame(){const e=te();let t="playerChoice";e.purchasedHouses&&e.purchasedHouses.length>0&&(t="victory",this.victoryAchieved||(this.victoryAchieved=!0,this.gameResult={firstVictoryWeek:this.currentWeek,firstVictoryHouse:e.purchasedHouses[e.purchasedHouses.length-1]})),this.endGame(t)},triggerSpecificEvent(e){console.log("GameCore - 尝试触发特定事件:",e);try{const t=dt(),i=te(),r=Le(),o={money:i.money,debt:i.debt,inventory:i.inventory,statistics:i.statistics,purchasedHouses:i.purchasedHouses,name:i.name,capacity:i.capacity,inventoryUsed:i.inventoryUsed},s={marketModifiers:r.marketModifiers,currentLocation:r.currentLocation,productPrices:r.productPrices,products:r.products,locations:r.locations},a=t.triggerSpecificEvent(e,o,s);return a?(console.log("GameCore - 成功触发特定事件:",a.id,a.title),this.activeEvents.includes(a)||(this.activeEvents.push(a),console.log("GameCore - 事件已添加到活跃队列, 当前队列长度:",this.activeEvents.length)),a):(console.warn("GameCore - 触发特定事件失败:",e),null)}catch(t){return F(t,"gameState.triggerSpecificEvent",c.GAME_LOGIC,l.ERROR),console.error("GameCore - 触发特定事件时出错:",t),null}},initializeGameCore(){return new Promise(e=>{console.log("GameCore - 初始化游戏核心"),setTimeout(()=>{this.initialized=!0,console.log("GameCore - 游戏核心初始化完成"),e()},300)})},updateGameState(){console.log("GameCore - 更新游戏状态"),this.gameStarted&&!this.gameOver&&this.checkGameEnd(),this.notifications.length>10&&(this.notifications=this.notifications.slice(-10))}},getters:{gameProgress(){if(this.maxWeeks>52)return Math.min(5,this.currentWeek/1e3*100);const e=(this.currentWeek-1)/this.maxWeeks*100;return Math.max(0,Math.min(100,e))},isGameActive(){return this.gameStarted&&!this.gameOver&&!this.gamePaused},remainingWeeks(){if(this.maxWeeks>52)return"∞";const e=this.maxWeeks-this.currentWeek+1;return Math.max(0,e)},isEndlessMode(){return this.maxWeeks>52}}}),ht=Object.freeze(Object.defineProperty({__proto__:null,useGameCoreStore:pt},Symbol.toStringTag,{value:"Module"}));function gt(e){const t=[];if(!e||"object"!=typeof e)return{isValid:!1,issues:["存档数据无效或已损坏"]};e.version||t.push("缺少版本信息");const i=["gameCore","player","market","event"];for(const r of i)e[r]||t.push(`缺少${r}部分`);if(e.gameCore&&("number"!=typeof e.gameCore.currentWeek&&t.push("游戏周数无效"),"number"!=typeof e.gameCore.maxWeeks&&t.push("最大周数无效"),e.gameCore.currentWeek>e.gameCore.maxWeeks&&t.push("游戏周数超过最大周数")),e.player)if("string"!=typeof e.player.name&&t.push("玩家名称无效"),"number"!=typeof e.player.money&&t.push("玩家金钱无效"),e.player.money<0&&t.push("玩家金钱为负数"),Array.isArray(e.player.inventory)||t.push("库存数据无效"),Array.isArray(e.player.purchasedHouses)||t.push("房产数据无效"),e.player.statistics&&"object"==typeof e.player.statistics){const i=["weekCount","transactionCount","totalProfit","maxMoney"];for(const r of i)"number"!=typeof e.player.statistics[r]&&t.push(`统计数据 ${r} 无效或缺失`)}else t.push("玩家统计数据无效");if(e.market&&(Array.isArray(e.market.locations)||t.push("地点数据无效"),e.market.productPrices&&"object"==typeof e.market.productPrices||t.push("价格数据无效"),Array.isArray(e.market.products))){e.market.products.length!==new Set(e.market.products).size&&t.push("产品数据包含重复项")}return e.event&&(e.event.activeEvent&&"object"!=typeof e.event.activeEvent&&t.push("活动事件数据无效"),Array.isArray(e.event.triggeredEvents)||t.push("触发事件记录无效")),{isValid:0===t.length,issues:t}}function yt(e,t=null){const i=e||{};let r=[];t||(t={version:"0.1.0",gameCore:{currentWeek:1,maxWeeks:52,gameStarted:!0,gamePaused:!1,gameOver:!1},player:{name:"玩家",money:5e3,debt:2e3,capacity:100,inventory:[],purchasedHouses:[]},market:{locations:[{id:"location1",name:"市中心",specialProducts:["product1","product2"]},{id:"location2",name:"郊区",specialProducts:["product3","product4"]},{id:"location3",name:"商业区",specialProducts:["product5","product6"]},{id:"location4",name:"住宅区",specialProducts:["product7","product8"]},{id:"location5",name:"工业区",specialProducts:["product9","product10"]}],productPrices:{}},event:{activeEvent:null,triggeredEvents:[]}},r.push("使用默认模板数据")),i.version=i.version||"0.1.1",i.timestamp=i.timestamp||(new Date).toISOString(),r.push(`设置版本为: ${i.version}`),i.gameCore=i.gameCore||{},i.player=i.player||{},i.market=i.market||{},i.event=i.event||{},i.gameCore.currentWeek=vt(i.gameCore.currentWeek,1),i.gameCore.maxWeeks=vt(i.gameCore.maxWeeks,52),i.gameCore.gameStarted=ft(i.gameCore.gameStarted,!0),i.gameCore.gamePaused=ft(i.gameCore.gamePaused,!1),i.gameCore.gameOver=ft(i.gameCore.gameOver,!1),i.gameCore.notifications=Array.isArray(i.gameCore.notifications)?i.gameCore.notifications:[],i.gameCore.gameGoals=i.gameCore.gameGoals||{requiredNetWorth:4e5,targetWeeks:30,debtRatio:.4},i.gameCore.currentWeek>i.gameCore.maxWeeks&&(i.gameCore.currentWeek=i.gameCore.maxWeeks,r.push("修复: 调整当前周数不超过最大周数")),i.player.name=i.player.name||"玩家",i.player.money=vt(i.player.money,5e3),i.player.money<0&&(i.player.money=0,r.push("修复: 重置负数金钱为0")),i.player.debt=vt(i.player.debt,2e3),i.player.capacity=vt(i.player.capacity,100),i.player.inventoryUsed=vt(i.player.inventoryUsed,0),i.player.inventory=Array.isArray(i.player.inventory)?i.player.inventory:[],i.player.purchasedHouses=Array.isArray(i.player.purchasedHouses)?i.player.purchasedHouses:[];const o=i.player.inventory.reduce((e,t)=>e+(t.quantity||0),0);if(i.player.inventoryUsed!==o&&(i.player.inventoryUsed=o,r.push("修复: 调整库存使用量以匹配实际库存")),i.player.statistics=i.player.statistics||{},i.player.statistics.weekCount=vt(i.player.statistics.weekCount,i.gameCore.currentWeek),i.player.statistics.transactionCount=vt(i.player.statistics.transactionCount,0),i.player.statistics.totalProfit=vt(i.player.statistics.totalProfit,0),i.player.statistics.maxMoney=vt(i.player.statistics.maxMoney,Math.max(i.player.money,5e3)),i.player.purchasedHouses.length>0&&(!i.player.statistics.housePurchases||0===i.player.statistics.housePurchases.length)?(i.player.statistics.housePurchases=i.player.purchasedHouses.map(e=>({houseId:e.houseId,name:e.name||`${e.level}级房产`,level:e.level||1,price:e.purchasePrice,week:e.purchaseWeek||i.gameCore.currentWeek})),r.push("修复: 重建房屋购买记录")):i.player.statistics.housePurchases||(i.player.statistics.housePurchases=[]),i.player.purchasedHouses.length>0&&null===i.player.statistics.firstHousePurchaseWeek){const e=[...i.player.purchasedHouses].sort((e,t)=>(e.purchaseWeek||1/0)-(t.purchaseWeek||1/0))[0];i.player.statistics.firstHousePurchaseWeek=e.purchaseWeek||Math.max(1,i.gameCore.currentWeek-1),r.push("修复: 设置首次购房周数")}if(Array.isArray(i.market.locations)&&0!==i.market.locations.length||(i.market.locations=t.market&&Array.isArray(t.market.locations)?[...t.market.locations]:[],i.market.locations.length>0&&r.push("修复: 从模板恢复地点数据")),i.market.productPrices=i.market.productPrices||{},t&&t.market&&t.market.productPrices){let e=0;for(const r in t.market.productPrices)i.market.productPrices[r]||(i.market.productPrices[r]=t.market.productPrices[r],e++);e>0&&r.push(`修复: 从模板恢复${e}个产品价格数据`)}return Array.isArray(i.event.triggeredEvents)||(i.event.triggeredEvents=[],r.push("修复: 初始化触发事件记录")),console.log("存档修复日志:",r),{data:i,repairLog:r}}function vt(e,t){const i=Number(e);return isNaN(i)?t:i}function ft(e,t){return"boolean"==typeof e?e:t}class bt{async getData(e){throw new Error("StorageService.getData must be implemented by subclass")}async setData(e,t){throw new Error("StorageService.setData must be implemented by subclass")}async removeData(e){throw new Error("StorageService.removeData must be implemented by subclass")}async clearAll(){throw new Error("StorageService.clearAll must be implemented by subclass")}}class kt extends bt{constructor(e="game_"){super(),this.prefix=e}getFullKey(e){return`${this.prefix}${e}`}async getData(e){try{const t=this.getFullKey(e),i=localStorage.getItem(t);return i?JSON.parse(i):null}catch(t){throw F(t,"storageService (persistence)",c.STORAGE,l.ERROR),u(`Failed to get data for key ${e}`,{originalError:t.message})}}_safeStringify(e){try{return JSON.stringify(e)}catch(t){if(console.warn("标准序列化失败，尝试手动序列化"),null==e)return JSON.stringify(null);if("object"!=typeof e)return JSON.stringify(e);if(Array.isArray(e)){const t=[];for(let r=0;r<e.length;r++)try{const i=e[r];"object"==typeof i&&null!==i?t.push(JSON.parse(this._safeStringify(i))):t.push(i)}catch(i){t.push(null)}return JSON.stringify(t)}const r={};for(const o in e)if(Object.prototype.hasOwnProperty.call(e,o))try{const t=e[o];r[o]="object"==typeof t&&null!==t?JSON.parse(this._safeStringify(t)):"function"==typeof t?"[函数]":t}catch(i){console.warn(`无法序列化属性 ${o}`),r[o]=null}return JSON.stringify(r)}}async setData(e,t){try{console.log(`LocalStorage: 保存数据到 ${e}`);const r=this.getFullKey(e);let o;try{o=this._safeStringify(t)}catch(i){console.warn("序列化失败，使用基本数据",i),o=JSON.stringify({_simplified:!0,timestamp:(new Date).toISOString(),key:e})}return localStorage.setItem(r,o),!0}catch(r){return F(r,"storageService (persistence)",c.STORAGE,l.ERROR),console.error(`保存数据到本地存储失败: ${e}`,r),!1}}async removeData(e){try{const t=this.getFullKey(e);return localStorage.removeItem(t),!0}catch(t){throw F(t,"storageService (persistence)",c.STORAGE,l.ERROR),u(`Failed to remove data for key ${e}`,{originalError:t.message})}}async clearAll(){try{return Object.keys(localStorage).forEach(e=>{e.startsWith(this.prefix)&&localStorage.removeItem(e)}),!0}catch(e){throw F(e,"storageService (persistence)",c.STORAGE,l.ERROR),u("Failed to clear all data",{originalError:e.message})}}}class Pt extends bt{constructor(e="game_"){super(),this.prefix=e,this.isInitialized=!1,this.fallbackStorage=new kt,this.initializeElectronAPI()}async initializeElectronAPI(){try{window.electronAPI&&window.electronAPI.getConfig?(await window.electronAPI.getConfig(),this.isInitialized=!0,console.log("ElectronStorageService初始化成功")):console.warn("Electron API不可用，将使用LocalStorage作为备用")}catch(e){F(e,"storageService (persistence)",c.STORAGE,l.ERROR),console.error("初始化ElectronStorageService失败:",e)}return this.isInitialized}async getData(e){try{if(!this.isInitialized)return await this.fallbackStorage.getData(e);if(!window.electronAPI||!window.electronAPI.getConfig)throw new Error("Electron API不可用");const t=this.prefix+e,i=await window.electronAPI.getConfig();return i&&void 0!==i[t]?i[t]:null}catch(t){return F(t,"storageService (persistence)",c.UNKNOWN,l.ERROR),console.error(`获取数据失败 [${e}]:`,t),await this.fallbackStorage.getData(e)}}_safeSerialize(e){try{return console.log("尝试安全序列化数据"),JSON.parse(JSON.stringify(e))}catch(t){if(console.warn("标准JSON序列化失败，尝试手动序列化",t),null==e)return e;if("object"!=typeof e)return e;if(Array.isArray(e))return e.map(e=>this._safeSerialize(e));const r={};for(const o in e)if(Object.prototype.hasOwnProperty.call(e,o))try{r[o]=this._safeSerialize(e[o])}catch(i){console.warn(`无法序列化属性 ${o}:`,i),"function"==typeof e[o]?r[o]="[函数]":"object"==typeof e[o]?r[o]="[复杂对象]":r[o]=null}return r}}async setData(e,t){try{console.log(`正在保存数据 [${e}]...`);const i=await this.fallbackStorage.setData(e,t);if(console.log("备用存储保存"+(i?"成功":"失败")),!this.isInitialized)return console.log("ElectronAPI未初始化，仅使用备用存储"),i;if(!window.electronAPI||!window.electronAPI.setConfig)throw new Error("Electron API不可用");const r=this._safeSerialize(t);console.log("数据已安全序列化");const o=this.prefix+e,s={[o]:r};return await window.electronAPI.setConfig(s),console.log(`数据成功保存到 [${e}]`),!0}catch(i){if(F(i,"storageService (persistence)",c.UNKNOWN,l.ERROR),console.error(`设置数据失败 [${e}]:`,i),e.includes("Save_")&&window.electronAPI&&window.electronAPI.saveGame)try{console.log("尝试使用saveGame API保存...");const i=e.replace(this.prefix,"").replace("Save_",""),r=await window.electronAPI.saveGame({name:i,gameState:t});if(r&&r.success)return console.log("使用saveGame API保存成功"),!0}catch(r){console.error("saveGame API保存失败",r)}return await this.fallbackStorage.setData(e,t)}}async removeData(e){try{if(!this.isInitialized)return await this.fallbackStorage.removeData(e);if(!window.electronAPI||!window.electronAPI.setConfig)throw new Error("Electron API不可用");const t=this.prefix+e,i={[t]:void 0};return await window.electronAPI.setConfig(i),!0}catch(t){return F(t,"storageService (persistence)",c.UNKNOWN,l.ERROR),console.error(`删除数据失败 [${e}]:`,t),await this.fallbackStorage.removeData(e)}}async clearAll(){try{if(!this.isInitialized)return await this.fallbackStorage.clearAll();if(!window.electronAPI||!window.electronAPI.clearConfig)throw new Error("Electron API不可用");const e=await window.electronAPI.getConfig(),t=Object.keys(e).filter(e=>e.startsWith(this.prefix));if(0===t.length)return!0;const i={};return t.forEach(e=>{i[e]=void 0}),await window.electronAPI.setConfig(i),!0}catch(e){return F(e,"storageService (persistence)",c.UNKNOWN,l.ERROR),console.error("清除所有数据失败:",e),await this.fallbackStorage.clearAll()}}}const _t=new Pt,Et="saveList",St="houseJourneySave_",Mt="0.1.1",wt=r("save",{state:()=>({saveList:[],isLoading:!1,lastAutoSaveWeek:0,autoSaveEnabled:!0,saveTemplate:null,lastValidatedSave:null}),actions:{async init(){try{await this.loadSaveList(),this.createSaveTemplate(),this.autoSaveEnabled&&setInterval(()=>{const e=pt();!e.gameStarted||e.gameOver||e.gamePaused||this.checkAutoSave(e.currentWeek)},6e4)}catch(e){F(e,"saveSystem (persistence)",c.UNKNOWN,l.ERROR),console.error("初始化存档系统失败",e)}},createSaveTemplate(){pt(),te();const e=Le();dt(),this.saveTemplate={version:Mt,timestamp:(new Date).toISOString(),gameCore:{currentWeek:1,maxWeeks:52,gameStarted:!0,gamePaused:!1,gameOver:!1,gameResult:null,notifications:[],gameGoals:{requiredNetWorth:4e5,targetWeeks:30,debtRatio:.4}},player:{name:"玩家",money:5e3,debt:2e3,capacity:100,inventoryUsed:0,inventory:[],purchasedHouses:[],statistics:{weekCount:1,transactionCount:0,totalProfit:0,maxMoney:5e3,visitedLocations:[]}},market:{locations:e.locations||[],currentLocation:null,productPrices:{},products:[],houses:[],marketModifiers:{}},event:{activeEvent:null,forceLocationChange:!1,targetLocation:null,nextEventId:null,triggeredEvents:[]}}},async loadSaveList(){try{console.log("尝试加载存档列表...");const t=await _t.getData(Et);if(t&&Array.isArray(t)&&0!==t.length)console.log("成功从存储中加载存档列表，数量:",t.length),this.saveList=t;else{console.log("存档列表为空或无效，尝试从文件系统获取...");try{if(window.electronAPI&&window.electronAPI.listSaves){const e=await window.electronAPI.listSaves();if(e&&e.success&&Array.isArray(e.saves)){console.log("从Electron API获取到",e.saves.length,"个存档");const t=e.saves.map(e=>({id:e.name,name:e.name,isAuto:e.name.startsWith("autosave_")||e.name.includes("自动存档"),timestamp:e.lastModified?new Date(e.lastModified).getTime():Date.now(),lastModified:e.lastModified}));return this.saveList=t,await _t.setData(Et,t),t}}}catch(e){console.error("从Electron API获取存档列表失败",e)}this.saveList=[]}}catch(t){F(t,"saveSystem (persistence)",c.UNKNOWN,l.ERROR),console.error("加载存档列表失败",t),this.saveList=[]}return this.saveList},async validateSave(e){try{const t=e||this.lastValidatedSave;if(!t)return{success:!1,message:"未指定存档ID"};const i=await _t.getData(`${St}${t}`);if(!i)return{success:!1,message:"存档不存在或已损坏"};const r=gt(i);return{success:r.isValid,issues:r.issues,saveData:i,canRepair:r.issues.length>0}}catch(t){return F(t,"saveSystem (persistence)",c.UNKNOWN,l.ERROR),console.error("验证存档失败",t),{success:!1,message:`验证失败: ${t.message}`,error:t}}},async saveGame(e,t=!1){return V(async()=>{const i=pt(),r=te(),o=Le(),s=dt(),a=Q();let n={version:Mt,timestamp:(new Date).toISOString()};try{console.log("准备存档数据...");const e=i.gameResult?JSON.parse(JSON.stringify({reason:i.gameResult.reason,week:i.gameResult.week,score:i.gameResult.score,endReason:i.gameResult.endReason,victoryAchieved:i.gameResult.victoryAchieved,firstVictoryWeek:i.gameResult.firstVictoryWeek})):null,t=i.notifications?i.notifications.map(e=>({id:e.id,type:e.type,message:e.message,timestamp:e.timestamp})):[],a=r.inventory?r.inventory.map(e=>({productId:e.productId,name:e.name,quantity:e.quantity,purchasePrice:e.purchasePrice,purchaseWeek:e.purchaseWeek})):[],c=r.purchasedHouses?r.purchasedHouses.map(e=>({houseId:e.houseId,name:e.name,level:e.level,purchasePrice:e.purchasePrice,purchaseWeek:e.purchaseWeek,location:"string"==typeof e.location?e.location:null})):[];let l=null;s.activeEvent&&(l={id:s.activeEvent.id,title:s.activeEvent.title,type:s.activeEvent.type}),n={version:Mt,timestamp:(new Date).toISOString(),gameCore:{currentWeek:i.currentWeek,maxWeeks:i.maxWeeks,gameStarted:i.gameStarted,gamePaused:i.gamePaused,gameOver:i.gameOver,gameResult:e,notifications:t,gameGoals:JSON.parse(JSON.stringify(i.gameGoals||{}))},player:{name:r.name,money:r.money,debt:r.debt,capacity:r.capacity,inventoryUsed:r.inventoryUsed,inventory:a,purchasedHouses:c,statistics:JSON.parse(JSON.stringify(r.statistics||{}))},market:{locations:JSON.parse(JSON.stringify(o.locations||[])),currentLocation:o.currentLocation?o.currentLocation.id:null,productPrices:JSON.parse(JSON.stringify(o.productPrices||{})),products:o.products?o.products.map(e=>"object"==typeof e?e.id:e):[],houses:o.houses?o.houses.map(e=>"object"==typeof e?e.id:e):[],marketModifiers:JSON.parse(JSON.stringify(o.marketModifiers||{}))},event:{activeEvent:l,forceLocationChange:s.forceLocationChange,targetLocation:s.targetLocation,nextEventId:s.nextEventId,triggeredEvents:JSON.parse(JSON.stringify(s.triggeredEvents||[]))}},console.log("存档数据准备完成")}catch(h){F(h,"saveSystem (persistence)",c.UNKNOWN,l.ERROR),console.error("准备存档数据时出错:",h),n={version:Mt,timestamp:(new Date).toISOString(),gameCore:{currentWeek:i.currentWeek,maxWeeks:i.maxWeeks,gameStarted:!0,gamePaused:!1,gameOver:i.gameOver},player:{name:r.name,money:r.money,debt:r.debt,capacity:100,inventoryUsed:0,inventory:[],purchasedHouses:[]},market:{currentLocation:null,productPrices:{},products:[],houses:[],marketModifiers:{}},event:{triggeredEvents:[]}},t||a.showToast({type:"warning",message:"存档数据处理出错，使用简化版本",duration:3e3})}const u=gt(n);if(!u.isValid){console.warn("生成的存档数据有问题，尝试修复...",u.issues),t||a.showToast({type:"warning",message:"存档数据有问题，正在修复...",duration:3e3});const e=yt(n,this.saveTemplate);n=e.data,!t&&e.repairLog.length>0&&(console.info("存档修复完成",e.repairLog),a.showToast({type:"info",message:`存档已修复 (${e.repairLog.length}项问题)`,duration:3e3}))}let d,m=!0;if(t){const t=`auto_${Date.now()}`;d=t,e=`自动存档 - 第${i.currentWeek}周 - ${(new Date).toLocaleString()}`}else{const t=this.saveList.find(t=>t.name===e);t?(d=t.id,m=!1):d=`save_${Date.now()}`}const p={id:d,name:e,isAuto:t,timestamp:Date.now(),week:i.currentWeek,playerMoney:r.money,playerDebt:r.debt,location:o.currentLocation?o.currentLocation.name:"未知位置",version:Mt};try{if(console.log("正在保存游戏数据到存储..."),await _t.setData(`${St}${d}`,n),console.log("游戏数据已保存到存储"),window.electronAPI&&window.electronAPI.saveGame){console.log("尝试使用Electron API保存游戏...");const t=await window.electronAPI.saveGame({name:e,gameState:n});t&&t.success?console.log("游戏已成功保存到文件系统:",t.path):console.warn("Electron保存可能失败:",(null==t?void 0:t.error)||"未知错误")}if(console.log("更新存档列表..."),m)this.saveList.unshift(p);else{const e=this.saveList.findIndex(e=>e.id===d);-1!==e&&(this.saveList[e]=p)}}catch(g){if(F(g,"saveSystem (persistence)",c.STORAGE,l.ERROR),console.error("保存游戏数据时出错:",g),!window.electronAPI||!window.electronAPI.saveGame)throw g;{console.log("尝试使用备用方法保存游戏...");const t=await window.electronAPI.saveGame({name:e,gameState:n});if(!t||!t.success)throw g;console.log("已使用备用方法保存游戏")}}if(t){const e=this.saveList.filter(e=>e.isAuto);if(e.length>3){const t=e.sort((e,t)=>e.timestamp-t.timestamp).slice(0,e.length-3);for(const e of t)await this.deleteSave(e.id,!0)}}return await _t.setData(Et,this.saveList),t||a.showToast({type:"success",message:m?"游戏已保存":"存档已更新",duration:2e3}),t&&(this.lastAutoSaveWeek=i.currentWeek),{success:!0,saveId:d,isNewSave:m}},"saveGame",c.STORAGE,l.ERROR)},async loadGame(e){return V(async()=>{pt();const t=te(),i=(Le(),dt(),Q());try{this.lastValidatedSave=e;const r=await this.validateSave(e);if(r.success)await this.loadStoresFromSaveData(r.saveData);else{i.showToast({type:"warning",message:"存档可能已损坏，正在尝试修复...",duration:3e3});const t=await _t.getData(`${St}${e}`);if(!t)return i.showToast({type:"error",message:"存档数据无法读取，无法修复",duration:5e3}),this.isLoading=!1,{success:!1,message:"存档数据无法读取"};const r=yt(t,this.saveTemplate),o=r.data;if(!gt(o).isValid)return i.showToast({type:"error",message:"存档损坏严重，无法修复",duration:5e3}),this.isLoading=!1,{success:!1,message:"存档无法修复"};i.showToast({type:"success",message:`存档已成功修复 (${r.repairLog.length}项问题)`,duration:5e3}),await _t.setData(`${St}${e}`,o),console.info("已保存修复后的存档",o),await this.loadStoresFromSaveData(o)}const o=this.saveList.find(t=>t.id===e);return o&&(o.previewData={purchasedHouses:t.purchasedHouses.length,debt:t.debt,inventory:t.inventory.length,netWorth:t.netWorth},await _t.setData(Et,this.saveList)),this.isLoading=!1,{success:!0,message:"加载成功"}}catch(r){return F(r,"saveSystem (persistence)",c.UNKNOWN,l.ERROR),console.error("加载游戏失败",r),this.isLoading=!1,i.showToast({type:"error",message:"加载存档失败: "+r.message,duration:5e3}),{success:!1,error:r,message:"加载失败: "+r.message}}},"loadGame",c.STORAGE,l.ERROR)},async loadStoresFromSaveData(e){const t=pt(),i=te(),r=Le(),o=dt();(e=function(e,t="0.1.1"){if(!e)return null;if(e.version||(e.version="0.1.0"),e.version===t)return e;let i={...e};return"0.1.0"===e.version&&"0.1.1"===t&&(i.gameState||(i.gameState={})),i.version=t,i}(e,Mt)).gameCore&&(t.currentWeek=e.gameCore.currentWeek||1,t.maxWeeks=e.gameCore.maxWeeks||52,t.gameStarted=Boolean(e.gameCore.gameStarted),t.gamePaused=Boolean(e.gameCore.gamePaused),t.gameOver=Boolean(e.gameCore.gameOver),t.gameResult=e.gameCore.gameResult||null,t.notifications=Array.isArray(e.gameCore.notifications)?e.gameCore.notifications:[],t.gameGoals=e.gameCore.gameGoals||{requiredNetWorth:4e5,targetWeeks:30,debtRatio:.4}),e.player&&(i.name=e.player.name||"玩家",i.money=e.player.money||5e3,i.debt=e.player.debt||2e3,i.capacity=e.player.capacity||100,i.inventoryUsed=e.player.inventoryUsed||0,i.inventory=Array.isArray(e.player.inventory)?e.player.inventory:[],i.purchasedHouses=Array.isArray(e.player.purchasedHouses)?e.player.purchasedHouses:[],i.statistics=e.player.statistics||{weekCount:e.gameCore.currentWeek||1,transactionCount:0,totalProfit:0,maxMoney:i.money,visitedLocations:[],housePurchases:[],firstHousePurchaseWeek:null}),e.market&&(r.locations=Array.isArray(e.market.locations)?e.market.locations:[],r.productPrices=e.market.productPrices||{},e.market.currentLocation&&r.locations.length>0?r.currentLocation=r.locations.find(t=>t.id===e.market.currentLocation)||r.locations[0]:r.locations.length>0&&(r.currentLocation=r.locations[0]),r.loadProducts(e.market.products||[]),r.loadHouses(e.market.houses||[]),r.marketModifiers=e.market.marketModifiers||{}),e.event&&(o.activeEvent=e.event.activeEvent||null,o.forceLocationChange=Boolean(e.event.forceLocationChange),o.targetLocation=e.event.targetLocation||null,o.nextEventId=e.event.nextEventId||null,o.triggeredEvents=Array.isArray(e.event.triggeredEvents)?e.event.triggeredEvents:[])},async deleteSave(e,t=!1){return V(async()=>{const i=this.saveList.findIndex(t=>t.id===e);try{if(await _t.removeData(`${St}${e}`),-1!==i&&this.saveList.splice(i,1),await _t.setData(Et,this.saveList),!t){Q().showToast({type:"success",message:"存档已删除",duration:2e3})}return!0}catch(r){if(F(r,"saveSystem (persistence)",c.UNKNOWN,l.ERROR),console.error("删除存档失败",r),!t){Q().showToast({type:"error",message:"删除存档失败: "+r.message,duration:5e3})}return!1}},"deleteSave",c.STORAGE,l.WARNING)},async cleanupOldAutoSaves(){const e=this.saveList.filter(e=>e.isAuto);if(e.length>3){e.sort((e,t)=>t.timestamp-e.timestamp);for(let t=3;t<e.length;t++)await this.deleteSave(e[t].id,!0)}},async checkAutoSave(e){if(!this.autoSaveEnabled)return;const t=pt();t.gameStarted&&!t.gameOver&&e>this.lastAutoSaveWeek&&e%5==0&&await this.autoSave()},async autoSave(){const e=pt();te();const t=`自动存档 (第${e.currentWeek}周)`;await this.saveGame(t,!0),console.log(`自动存档完成: ${t}`)},async triggerImportantActionAutoSave(e){if(!this.autoSaveEnabled)return;const t=pt();if(!t.gameStarted||t.gameOver)return;let i="";switch(e){case"house_purchase":i=`购房存档 (第${t.currentWeek}周)`;break;case"major_transaction":i=`大额交易存档 (第${t.currentWeek}周)`;break;case"event_completed":i=`事件完成存档 (第${t.currentWeek}周)`;break;case"debt_repaid":i=`还清债务存档 (第${t.currentWeek}周)`;break;default:i=`重要操作存档 (第${t.currentWeek}周)`}await this.saveGame(i,!0),console.log(`重要操作自动存档完成: ${i}`)}},getters:{autoSaves:e=>e.saveList.filter(e=>e.isAuto).sort((e,t)=>t.timestamp-e.timestamp),manualSaves:e=>e.saveList.filter(e=>!e.isAuto).sort((e,t)=>t.timestamp-e.timestamp),latestSave:e=>0===e.saveList.length?null:e.saveList.sort((e,t)=>t.timestamp-e.timestamp)[0]}}),Lt=r("gameCompat",()=>{const e=pt(),t=te(),i=Le(),r=dt(),s=wt(),a=ie();return{currentWeek:o(()=>e.currentWeek),maxWeeks:o(()=>e.maxWeeks),gameStarted:o(()=>e.gameStarted),gamePaused:o(()=>e.gamePaused),gameOver:o(()=>e.gameOver),gameResult:o(()=>e.gameResult),notifications:o(()=>e.notifications),gameGoals:o(()=>e.gameGoals),gameProgress:o(()=>e.gameProgress),isGameActive:o(()=>e.isGameActive),player:o(()=>t),locations:o(()=>i.locations),currentLocation:o(()=>i.currentLocation),productPrices:o(()=>i.productPrices),products:o(()=>i.products),availableProducts:o(()=>i.availableProducts),houses:o(()=>i.houses),marketModifiers:o(()=>i.marketModifiers),currentEvent:o(()=>r.currentEvent),eventHistory:o(()=>r.eventHistory),startNewGame:function(t){e.startNewGame(t)},advanceWeek:function(){return e.advanceWeek()},changeLocation:function(e){return i.changeLocation(e)},updateProductPrices:function(){i.updateProductPrices(e.currentWeek)},updateLocationProducts:function(){i.updateLocationProducts(e.currentWeek)},generateRandomEvent:function(){r.generateRandomEvent(e.currentWeek)},buyProduct:function(e,r){var o;const s=String(e),n=i.availableProducts.find(e=>String(e.id)===s);if(!n)return console.log("商品不存在:",e,"可用商品IDs:",i.availableProducts.map(e=>e.id)),{success:!1,message:"商品不存在"};const c=null==(o=i.productPrices[s])?void 0:o.price;if(!c){console.log("价格未定义:",e,"价格列表keys:",Object.keys(i.productPrices));const o=n.basePrice||0;return o>0?(console.log("使用商品基本价格:",o),function(e,i,r){const o=i*r;if(t.money<o)return{success:!1,message:"资金不足"};const s=a.addToInventory(e,r,i);if(!s.success)return s;return t.money-=o,t.statistics.transactionCount+=1,{success:!0}}(n,o,r)):{success:!1,message:"价格未定义"}}const l=c*r;if(t.money<l)return{success:!1,message:"资金不足"};const u=a.addToInventory(n,r,c);return u.success?(t.money-=l,t.statistics.transactionCount+=1,{success:!0}):u},sellProduct:function(e,r){var o;if(!e||r<=0)return{success:!1,message:"无效的参数"};const s=String(e),n=t.inventory.find(e=>String(e.productId)===s);if(!n)return console.log("物品不存在于库存中:",e,"库存物品IDs:",t.inventory.map(e=>e.productId)),{success:!1,message:"物品不存在"};if(n.quantity<r)return{success:!1,message:"数量不足"};const c=(null==(o=i.productPrices[s])?void 0:o.price)||0;if(c<=0){console.log("当前市场不收购此物品:",e,"价格:",c);const o=i.products.find(e=>String(e.id)===s);return o&&o.basePrice>0?(console.log("使用商品基本价格出售:",o.basePrice),function(e,i,r){const o=i*r,s=t.inventory.indexOf(e),n=e.purchasePrice,c=n*r,l=a.removeFromInventory(s,r);if(!l.success)return{success:!1,message:"出售失败："+l.message};const u=o-c;return t.money+=o,t.statistics.totalProfit+=u,t.statistics.transactionCount+=1,{success:!0,income:o,profit:u,profitPercent:c>0?(u/c*100).toFixed(1):0}}(n,o.basePrice,r)):{success:!1,message:"当前市场不收购此物品"}}const l=c*r,u=t.inventory.indexOf(n),d=n.purchasePrice*r,m=a.removeFromInventory(u,r);if(!m.success)return{success:!1,message:"出售失败："+m.message};const p=l-d;return t.money+=l,t.statistics.totalProfit+=p,t.statistics.transactionCount+=1,{success:!0,income:l,profit:p,profitPercent:d>0?(p/d*100).toFixed(1):0}},saveGame:function(e,t=!1){return s.saveGame(e,t)},loadGame:function(e){return s.loadGame(e)},getSaves:function(){return s.getSaves()},checkGameEnd:function(){e.checkGameEnd()},getCurrentProductPrice:function(e){var t;if(!e)return 0;const r=String(e),o=null==(t=i.productPrices[r])?void 0:t.price;if(null!=o)return o;const s=i.products.find(e=>String(e.id)===r);return s&&s.basePrice?s.basePrice:0},getProductPriceTrend:function(e){return i.getProductPriceTrend(e)},repayDebt:function(e){return e<=0||e>t.money?{success:!1,message:"无效的还款金额"}:(e>t.debt&&(e=t.debt),t.money-=e,t.debt-=e,{success:!0,amountRepaid:e})},buyHouse:function(r){const o=i.houses.find(e=>e.id===r);return o?t.money<o.price?{success:!1,message:"资金不足"}:t.purchasedHouses.some(e=>e.houseId===r)?{success:!1,message:"已拥有此房屋"}:(t.money-=o.price,t.purchasedHouses.push({houseId:o.id,name:o.name,purchasePrice:o.price,purchaseDate:(new Date).toISOString()}),e.checkGameEnd(),{success:!0}):{success:!1,message:"房屋不存在"}},addNotification:function(t,i){e.addNotification(t,i)}}});export{J as A,X as B,ee as C,ht as D,l as E,ve as P,n as _,c as a,Z as b,g as c,Lt as d,dt as e,ie as f,y as g,F as h,p as i,pt as j,te as k,mt as l,Le as m,Pt as n,Qe as o,Ee as p,ye as q,Y as r,wt as s,h as t,Q as u,_e as v,U as w,z as x,K as y,B as z};
//# sourceMappingURL=stores-6a84416e.js.map
